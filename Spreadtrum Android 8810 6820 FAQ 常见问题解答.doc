<html xmlns:o="urn:schemas-microsoft-com:office:office"
        xmlns:w="urn:schemas-microsoft-com:office:word"
        xmlns="http://www.w3.org/TR/REC-html40"><body><center><h1>Spreadtrum Android 8810_6820 FAQ 1207</h1><p><img src="http://www.bolearn.com/img/43bd8631d68bc52ccef953cc.gif" /><br /><br />
Spreadtrum Android 8810/6820 FAQ 常见问题解答<br /><br />
<br /><br />
Version: 1.1.0 DocCode: Date: 2012-07-18<br /><br />
<br /><br />
www.spreadtrum.com<br /><br />
<br /><br />
重要声明<br /><br />
版权声明<br /><br />
本文档中的任何内容受《中华人民共和国著作权法》的保护，版权所有 ? 2012, 展讯通信有限 公司，保留所有权利，但注明引用其他方的内容除外。<br /><br />
<br /><br />
商标声明<br /><br />
展讯通信有限公司和展讯通信有限公司的产品是展讯通信有限公司专有。在提及其他公司及其 产品时将使用各自公司所拥有的商标，这种使用的目的仅限于引用。<br /><br />
<br /><br />
不作保证声明<br /><br />
展讯通信有限公司不对此文档中的任何内容作任何明示或暗示的陈述或保证，而且不对特定目 的的适销性及适用性或者任何间接、特殊或连带的损失承担任何责任。<br /><br />
<br /><br />
保密声明<br /><br />
本文档（包括任何附件）包含的信息是保密信息。接收人了解其获得的本文档是保密的，除用 于规定的目的外不得用于任何目的，也不得将本文档泄露给任何第三方。<br /><br />
<br /><br />
Spreadtrum Android 8810/6820 FAQ ........................................................................................................... i 第 1 章 环境和编译 ....................................................................................................................................... 1 1.1 环境配置基本要求............................................................................................................................. 1 1.2 合适的 gcc 版本要求 ......................................................................................................................... 1 1.3 合适的 java 版本要求 ........................................................................................................................ 1 1.4 合适的 make 版本要求 ...................................................................................................................... 1 1.5 如何编译 3rdparty 下的 ko ................................................................................................................ 2 1.6 如何编译 app 模块并调试 ................................................................................................................. 2 1.7 如何生效 init.3rdparty.rc 修改 ........................................................................................................... 2 1.8 编译不成功......................................................................................................................................... 2 1.9 编译 wifi 器件注意点 ........................................................................................................................ 3 1.10 怎样使 APK 带有 ODEX 文件........................................................................................................ 3 1.11 Ubuntu 下使用 Windows 软件 .......................................................................................................... 3 1.12 Kernel 和 Uboot 文件夹名称 ............................................................................................................ 4 第 2 章 调试和工具 ....................................................................................................................................... 5 2.1 Log 体系 .............................................................................................................................................. 5 2.2 Log 输出 .............................................................................................................................................. 5 2.3 如何抓取 Android log ........................................................................................................................ 6 2.4 如何抓取 Modem arm log .................................................................................................................. 6 2.5 如何抓取 Mocor dsp log .................................................................................................................... 6 2.6 如何抓取 CAP 包 ............................................................................................................................... 6 2.7 如何抓取 Dsplog 中 IQ 信息 ............................................................................................................. 7 2.8 如何用脚本一次性抓取大量 LOG.................................................................................................... 7 2.9 如何看 LOG 同时存 LOG ................................................................................................................. 8 2.10 如何在 T 卡上保存 modem log ....................................................................................................... 8 2.11 如何在 T 卡上保存 AP log .............................................................................................................. 8 2.12 如何用 uart1 调试 kernel ................................................................................................................. 8 2.13 如何使用暗码................................................................................................................................... 8 2.14 一直找不到 adb devices ................................................................................................................... 9<br /><br />
<br /><br />
2.15 下载 DSP 和 NV 的选择................................................................................................................. 9 2.16 如何解决下载失败问题................................................................................................................... 9 2.17 冻屏定屏后抓取信息..................................................................................................................... 10 第 3 章 驱动 ................................................................................................................................................. 11 3.1 UBOOT.............................................................................................................................................. 11 3.1.1 如何配置按键进入不同的模式............................................................................................. 11 3.1.2 如何配置 RAM Size ............................................................................................................... 11 3.1.3 如何配置 Nand 分区 .............................................................................................................. 12 3.2 LCD ................................................................................................................................................... 12 3.2.1 如何添加新 Lcd 驱动 ............................................................................................................ 12 3.2.2 开机屏幕闪一下或白屏......................................................................................................... 12 3.2.3 显示开机 LOG 后画面固定 .................................................................................................. 13 3.2.4 8 位屏需要修改的地方........................................................................................................... 13 3.2.5 模组 180 度贴反如何消除切纹............................................................................................. 13 3.2.6 屏幕不自动熄灭..................................................................................................................... 13 3.2.7 屏幕概率性点不亮................................................................................................................. 14 3.3 LCD backlight .................................................................................................................................... 14 3.3.1 背光设计与样机不同............................................................................................................. 14 3.3.2 如何调整 PWM 背光的频率 ................................................................................................. 14 3.3.3 按键背光异常......................................................................................................................... 15 3.3.4 显示开机 Log 时屏闪一下 .................................................................................................... 15 3.3.5 充电界面亮屏时间短............................................................................................................. 15 3.3.6 唤醒的时候概率白屏问题..................................................................................................... 16 3.4 Camera ............................................................................................................................................... 17 3.4.1 如何添加新 Camera 驱动 ...................................................................................................... 17 3.4.2 调试注意点............................................................................................................................. 18 3.4.3 LDO 相关信息 ........................................................................................................................ 18 3.4.4 支持的数据格式..................................................................................................................... 18 3.4.5 支持的频率帧率..................................................................................................................... 18 3.4.6 JPEG 格式 size 要求 ............................................................................................................... 19 3.4.7 自动对焦对不上..................................................................................................................... 19<br /><br />
i i i<br /><br />
<br /><br />
3.4.8 模组方向说明......................................................................................................................... 19 3.4.9 拍摄界面水波纹..................................................................................................................... 20 3.5 Gsensor/MSensor ............................................................................................................................... 20 3.5.1 如何添加 G/M/L/P-sensor 驱动 ............................................................................................. 20 3.5.2 layout 调整............................................................................................................................... 20 3.5.3 水平校准不可用..................................................................................................................... 21 3.5.4 某平衡类的游戏不能正常运行 ............................................................................................. 21 3.6 L/P Sensor .......................................................................................................................................... 21 3.6.1 手机水平放置通话贴近不灭屏 ............................................................................................. 21 3.6.2 如何测试光敏传感器............................................................................................................. 22 3.7 Audio .................................................................................................................................................. 22 3.7.1 内置 PA 与外置 PA ................................................................................................................ 22 3.7.2 如何使用外部 PA ................................................................................................................... 22 3.7.3 耳机检测使用 GPIO .............................................................................................................. 23 3.7.4 二合一 PA 如何修改 NV ....................................................................................................... 24 3.7.5 耳机驱动代码在哪里............................................................................................................. 24 3.7.6 如何设置系统默认音量......................................................................................................... 24 3.7.7 如何调节音量档位................................................................................................................. 25 3.7.8 耳机不能接听和挂断电话..................................................................................................... 25 3.8 DDR ................................................................................................................................................... 26 3.8.1 如何降频确定 RAM 运行不稳定.......................................................................................... 26 3.8.2 如何排除其他不稳定因素..................................................................................................... 26 3.9 TP ....................................................................................................................................................... 27 3.9.1 如何添加 TP 驱动 .................................................................................................................. 27 3.9.2 使用电阻屏............................................................................................................................. 27 3.9.3 如何配置虚拟按键................................................................................................................. 28 3.10 WIFI/BT........................................................................................................................................... 29 3.10.1 如何编译配置....................................................................................................................... 29 3.10.2 WIFI FIRMWARE 放哪里 .................................................................................................... 29 3.10.3 Wifi 连接 AP 后电流偏大 .................................................................................................... 29 3.10.4 linux 命令行测试 WIFI 的方法 ............................................................................................ 30<br /><br />
<br /><br />
3.10.5 CSR WIFI 问题分析需要的 LOG ........................................................................................ 30 3.10.6 如何修改蓝牙的默认设备名称 ........................................................................................... 31 3.11 Charge .............................................................................................................................................. 32 3.11.1 电池电量百分比校准 ........................................................................................................... 32 3.11.2 如何配置充电过电保护电压 ............................................................................................... 32 3.12 Keypad ............................................................................................................................................. 32 3.12.1 如何配置 keypad .................................................................................................................. 32 3.12.2 如何添加没有定义的键值................................................................................................... 33 3.12.3 如何设置按键背光............................................................................................................... 33 3.13 RTC .................................................................................................................................................. 34 3.13.1 如何修改系统默认时间....................................................................................................... 34 3.13.2 关机闹钟不闹的问题........................................................................................................... 34 3.14 FM .................................................................................................................................................... 35 3.14.1 如何配置 FM ........................................................................................................................ 35 3.14.2 添加 FM 驱动后概率性开机问题 ....................................................................................... 35 3.14.3 收听 FM 屏灭后电流大 ....................................................................................................... 35 3.15 System .............................................................................................................................................. 36 3.15.1 如何将多个文件编译成一个 ko 文件 ................................................................................. 36 3.15.2 如何在线读取写入寄存器值 ............................................................................................... 36 3.15.3 Input 设备的常用调试方法 .................................................................................................. 36 3.15.4 开关机电压在哪里配置....................................................................................................... 37 3.15.5 Sleep 时 LDO 意外关闭........................................................................................................ 37 3.15.6 SIM 卡槽 1 和 2 反了............................................................................................................ 38 3.15.7 如何设置版本号................................................................................................................... 38 3.15.8 如何使某 GPIO 能唤醒系统 ............................................................................................... 38 3.16 Engineering Mode ............................................................................................................................ 38 3.16.1 如何修改测试模式的按键................................................................................................... 38 3.16.2 如何修改测试模式的音频通路........................................................................................... 39 3.17 OTA.................................................................................................................................................. 40 3.17.1 如何进行 OTA 升级 ............................................................................................................. 40 第 4 章 Framework &amp; APP ........................................................................................................................ 42<br /><br />
v<br /><br />
<br /><br />
4.1 通话 通信录 短彩信......................................................................................................................... 42 4.1.1 如何获取短信中心号码......................................................................................................... 42 4.1.2 如何获取本机 SIM 卡的电话号码........................................................................................ 42 4.1.3 无接近传感器，如何在开始通话后关闭屏幕 ..................................................................... 43 4.1.4 ms，mms，contact 容量限制 ................................................................................................. 43 4.1.5 是否需要自动重拨设置功能................................................................................................. 43 4.2 数据连接 .......................................................................................................................................... 44 4.2.1 默认关闭“已启用数据”方法 ................................................................................................. 44 4.2.2 双卡版本设置数据业务默认关闭 ......................................................................................... 44 4.2.3 数据漫游功能的默认值如何修改 ......................................................................................... 45 4.2.4 T G 版本，TD Only/GSM Only 的设置无效......................................................................... 45 4.3 WIFI/BT............................................................................................................................................. 45 4.3.1 WIFI 图标在状态栏和设置中显示不一致 ............................................................................ 45 4.3.2 过认证如何隐藏所有 wifi 设置选项 .................................................................................... 45 4.4 CAMERA .......................................................................................................................................... 47 4.4.1 单摄像头进入时间较长如何解决 ......................................................................................... 47 4.4.2 在搜索框中进入相机耗时..................................................................................................... 47 4.4.3 如何调用系统闪光灯接口..................................................................................................... 49 4.5 多媒体 .............................................................................................................................................. 49 4.5.1 目前支持的音视频文件格式................................................................................................. 49 4.5.2 MBBMS 的 UA 设置长度限制问题 ...................................................................................... 50 4.6 工程模式 .......................................................................................................................................... 50 4.6.1 如何调整工程模式 MIC 音量 ............................................................................................... 50 4.6.2 关闭呼叫转移查询和 PDP 的方法 ....................................................................................... 51 4.7 客户化问题....................................................................................................................................... 51 4.7.1 平台提供 PC 上网功能.......................................................................................................... 51 4.7.2 SD 卡的音频文件设置为来电或短信铃声............................................................................ 51 4.7.3 平台是否提供 PC 同步工具 .................................................................................................. 52 4.7.4 如何使用 T 卡 OTA 升级 ...................................................................................................... 52 4.7.5 客户 UA 写法是否正确 ......................................................................................................... 52 4.7.6 修改系统只有中英文语言选项............................................................................................. 53<br /><br />
<br /><br />
4.7.7 客户如何更换开关机图片/动画/铃音................................................................................... 53 4.7.8 背光亮度，静音等默认值如何修改 ..................................................................................... 55 4.7.9 浏览器如何修改内置的“搜索引擎” ..................................................................................... 55 4.7.10 添加预制 apk 应用 ............................................................................................................... 55 4.7.11 第三方应用和 so 文件集成到系统中 ................................................................................. 55 4.7.12 关机充电动画修改............................................................................................................... 56 4.7.13 关闭灭屏特效的方法........................................................................................................... 56 4.7.14 如何调整低电报警电压....................................................................................................... 56 4.7.15 如何设置默认动态壁纸....................................................................................................... 57 4.7.16 如何设置系统默认壁纸....................................................................................................... 57 4.7.17 为什么某些 APK 内置无法使用 ......................................................................................... 57 4.7.18 关机菜单中如何添加重启选项 ........................................................................................... 57 4.7.19 如何修改系统默认输入法................................................................................................... 59 4.7.20 如何在桌面预置应用程序图标 ........................................................................................... 59 4.7.21 如何修改信号强度图标....................................................................................................... 61 4.7.22 如何更改系统默认语言....................................................................................................... 61 4.7.23 如何通过拨号盘暗码启动程序 ........................................................................................... 61 4.7.24 客户自己添加的 property 设置失败问题 ........................................................................... 62 4.7.25 添加搜索引擎....................................................................................................................... 63 4.7.26 修改 idle 界面搜索引擎的链接地址 ................................................................................... 64 4.7.27 如何设置使用 Google 日历 ................................................................................................. 64 4.7.28 如何响应长按键................................................................................................................... 64 4.7.29 Wifi 中新增的一些接口引发的 anr 处理............................................................................. 65 4.8 入库问题 .......................................................................................................................................... 66 4.8.1 PIM 入库测试时，同步后字段不匹配.................................................................................. 66 4.8.2 宽带互联网入库测试 25.7 中年月显示问题 ........................................................................ 66 4.8.3 入库 UA 统一时设置注意点 ................................................................................................. 66 4.9 Android 开发经验 ............................................................................................................................. 67 4.9.1 sqlite 多条数据操作如何提交效率 ........................................................................................ 67 4.9.2 Android Layout_weight 的使用心得 ...................................................................................... 69 4.9.3 Android 双缓冲机制................................................................................................................ 71<br /><br />
v i i<br /><br />
<br /><br />
4.9.4 ANR 分析方法 ........................................................................................................................ 73 4.9.5 PhoneServer 中的多线程操作 ................................................................................................ 83 4.9.6 android 的 SAFE MODE ........................................................................................................ 85 第 5 章 送测修改 ......................................................................................................................................... 87 5.1 如何修改 DM 信息？ ...................................................................................................................... 87 5.2 DM 入库 case3.4 关于 pim 参数的采集问题 .................................................................................. 87 5.3 关于默认 DM 地址的问题，我们版本目前是否是实验室地址？............................................... 87 5.4 如何修改 web User-Agent？ ........................................................................................................... 87 5.5 如何修改客户服务信息？............................................................................................................... 87 5.6 8810 MBBMS 入库送测版本注意事项？ ....................................................................................... 88 5.7 8810 WLAN 测试注意事项 .............................................................................................................. 89 5.8 8810 CSR WIFI 测试事项 ................................................................................................................ 89 5.9 测试某些卡时不能上网................................................................................................................... 90 5.10 什么是 CTS? .................................................................................................................................. 90 5.11 如何进行 android cts 测试? .......................................................................................................... 90 5.12 CTS 测试事项 ................................................................................................................................. 92 5.13 Monkey 测试事项 ........................................................................................................................... 93 5.14 8810 开机进入工厂模式，进行各外设测试，包括 LCD/TP/key，蓝牙等测试........................ 94 5.15 MTBF 测试 ...................................................................................................................................... 94 5.16 SC8810 如何修改彩信 UA 和 UA Profile？ .................................................................................. 94 5.17 cts 去除 gps 功能............................................................................................................................ 94 5.18 8810 DM 送入库时客户常遇到的问题 ......................................................................................... 95 第 6 章 Linux 常用命令速查...................................................................................................................... 97 6.1 启动、关机、登入、登出相关命令 ............................................................................................... 97 6.2 shell 相关命令 ................................................................................................................................... 97 6.3 用户相关命令................................................................................................................................... 98 6.4 系统消息相关命令........................................................................................................................... 98 6.5 文件操作相关命令........................................................................................................................... 99 6.6 文件编辑相关命令........................................................................................................................... 99 6.7 压缩、解压缩相关命令................................................................................................................. 100 6.8 MS-DOS 工具集[mtools]相关命令 ................................................................................................ 100<br /><br />
<br /><br />
6.9 控制外部设备相关命令................................................................................................................. 101 6.10 进程及任务管理相关命令........................................................................................................... 101 6.11 网络管理相关命令 ....................................................................................................................... 102 6.12 其它命令....................................................................................................................................... 102 6.13 组合命令....................................................................................................................................... 103<br /><br />
<br /><br />
i x<br /><br />
<br /><br />
第1章 环境和编译<br /><br />
1.1 环境配置基本要求<br /><br />
工具 OS Gcc JDK Perl Python Make 版本 Ubuntu 10.4(lucid),10.10(maverick),11.04 (natty) 4.4.3, 4.4.5, 4.5.2 注意：4.6 版本不能编译 1.6.0 5.10.0 2.7.1 3.81 注意：JAVA5 不能编译<br /><br />
<br /><br />
在 Ubuntu 下正确编译源代码，需要合适版本的 gcc、make、java。IDH 发布包含基础包和可选 包，需要把可选包解压以后放在正确的位置。<br /><br />
<br /><br />
1.2 合适的 gcc 版本要求 Ubuntu 版本的不同，附带的 gcc 版本也会不同。高版本的 gcc 对代码要求较高，编译时可能会 出问题。目前代码在 4.4，4.5 下的 gcc 可以编译，但是在 gcc4.6 下编译不成功，需要安装低版 本的 gcc。 $ gcc -v gcc version 4.4.5 (Ubuntu/Linaro 4.4.4-14ubuntu5) 1.3 合适的 java 版本要求 查看 java 版本的命令是： $ java -version java version &quot;1.6.0_24&quot; Java(TM) SE Runtime Environment (build 1.6.0_24-b07) 1.4 合适的 make 版本要求 查看 make 的版本命令是： $ make Cv 或 $ make --version GNU Make 3.81 3.82 版本的 make 有个 bug 会阻止 Android 编译，需要安装 3.81 的 make。<br /><br />
<br /><br />
1.5 如何编译 3rdparty 下的 ko 非常重要的一点：以 tp 为例，必须确保 3rdparty/tp/pixcir/build.sh 的可执行权限。 $ cd idh.code $ ./mk sp6820a u ko 3rdparty/tp/pixcir/ 1.6 如何编译 app 模块并调试 使用./mk sp8810ga u adr xxx/xxx 编 android 的 module 将生成 apk 通过 adb push xxx.apk /system/app 常见问题有：只修改 packages 下 app 的 xml 或 res 文件，如何快速编译生效。 该方法也适用于其他 case 下 android 模块的编译和调试。 1.7 如何生效 init.3rdparty.rc 修改 [适用版本] 2.3.5 在 2.3.5 版本中，init.3rdparty.rc 在 ramdisk 中，所以不应该使用 adb push 修改，生效方法如下： ./mk sp8810ga pb ./mk sp8810ga u ramdisk 生成 root 文件夹及生成 ramdisk 文件 ./mk sp8810ga u k 编译 kernel 生成 boot.img 1.8 编译不成功 ・提示“Note: Some input files use or override a deprecated API.” 未使用 JAVA6。安装好，还需在~/.bashrc 文件最后添加三行修改环境变量： export JAVA_HOME=/usr/lib/jvm/java-6-sun export PATH=$JAVA_HOME/bin:$PATH export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar ・ 未生成 img， 提示“Clock skew detected. Your build may be incomplete”， 用如下命令来解决： $ cd kernel $ find . -type f | xargs -n 5 touch $ make clean $ make ・编译不成功，提示“/usr/bin/ld: cannot find -lncurses” 未安装 libncurses。安装命令： sudo apt-get install libncurses5-dev<br /><br />
2<br /><br />
<br /><br />
1.9 编译 wifi 器件注意点 Wifi器件在编译过程中定义一些预处理的宏，这些宏的更改需要对应的 cpp文件重新编译，但 是由于cpp文件本身没有更改，所以需要删除对应的obj来重新编译这些文件，详见 3.10.1。<br /><br />
<br /><br />
1.10 怎样使 APK 带有 ODEX 文件 [ 适用版本] MocorDroid2.3.5 将下面的设置写入 BoardConfig.mk： WITH_DEXPREOPT = true DISABLE_DEXPREOPT =<br /><br />
<br /><br />
1.11 Ubuntu 下使用 Windows 软件 安装虚拟机软件 VirtualBox。如 virtualbox-4.1_4.1.10-76795~Ubuntu~natty_i386.deb 及扩展包 Oracle_VM_VirtualBox_Extension_Pack-4.1.10-76795.vbox-extpack。 扩 展 包 安 装 方 法 ： 管 理 -&gt; 全 局 设 定 -&gt;Extensions-&gt;Add package 。 同 时 将 当 前 用 户 加 入 vboxuser 组。 基于虚拟机安装 WinXP 镜像系统并安装增强功能(设备-&gt;安装增强功能)，并设 置数据共享区用于不同系统间交换数据文件。 USB 端口镜像 设置---&gt;WinXP - 设置---&gt;USB---&gt;USB 设备筛选器，按如下图配置：<br /><br />
<br /><br />
在虚拟 WinXP 系统中安装相应驱动，如 SCI-android-usb-driver-jungo-v4。 经过上述安装配置后，可以在 WinXP 虚拟机下进行 SC6820/8810 软件下载和 Logel 等操作。<br /><br />
3<br /><br />
<br /><br />
1.12 Kernel 和 Uboot 文件夹名称 [适用平台和版本] 8810 2.3.5 /kernel /u-boot [适用平台和版本] 6820 2.2.2 /kernel_2.3.5 /u-boot_2.3.5 特别注意：该问题适用于第三章驱动全部的内容，如若出现了 kernel 文件夹，对于 2.2.2 版本请 客户自动转换为 kernel_2.3.5。<br /><br />
<br /><br />
4<br /><br />
<br /><br />
第2章 调试和工具<br /><br />
2.1 Log 体系 SC8810/6820 Log 包含 Android Log、Kernel Log、Uboot Log 和 Modem Log：<br /><br />
<br /><br />
Android Log： logcat log : Android 的 framework 以及 app 打印出来的 Log； radio log : RIL 的 Log，包含 framework 以及 rild 的 Log，分析 telephony 问题的主要 Log； anr trace : 应用程序发生 ANR 时，将 JAVA 的所有进程的 callback 保存到/data/anr/trace.txt； Kernel log : kernel 中 printk 打印出来的 Log； panic : 发生 kernel panic 之后保存的 kernel panic 的现场； Uboot Log: uboot 中 printf 打印出来的 Log； Modem Log 和 featrue phone 平台类似，包含 arm log 和 DSP Log，抓取工具和分析方法相同。 2.2 Log 输出 Reference phone 的尾插引出两个物理端口： USB UART1（至少 UART1 TX） Log 输出主要通过 usb，前提需要安装 usb 驱动： adb，usb2serail、diag/at，usb mass storage， 在 adb 未 ready 和 kernel 异常时，需利用 uart1 抓 log。 Android Log：adb（Android ADB Interface） Kernel Log：adb（Android ADB Interface）或者 UART1（usb2serail 或 comX） Uboot Log：UART1（usb2serail 或 comX） Modem ARM Log：com diag Modem DSP Log：UART1（usb2serail 或 comX） 默认情况下： UBoot Log 和 DSP Log 从 UART1 输出，需要 Uart 线或者安装 USB2Serial 驱动； Modem ARM log 通过 Diag Com 输出，需安装 USB2Serial 驱动； Android&amp;Kernel log 通过 ADB 输出，需安装 ADB Tool 及相关驱动。 若需同时获取三种 Log，需要使用展讯红盒子或类似装置。两根 USB 线连接 PC 和红盒子尾部 的两个 USB 口，SW 开关位置在 USB Serial 侧；一根 USB 线连接红盒子侧面 USB 口和手机尾 插。<br /><br />
5<br /><br />
<br /><br />
2.3 如何抓取 Android log Android&amp;Kernel log 通过 ADB 输出，使用如下命令： adb logcat Cv time adb logcat Cv time Cb radio adb logcat Cv time Cb event adb shell cat /proc/kmsg 来分别抓取 Android main log， radio log， event log 以及 kernel log。 2.4 如何抓取 Modem arm log 1. 正常情况下，和 mocor 平台的方式一样，使用 logel 软件； 2. 特殊情况下，使用 android 手机的 usb 绑定功能时，会禁止掉别的 usb 功能，请遵循步骤： a) 在执行 usb 绑定之前： sudo adb root adb shell vlog-sv &amp; b) c) 选择 usb 绑定; 配置 PC 端的 channel server，其中 type 选择为 winSocket， port 维持不变 （36667） , Endian 选为 self adaptive，其它维持原样； d) 配置 logel，type 选项为 channel server，其它不变。<br /><br />
<br /><br />
2.5 如何抓取 Mocor dsp log 和 mocor 平台的方式一样，使用 Dsplog 软件。连接口可以是 UART1 或者 USB。 NVitem-&gt;nv_type-&gt;NV_REF_PARAMETER-&gt;dsp_log_set=2 NVitem-&gt;nv_type-&gt;NV_REF_PARAMETER-&gt;dsp_log_set=1 USB 方式抓取 DSP log Uart 方式抓取 DSP log<br /><br />
<br /><br />
2.6 如何抓取 CAP 包 adb shell tcpdump adb shell tcpdump -i any -p -s 0 -w /sdcard/capture.pcap 把 CAP 包存在 T 卡目录上。adb pull 可以复制到 PC。 *#*#83782#*#* -&gt; PS related -&gt; Log Switch -&gt; CAP log<br /><br />
6<br /><br />
<br /><br />
开启。方法二：连接 modem arm log 工具进行操作，保存 log，用保存的 log 生成 cap 包。正常 情况不需要这种方法。<br /><br />
<br /><br />
2.7 如何抓取 Dsplog 中 IQ 信息 *#*#83784#*#* -&gt;IQ Mode 开启 IQ DATA 设置。 2.8 如何用脚本一次性抓取大量 LOG Windows下有两个脚本LogAndroid2PC.bat和StopLogging.bat。 能抓取的LOG包括logcat_main.log，logcat_radio.log，kmsg.log，/sdcard/capture.pcap， hcidump.log以及/sdcard/logs4android/，/data/anr/，/data/tombstones，/data/watchdog， /data/crush，/sdcard/capture.pcap，gsnap snapshot.png /dev/graphics/fb0， /data/dontpanic/apanic_console，/data/dontpanic/apanic_threads，/proc/last_kmsg，bugreport.log等 各种信息，这对分析某些疑难杂症提供了尽量多的信息。 共有两种方法 ： 测试过程连接PC：请在测试前双击LogAndroid2PC，测试完成/出现问题后双击StopLogging。 测试过程不连接PC：请在测试完成/出现问题后，先用USB线将测试机连到PC，再双击 StopLogging。 注意： 1，请将两个脚本放在同一目录下 ； 2，获取的 log 会自动保存在脚本所在目录下新建的以 androidlog_&lt;当前时间&gt;命名的目录中 （如 androidlog_20110922112211） ； 3，如执行 StopLogging 时提示测试设备无法连接，请按照屏幕提示完成后续操作； 4，如果采用&quot;测试过程不连接 PC&quot;的方式获取 log，请确保先插入 USB 线再执行 StopLogging 脚 本，否则脚本可能识别为设备已无法连接； 5，采用&quot;测试过程连接 PC&quot;方式后，如要改用&quot;测试过程不连接 PC&quot;方式测试，需重启手机或手 动重新启动 logs4android 服务； 6，如需做蓝牙相关测试，请先使能蓝牙设备，再启动 LogAndroid2PC.bat （否则 hcidump.log 中 不会有有效信息） ；<br /><br />
<br /><br />
7<br /><br />
<br /><br />
2.9 如何看 LOG 同时存 LOG adb logcat -v time |tee log adb shell cat /proc/kmsg -v time |tee log windows cmd 窗口不支持 tee 命令。<br /><br />
<br /><br />
2.10 如何在 T 卡上保存 modem log a) 手机 USB 连接 PC b) Adb shell Cat /dev/vbpipe0 &gt; /sdcard/”Log 需要保顿的路径+文件名” &amp; 例如: Cat /dev/vbpipe0 &gt; /sdcard/logs4modem/log.0 &amp; c) 然后拔掉 USB 线即可实现 armlog 输出到 T 卡（关机失效） ； d) 打开的时候使用 logel 工具，选择-&gt;Server -&gt;IP Setting-&gt;Type 选择 Fail，将文件打开，回放。 2.11 如何在 T 卡上保存 AP log 不连接手机，有 T 卡存在的情况下，AP log 会自动保存在 T 卡根目录 Log4Android 中，不需要 特殊设置。<br /><br />
<br /><br />
2.12 如何用 uart1 调试 kernel 硬件连接 UART1，修改 NVitem?GSM_DownloadParam?log_switch_struct?DSP_log_switch: 1 代表出 DSPlog，0 代表出 kernel log。保存 NV 时，是否保存 DSP，选择不保存。 2.13 如何使用暗码<br /><br />
*#06#： #*4560#： 查询IMEI； DM调试菜单：调试模式，清除自注册标记，发送自注册短信，服务器切换，厂商等；<br /><br />
<br /><br />
*#*#4636#*#*： 手机相关信息：手机信息（主要是网络信息），电池信息，应用统计，Wifi信息； *#*#83780#*#*：与Wifi 测试相关, Wifi test, Wifi EUT Mode， Wifi CMCC test； *#*#83781#*#*：2/3G公共部分； *#*#83782#*#*：2G独有的内容； *#*#83783#*#*：3G独有的内容。<br /><br />
8<br /><br />
<br /><br />
2.14 一直找不到 adb devices 确认 0x1782 写入文件~/.android/adb_usb.ini，并重新开机。并尝试如下两条命令： sudo adb kill-server sudo adb devices 另外 sudo adb root 和 sudo adb remount 用于对某些目录进行写操作时提示只读使用，它可改变文 件只读属性为可读可写属性。<br /><br />
<br /><br />
2.15 下载 DSP 和 NV 的选择 [适用平台]8810 针对 Tranceiver 的不同，有 3200 型号和 3500 型号，8810 的 IMG 包里面包含了两套 NV 和 DSP，要根据硬件的实际选型下载对应的 BIN。 2.16 如何解决下载失败问题 使用 Factory/ResearchDownload 工具发生下载失败问题， 1．fdl 结束后发生失败 一般都是 nv 备份错误，可以取消 nv 备份再试 2．下载到某 img 中途发生超时错误 可以通过擦除整个 Flash 来尝试解决问题。具体步骤如下： 启动 ResearchDownload.exe，按 Setting 按钮进入 Download settings 界面； Flash Operation 页中勾选 Erase All Flash；Calibration 页取消全部 Backup NVItem 项； Main Page 页取消全部 FileID 项，仅保留 FDL1, FDL2； Start downloading 直至 ERASE_ALL 完成； 擦除 Flash 完毕后，取消 Erase All Flash 复选项，重新下载全部文件即可。<br /><br />
<br /><br />
9<br /><br />
<br /><br />
2.17 冻屏定屏后抓取信息 如果出现“冻屏”、“定屏”状况，请观察下列信息并加入问题描述，对分析很有帮助： 1.logcat是否还在继续出，抓取下来。 2.kernel log (/proc/kmsg) 是否还在继续出，抓取下来。 3.arm/dsp log是否还在继续出。 4.adb shell能否进入手机，观察data/anr/traces.txt文件时间是否和当前一致，抓取下来。 有时候会发现手机按任何键都没有反应，屏幕也不会刷新，通过usb连接到pc，pc也没有反 应，可能是kernel发生了panic，在这种情况下对于kernel log尽量使用Uart抓取。另外现在加入了 一个机制，可以将panic时的message存储到flash上，下次开机可以获取出来。方法： 发生panic后， 重新开机：(只有在reboot的情况下才会有这些文件) 1. adb pull /data/dontpanic/apanic_console 2. adb pull /data/dontpanic/apanic_threads 以上两个文件如果发生了panic，就会有log存储下来。 3. adb pull /proc/last_kmsg<br /><br />
<br /><br />
10<br /><br />
<br /><br />
第3章 驱动<br /><br />
3.1 UBOOT 3.1.1 如何配置按键进入不同的模式 进入模式代码如下: \board\spreadtrum\sp8810\sprd_kp.c unsigned int check_key_boot(unsigned char key) { if(KEY_MENU == key) return BOOT_CALIBRATE; else if(KEY_BACK == key) return BOOT_RECOVERY; else if(KEY_HOME == key) return BOOT_FASTBOOT; } UBOOT开机按键配置可以修改，按键阵列定义如下： \board\spreadtrum\sp8810\key_map.h static unsigned char board_key_map[]={ 0x01, KEY_HOME, 0x00, KEY_BACK, 0x10, KEY_MENU, }; 数字表示行列，比如 0x01 表示第 0 行第 1 列（行对应keyout，列对应keyin） BOOT_CALIBRATE： 进入工厂测试模式。 BOOT_RECOVERY： 进入 recovery 模式。 BOOT_FASTBOOT： 进入 fastboot 下载模式。<br /><br />
<br /><br />
3.1.2 如何配置 RAM Size RAM大小在u-boot中配置的，kernel从u-boot传入的参数来获得RAM信息， 在编译u-boot时。如 3rdparty\uboot\uboot\special\build.sh中定义了ANDROID_3RDPARTY_RAM_SIZE=512M ，则会 编译 512MB版本的u-boot。现在的版本 512MB和 256MB都编译生成，选择合适的即可。<br /><br />
<br /><br />
11<br /><br />
<br /><br />
3.1.3 如何配置 Nand 分区 修改uboot/include/configs/sp8810.h #define MTDPARTS_DEFAULT宏定义的nand分区， 数值是分区大小，后面括号是分区名称。 请修改以上配置，配置完后请编译uboot和fdl2。<br /><br />
<br /><br />
3.2 LCD 3.2.1 如何添加新 Lcd 驱动 1. 在 3rdparty\lcd下增加lcd驱动，驱动包含的文件可参考其它lcd驱动； 2. 修改文件customize\customer_cfg\sp8810ga\kernel\lcd\lcd_cfg.c,增加lcd配置； 3 . 确认函数 kernel/drivers/video/sc8810/ fb_main.c-&gt; lcdc_mcu_init 中 FMARK 设置与硬件设计一 致; /*FMARK mode*/ //reg_val |= (1&lt;&lt;1); //注释此行表示打开 FMARK,增加此行表示关闭 FMARK. 4. 修改customize/custom_cfg/sp6820a/res/system.prop; ro.sf.lcd_density = 240// 240:WVGA 160:HVGA 120:QVGA与WQVGA 注：遇到显示不正常的页面还需修改其布局文件。 5. UBOOT 也需要对 lcd 进行配置，步骤如下： A: 在 u-boot\board\spreadtrum\sp8810\下增加 lcd 驱动 B: 修改文件 u-boot\board\spreadtrum\sp8810\Makefile, 增加编译文件。 C: 修改文件 u-boot/drivers/video/sc8810_fb.c-&gt; lcd_panel,增加 lcd 配置。 D: 修改 u-boot/include/configs/sp8810.h,根据 lcd 分辨率确定需要的宏： //#define CONFIG_LCD_HVGA #define CONFIG_LCD_WVGA 3.2.2 开机屏幕闪一下或白屏 1. LCD 部分有 Uboot 和 kernel 两部分初始化流程， Uboot 初始化后获得的 ID 通过参数<br /><br />
lcd_id=IDxxx 传入 kernel 来，若 ID 能在 kernel 配置中找到，kernel 不再做 LCD 初始化,kernel 的驱动函数通过 drivers/video/sc8810/fb_main.c:__setup(&quot;lcd_id=&quot;, calibration_start)取 得 ID。若 Kernel 初始化时比较 Uboot 与 kernel 的 lcd 配置不一致，导致 kernel 沿用用 uboot 的<br /><br />
<br /><br />
1 1<br /><br />
<br /><br />
配 置 失 败 ， 重 新 初 始 化 。 需 确 认 customize/custom_cfg/proj_name/kernel/lcd/lcd_cfg.c 与<br /><br />
12<br /><br />
<br /><br />
u-boot/drivers/video/sc8810_fb.c 中的配置一致； 2. Uboot 中读 ID 失败或者 ID 保存不正确，导致 kernel 重新进行自适应, 需要确认读 ID 的方法 是否正确； 3. 白屏另一个主要的原因可能是原厂驱动的 init 序列或者 timing 不正确，请和原厂确认。 注：以上的基础是首先确认硬件的连接和波形是正确的。 4. 还有一个具体问题可参例 3.3.4 章。<br /><br />
<br /><br />
3.2.3 显示开机 LOG 后画面固定 可能原因：FMARK 配置不正确，LCD 没有 FMARK 或者硬件未连接，软件打开了 FMARK。 3.2.4 8 位屏需要修改的地方 有些 8 位屏在寄存器操作上是 16 位的，导致将 lcdc 配置成 8 位后发送 command 失败，导致白 屏现象，如果发生这种情况，建议在驱动 init、setwindow、entersleep 等需要发送 command 的 函数中进行如下代码添加：<br /><br />
reg_val = _raw_readl(LCM_CTRL); _raw_writel(reg_val | (2 &lt;&lt; 1), LCM_CTRL);//设置成 16 位 //发送 command _raw_writel(reg_val , LCM_CTRL);//恢复为 8 位<br /><br />
<br /><br />
3.2.5 模组 180 度贴反如何消除切纹 当模组 180 度贴反时，即使有 Fmark，但根据其原理，横切纹也一定会存在，有效的解决方法 不是讲原数据进行 rotation，而是将 LCD 从 GRAM 取数的方向和 LCD 自刷新的方向两者都同 时旋转 180 度。这样的话，Fmark 的机制会起效。 3.2.6 屏幕不自动熄灭 [具体问题] 示例供参考 步骤：开机后，触摸解锁进入待机界面，等待若干分钟(大于设置的锁屏时间)。 现象：屏幕不会自动熄灭。 分析：从 android system log 可以看到系统不停地收到未定义的重复按键，这是导致屏幕不能 自动熄灭的直接原因；但这未定义的重复按键又是怎么来的呢？根据在 linux input 驱动代码中 加入一些 trace，发现底层有报扫描码为 259 的未定义按键事件，目前会产生按键事件的模块通 常只有 keypad 和 TP，于是在 TP 驱动代码中有使用手势 feature(该功能通常在 feature phone 中<br /><br />
13<br /><br />
<br /><br />
用到)，并在初始化中上报了扫描码为 259 的虚拟按键。 解决办法：关闭 TP 驱动的手势功能。 3.2.7 屏幕概率性点不亮 [具体问题] 示例供参考 现象：灭屏后一段时间，按 power key，无法点亮屏幕。 分析：从 Log 中发现，TP 中断处理函数中读写 i2c，但不断出现 i2c timeout 错误，结合代码分 析，中断处理没有采用下半部分处理机制，工作都在中断处理函数中执行， i2c 通信存在睡 眠的机制来等待一次 i2c 通信的完成。当出现 TP 异常情况，就会出现 i2c 通信 timeout，结果 在中断处理中睡眠了，这是不允许的；所以这个 case 中无法点亮屏幕的原因是：在系统准备 睡眠的过程中，来 TP 中断，打断线程，在 I2C 通信时又出现 i2c timeout，导致 TP 中断处理函 数所依附的线程被 sleep ，而在系统执行挂起的过程中，有一段期间是会屏蔽所有中断事件 的，所以也无法产生按键事件，按 power 键也就不能点亮屏幕了，直到中断处理函数执行完， 大概 4～5 分钟后会自动从睡眠线程中退出，屏幕又可以点亮了。 解决办法：Suspend 中正确屏蔽 TP 中断，并且 TP 中断处理采用上下半部分处理机制，建一线 程来处理 I2C 通信和数据上报工作。<br /><br />
<br /><br />
3.3 LCD backlight 3.3.1 背光设计与样机不同 1. 根据硬件设计确定 Lcd Backlight 采用的接口，包括 PWM, LED, GPIO； 2. 修改文件\kernel\drivers\leds\ leds-sc8810-lcd.c，根据实际使用接口修改以下３个； 函数：sprd_led_enable，sprd_led_disable，LCD_SetBackLightBrightness； 3. u-boot中打开背光的代码位于drivers/video/sc8810_fb.c文件的set_backlight函数； 3.3.2 如何调整 PWM 背光的频率 PWM 背光的输出频率过高或者过低都会使得感受不好，如果需要调整 pwm 的输出频率，需要 修改 kernel/driver/leds/led-sc8810-lcd.c 文件中的宏 LCD_PWM_PRESCALE_VALUE 是 pwm 模 块 的 分 频 ， 可 选 0-255 ， 默 认 是 1 ， 增 大 该 值 输 出 频 率 会 对 应 下 降 ; 如 果 LCD_PWM_PRESCALE_VALUE 设为 0 后仍需提高频率，需要将 LCD_PWM_MOD_VALUE 改小，默认为 0xff ，但是修改这个宏后，对应的 lcd 亮度值的计算方法需要改变，例如 LCD_PWM_MOD_VALUE 改为 0x7f，则需要在 LCD_SetBackLightBrightness 函数入口处加一 行 Value = value&gt;&gt;1。<br /><br />
14<br /><br />
<br /><br />
3.3.3 按键背光异常 [具体问题] 示例供参考 现象：若按键灯亮则手动灭屏后，按键灯不灭；若按键灯不亮则手动唤醒屏幕后按键灯不亮。 分析：修改驱动，增加 EARLYSUSPEND 相关部分， 修改 led-&gt;cdev.name = “keyboard-backlight”为&quot;button-backlight&quot; 3.3.4 显示开机 Log 时屏闪一下 [具体问题] 示例供参考<br /><br />
分析：LCD的差异，导致背光相对偏早 //u-boot_2.3.5\property\normal_mode.c void vlx_nand_boot(char * kernel_pname, char * cmdline, int backlight_set) { ...... lcd_display(); set_backlight(255); ...... } 为 void vlx_nand_boot(char * kernel_pname, char * cmdline, int backlight_set) { ...... lcd_display(); udelay(200000); set_backlight(255); ...... }<br /><br />
<br /><br />
3.3.5 充电界面亮屏时间短 [具体问题] 示例供参考 现象：关机状态下用充电器充电，按 power 键有时无法唤醒充电界面，且唤醒充电时充电界面显 示时间短，而用 USB 线插入电脑充电，此现象不明显 。 分析：修改 idh.code\external\sprd\charge\ui.c 文件下的 #define BACKLIGHT_ON_MS 6000 /*原为 3000*/<br /><br />
15<br /><br />
<br /><br />
注意编译方式 1. /mk sp6820a u adr external/sprd/charge（这是因为 charge 放在 ramdisk 下） 2 ./mk sp6820a u ramdisk 3 ./mk sp6820a u k 重新下载 boot.img 3.3.6 唤醒的时候概率白屏问题 目前版本已经通过 early_suspend/late_resume 的同步机制保证了 LCD Suspend/Resume 和 LCD Backlight Suspend/Resume 的时间先后顺序，但仍然存在概率性白屏的可能。 1：出睡眠的时候会先调用屏的 out entersleep，然后刷屏，然后开背光。 2：出睡眠的时候会先调用屏的 out entersleep，然后开背光，然后刷屏。 因为刷屏部分没有同步进开始提到的 late_resume 流程中，故 1 和 2 都是有可能出现的。 现有的 early_suspend 的机制只能确保 lcd resume 和 backlight resume 的顺序，所以根本的解决方 案是在确保顺序是：lcd resume-&gt; lcd invalid -&gt;lcd backlight resume。 但目前的代码架构和机制上对 保证 lcd invalid 与 lcd backlight resume 的先后不容易实现。但是可以规避一下，在 lcd resume 和 backlight resume 之间增加 LCD_Clear，这样即使出现 lcd backlight resume-&gt;lcd invalid 顺序， 屏上 看到的也是黑色的。 static void LCD_Clear (struct early_suspend* es, //lcd to operate. uint32_t color //color to fill the whole lcd. ) { uint32_t i; struct sc8810fb_info *info = container_of(es, struct sc8810fb_info, early_suspend); if(1) { info-&gt;panel-&gt;ops-&gt;lcd_invalidate(info-&gt;panel); for (i = 0; i &lt; info-&gt;panel-&gt;width * info-&gt;panel-&gt;height; i++) { info-&gt;ops-&gt;send_data(color); } } } static void sc8810fb_late_resume (struct early_suspend* es) { …… info-&gt;panel-&gt;ops-&gt;lcd_enter_sleep(info-&gt;panel,0); LCD_Clear(es,0x0); …… }<br /><br />
16<br /><br />
<br /><br />
3.4 Camera 3.4.1 如何添加新 Camera 驱动 Camera 驱动文件添加说明 以 ov5640 为例：在 3rdparty/camera2.3.5/路径下建立 ov5640 目录，在 ov5640 目录下建立 kernel 目录，在 kernel 目录下放置 route.mk 与 sensor_ov5640.c 3rdparty/camera2.3.5/ov5640/kernel/route.mk 3rdparty/camera2.3.5/ov5640/kernel/sensor_ov5640.c Camera 驱动配置文件添加说明 修改 customize/customer_cfg/$Project/kernel/camera/camera_cfg.c 以 sp6820a 项目添 ov5640 为例，修改 customize/customer_cfg/sp6820a/kernel/camera/camera_cfg.c 如以 ov5640 为后摄像头，在 main_sensor_infor_tab 中添加 ov5640 的数据 const SENSOR_INFO_T* main_sensor_infor_tab[]= { &amp;g_ov5640_yuv_info, &amp;g_OV2655_yuv_info, &amp;g_OV7675_yuv_info, &amp;g_OV2640_yuv_info, PNULL }; 项目 Makefile 添加说明 修改 customize/make/$Project.mak 以 sp6820a 项目添 ov5640 为例，修改 customize/make/sp6820a.mak 以冒号“:”为分隔，添加 ov5640 的选项 3RDPARTY_CAMERA2.3.5 = ov5640:ov2655:ov7675:ov2640:gc0309:nmi601 编译说明 Camera 驱动文件作为 kernel 的一部分，更新后只需要编译和下载 boot.img 在顶层目录执行命令行：./mk sp6820a u k<br /><br />
<br /><br />
17<br /><br />
<br /><br />
3.4.2 调试注意点 1.PCLK上的对地电容不用接，如果接的话对ov3660 和siv121d都会有影响； 2.如果有大量的干扰条纹可以尝试修改PCLK/HSYNC/VSYNC的极性，有两个需要修改的地方，一 个是sensor输出配置的寄存器，一个是在yuv_info中接收的地方，这两个要配置一致。注意 HSYNC方向是相反的； 3.硬件方面需要确认的问题：某sensor厂家确认滤波电容只需要给三个电源 （DVDD/AVDD/IOVDD）上加，其他引脚 （PCLK/HSYNC/VSYNC/8 跟数据线） 上都不需要这个电容， 但是不加这些电容可能会对射频有干扰，所以这点上需要平衡好关系。 4.POWERDOWN信号要正确，特别是前后两个摄像头，它们的PD信号有可能和参考方案相反。 3.4.3 LDO 相关信息 DVDD对应LDO_CAMD0,设置值必须是 1.8V 2.8V 1.5V或者 1.3V AVDD对应LDO_CAMD1,设置值必须是 2.8V 3.0V 2.5V或者 1.8V IOVDD对应LDO_CAMERA,设置值必须是 2.8V 3.8V 1.8V或者 1.2V 3.4.4 支持的数据格式 YUV接口和JPEG接口 像素 30W 130W 200W 300W 500W 800W YUV 支持 支持 支持 支持 不支持 不支持 JPEG 支持 支持 支持 支持 支持 不支持 RAW 不支持 不支持 不支持 不支持 不支持 不支持<br /><br />
<br /><br />
3.4.5 支持的频率帧率 像素 30W 30W 130W 200W 300W 500W Mode Preview Capture Capture Capture Capture Capture PCLK &lt;56M &lt;56M &lt;56M &lt;56M &lt;56M &lt;56M FPS 30 30 10 10 10 10<br /><br />
<br /><br />
18<br /><br />
<br /><br />
3.4.6 JPEG 格式 size 要求 Sensor 在输出 JPEG 格式数据的时候会有两种形式： 1.标准的 JPEG。 #输出的最大 size 大于 width× height/4 会概率性拍照死机 2.将 JPEG 尾部数据补齐。 #输出的最大 size 大于 width× height/4 必现拍照死机 在接收 JPEG 数据的时候申请的 buffer size 为 width× height/4，所以对 sensor 输出数据要求输出 的 buffer 不能超过 width× height/4，否则会引起 mem 覆盖。 3.4.7 自动对焦对不上 AutoFocus功能需要camera sensor模组支持，目前平台侧软件会提供对焦窗口的坐标给camera， 但电机控制与图像处理均由camera sensor来处理。 请 check 以下 2 点 1.请确认模组是否带有 AF 马达，马达是否工作正常。 2.确认 sensor IC 是否工作正常，自动对焦的寄存器读出来的值是否正常。 3.4.8 模组方向说明 要求宽高比 4：3 的 sensor，模组安装与屏幕的关系。应按平行原则安装。这个要求前后摄像头 均适用。 下图中，左边是竖着放的 LCD 屏，右边是 sensor 模组。在 LCD 图片里，红色是长边，绿色是 短边。右边的 sensor 模组，同样红色为长边，绿色为短边。需要 LCD 的长边平行于 Sensor 的 长边，LCD 的短边平行于 Sensor 的短边。(注：在 sensor 模组的 spec 图纸里，一般会有一个小 人作为 sensor 的方向的标志，请与模组供应商或 sensor 厂商联系确定小人站立方向与 sensor 长 短边的关系，下图是 4：3 的 sensor 模组典型小人站立方向)。<br /><br />
<br /><br />
19<br /><br />
<br /><br />
3.4.9 拍摄界面水波纹 [具体问题] 示例供参考 描述：拍摄取景界面，反复点击移动聚焦，屏幕上部分四分之一处有水波纹抖动。 分析： 1.查看现象，相机预览有切屏现象，初步判断不是 camera 的问题。 2.拿不同的 lcd，相同的 camera 测试，没有相同现象。 3.调整有问题 lcd 的时序，没有明显改善，只是切屏位置有变化。 4.测量 fmark 波形，宽度大概在 13ms,测量 lcd cs，宽度大概在 15ms,需要修改 lcd 的 fmark 宽度。 5.由客户找 lcd 厂家咨询修改方法。<br /><br />
<br /><br />
3.5 Gsensor/MSensor 3.5.1 如何添加 G/M/L/P-sensor 驱动 A: 在 3rdparty 的 gsensor, msensor, psensor, lsensor 下增加驱动，驱动包含的文件可参考其它 同类 sensor 驱动。注意保证 bulid.sh 文件的执行权限，并在 customize/make/的 mak 文件中将 3RDPARTY_GSENSOR 等项配置成所添加的驱动； B: 修改 customize\customer_cfg\sp6820a\kernel\i2c\ i2c_cfg.c，在相应的总线设备数组中增加 TP 设备，包括设备名称和设备地址，如果在当前驱动程序中已经有增加设备的代码，则不需要在 此增加设备； C: 修改驱动中的 init.3rdparty.rc 文件，将 insmod /system/lib/modules/lis3dh_acc.ko 中的路径改为 当前驱动安装后的路径名。 D: 后是 HAL 层修改 3rdparty\app\projapp\special\android\hardware\sprd\hsdroid\libsensors\ 下 对应的文件，2.2.2 与 2.3.5 版本的配置方法是不同的，具体请参看《如何写好sensorHAL》 。 3.5.2 layout 调整 g-sensor： 根据贴片的空间位置，可以分为 0~7 个方位。在调试最终的代码时，需要根据 layout 的位置适 当调整。解决方法是统一的： adb shell 后 getevent 后观察上报的坐标，一般是： eventx 0003 0000 xxxx eventx 0003 0001 xxxx eventx 0003 0002 xxxx 这样一组，0003 是 EV_ABS，0000 0001 0002 分别是 x y z；<br /><br />
20<br /><br />
<br /><br />
首先平放，lcd 朝上，x y 都接近 0，z 是一个 g，如果 z 是负数，说明 gsensor 芯片是反贴的， 请给 z 的数据转一下； 然后，手机竖起来，这时候 z 和 x 应该是接近 0， y 应该是一个 g，注意如果 y 接近 0，而 x 值比较大，说明 gsensor 是 90 度贴的，请把 x y 的值交换 ； 最后确认，手机竖时 y 位正，手机侧立右边朝下 x 为正，调一下 x y 的数据的符号； 以上所有的操作可以在驱动中修改，也可以在 HAL 修改。 m-sensor： 调整各个厂商是不同的，平台样机所选用的 akm8975 是通过 deamand 启动参数来配置的，在 \3rdparty\akm8975\special\init.3rdpatry.rc 中， service akmd /system/bin/akmd8975 -m 3 3.5.3 水平校准不可用 设置-&gt;显示-&gt;sensor水平校准必须有方向感应器才可用。 3.5.4 某平衡类的游戏不能正常运行 目前 Android 手机上和运动状态相关的 sensor 有四种： 加速度传感器(GSensor)--测三维加速度； 磁传感器(MSensor)--测三维磁场强度； 方向传感器(OSensor)--测三维角度； 陀螺仪(Gyroscope)--测三维角速度； 平衡类应用的 APK 会需要上述 Sensor 中 Gsensor 或者 Gsensor+OSensor 的数据，其中 Osensor 的数据是由 Msensor 为主导结合 Gsensor 的数据虚拟出来的 Sensor， 从平衡的本质看是 Gsensor 的本身属性，所以 Gsensor 是必不可少的，但是一些 APK 需要 Osensor 做一些更精细的处理。 所以当一些 APK 不能正常运行时可能是 APK 使用到了 Osensor 的数据。这种情况必须要要硬 件上贴有 Msensor。当然要注意一点：大部分的这类问题还是 Gsensor 本身数据没调对。 # -m 后面的数值 3 即为方向值。<br /><br />
<br /><br />
3.6 L/P Sensor 3.6.1 手机水平放置通话贴近不灭屏 这是Android的设计：打电话的时候，竖屏的时候，光传感器会起作用，灭屏以防脸部触碰到 屏幕，水平放置的时候，用手遮住光感应传感器，无法灭屏（没有必要灭屏），建议不要去修 改。实在需要修改，请参考PhoneApp.java的updateProximitySensorMode方法。<br /><br />
<br /><br />
21<br /><br />
<br /><br />
3.6.2 如何测试光敏传感器 设置-&gt;显示-&gt;亮度选择自动调整亮度,就可以测试光传感器。<br /><br />
<br /><br />
3.7 Audio 3.7.1 内置 PA 与外置 PA [适用平台和版本] 6820 2.2.2 有两个地方与控制PA相关： 1．默认的nvitem.bin用于内置PA方案， 修改方法：nv_type_4band.nvm 中，pa_gpio_num项，修改ITEM_CONTENT。 2．kernel/sound/soc/sc88xx/vbc-codec.c static inline void local_amplifier_init(void) { …… SPRD_BOARD_VERSION = system_rev &amp; 0xffff; if (SPRD_BOARD_VERSION == 0x100) { sprd_local_audio_pa_mode = 1; } else if (SPRD_BOARD_VERSION == 0x101) { sprd_local_audio_pa_mode = 0; speaker_gpio = 91; speaker_gpio_enabled_level = 1; if (gpio_request(speaker_gpio, &quot;speaker amplifier&quot;)) { printk(KERN_ERR &quot;speaker amplifier gpio request fail!\n&quot;); } } #else //8810 is controlled by audio_para // sprd_local_audio_pa_mode = 1; #endif …… } 其中 SPRD_BOARD_VERSION 区分内置/ 外置 PA ，当 SPRD_BOARD_VERSION == 0x100 时，表示使用的是内置PA方案；当SPRD_BOARD_VERSION == 0x101 时，表示使用的是外 置 PA 方 案 。 而 speaker_gpio 是 外 置 PA 的 控 制 gpio 。 为 了 做 到 自 适 应 ， 目 前 SPRD_BOARD_VERSION 是通过读硬件ADC值来获得，如果客户没有在板子上做内置 /外置 PA的区分，则需要手动修改这部分代码 3.7.2 如何使用外部 PA [适用平台和版本] 8810 2.3.5 1.修改customize\customer_cfg\sp8810ga\kernel\gpio\Gpio.cfg.c: 增加GPIO控制定义int sprd_3rdparty_gpio_pa_onoff; 增加数组gpio_func_cfg元素(需要增加的GPIO)<br /><br />
22<br /><br />
<br /><br />
{&amp;sprd_3rdparty_gpio_pa_onoff, 143 | GPIO_DEFAUT_LOW | GPIO_DIRECTION_OUTPUT | GPIO_LOGIC_TRUE}; 注意第二列数字要跟前面Pinmap_cfg中修改的GPIO名称一致。 增加EXPORT_SYMBOL_GPL描述 EXPORT_SYMBOL_GPL({&amp;sprd_3rdparty_gpio_pa_onoff)； 这样就可以在开机调用get_gpio_cfg将GPIO初始化为高或者低。 2. 修改kernal\sound\soc\sc88xx\vbc-codec.c 声明extern int sprd_3rdparty_gpio_pa_onoff； 修改函数local_amplifier_enable() (sprd_local_audio_pa_mode为判断是否使用内部pa) else分支增加gpio_set_value(sprd_3rdparty_gpio_pa_onoff, enable); 修改函数local_amplifier_enabled() else分支增加 if(gpio_get_value(sprd_3rdparty_gpio_pa_onoff)) return 1; else return 0; 3. 若修改后仍然不成功，则还需要修改audio parameter的文件来控制音频相关的参数.源 文件在 customize/customer_cfg/sp8810ga/res/hw_params/audio_para，最好用ultraedit打 开该文件，里面的内容其实就是我们nv中的audio_arm部分，对应四套audio模式，每套模式 大小为 2320，在每套模式的第 2280 位置表示外置PA还是内置PA，0 表示外置PA，1 表示内置 PA；第 2282 位置表示gain值大小，如果是外置PA，则不需要设置。通常情况下，是handsfree 与headfree模式下使用PA，因此只需设置 4600 位置为headfree模式下的PA控制选择，9240 位 置为handsfree 模式下的PA控制选择。 3.7.3 耳机检测使用 GPIO 耳机检测可以使用HEADMIC_IN的内部检测信号，也可以使用GPIO，驱动中修改方法： 3rdparty/headset/headset-soc/special/driver/headset.c [适用平台] 6820： 宏HEADSET_DETECT_USE_GPIO决定了耳机检测的实现方式，该宏定义默认为 0，表示使 用 EIC 检测；定义该宏 1 ，则使用 GPIO 检测，使用GPIO 检测时，还需要定义对应的 GPIO 号。 [适用平台] 8810： 宏HEADSET_WITH_EIC决定了耳机检测的实现方式，默认为使用EIC检测。定义此宏，表示 使用EIC检测；不定义表示使用GPIO检测，使用GPIO检测时，还需要定义对应的GPIO号。<br /><br />
<br /><br />
23<br /><br />
<br /><br />
3.7.4 二合一 PA 如何修改 NV PA 的 配 置 在 nv_type_4band.nvm 中 ， 修 改 方 式 是 用 NVEditor 打 开 nv ， 配 置 项 在 NV_type-&gt;NV_REF_PARAMETER 下： 1. pa_class_type: 功放类型 0x1: K 类功放， 0x0： 其他。值每两个 Bit 位一个通路，从低 bit 到高 bit 分别为 speaker, receiver,headphone_L, headphone_R。 2. pa_gpio_num: speaker 通路 GPIO 号。0xff 表示内部 PA，其他值表示外部 PA 使用的 GPIO 号。 3. pa_class_config: K 类功放时序，其中 Bit0～Bit3 表示电压值，Bit4～Bit7 表示周期。如果 speaker 通路使用的是 K 类功放，在 pa_class_type 中 bit0～1 表示，则需要配置此项。 4. pa_gpio_num_handhold: receiver 通路 GPIO 号。0xff 表示内部 PA，其他值表示外部 PA 使 用的 GPIO 号。 5. pa_class_config_handhold: K 类功放时序，其中 Bit0～Bit3 表示电压值，Bit4～Bit7 表示周 期。如果 receiver 通路使用的是 K 类功放，在 pa_class_type 中 bit2～3 表示，则需要配置此项。 3.7.5 耳机驱动代码在哪里 耳机驱动的代码在在 3rdpary/headset/headset-soc/special/driver/headset.c 中，一般需<br /><br />
要修改的情况是耳机上有增强型的 PA 器件。这时一般需要在耳机插入与拔出的中断处理中添加对 PA 的处理代码。<br /><br />
<br /><br />
3.7.6 如何设置系统默认音量 修改文件：frameworks/base/media/java/android/media/AudioManager.java /** @hide Default volume index values for audio streams */ public static final int[] DEFAULT_STREAM_VOLUME = new int[] { 4, // STREAM_VOICE_CALL 7, // STREAM_SYSTEM 4, // STREAM_RING 8, // STREAM_MUSIC 4, // STREAM_ALARM 4, // STREAM_NOTIFICATION 7, // STREAM_BLUETOOTH_SCO 7, // STREAM_SYSTEM_ENFORCED 11, // STREAM_DTMF 11, // STREAM_TTS 4, // STREAM_FM 4 // STREAM_MATV }; 此数组有定义音量默认大小，可根据实际修改。注意我们要修改的是 3rdparty 文件夹里面的同 名文件。<br /><br />
<br /><br />
24<br /><br />
<br /><br />
3.7.7 如何调节音量档位 [具体问题]示例供参考 问题： 客户反映要调整音量设置时每一档的音量大小，比如提出高几档变化太大，低的几档几乎都<br /><br />
没声音。 建议： 这个需要客户根据自己的情况来调整 index to volume 的算法。 具体做法如下： 相关实现的模块是 AudioPolicy。基类 AudioPolicyManagerBase 文件位于 framework/base/services/audioflinger/AudioPolicyManagerBase.cpp 实现类 AudioPolicyManagerALSA，位于 external/sprd/alsa/alsa_sound/AudioPolicyManagerALSA.cpp 函数 computeVolume： 这个方法平台目前没有用子类实现，所以走的是基类方法。如果客户需要修改，建议在子类中重载这 个方法。 再讲下基类方法： 1 通过 index 算出一个百分比； 2 通过这个百分比经过一个对数转换换成音量的百分比； 3 特殊情况的一些转换； 修改建议是子类的方法应该调用基类的方法并且做微调。 比如对 1，将 index 到百分比的对应关系略微修改（在本例中音量大的区域要微调低，而音量低的几 档可以调高）； 比如对 3，可以把基类方法处理的结果在根据需要调整。<br /><br />
<br /><br />
3.7.8 耳机不能接听和挂断电话<br /><br />
问题：耳机不能接听和挂断电话 分析：查看 log，正常速度按下耳机是没有产生中断，硬件 debounce 时间设置太长， 调整硬件 debounce 为 100ms,能产生中断，但被软件 debounce 过滤掉了， 根据耳机实际反映时间，将软件 debounce 时间减小到 100ms。 解决：修改文件 idh.code\3rdparty\headset\headset-soc\special\driver\headset.c #define HEADSET_BUTTON_DEBOUNCE_MS #define HEADSET_IRQ_BUTTON_SOFT_DITHERING_MS 100 //硬件 debounce 100 //软件 debounce<br /><br />
<br /><br />
25<br /><br />
<br /><br />
3.8 DDR 3.8.1 如何降频确定 RAM 运行不稳定 DDR的频率与时序配置在u-boot中 新版本: 只需要修改\arch\arm\cpu\armv7\sc8810\sdram_prod.c中的配置即可； 老版本: \arch\arm\cpu\armv7\sc8810\sdram.c void sc8810_emc_init() { ...... //set DPLL of EMC to 400MHz i = REG32(0x8b000040); i &amp;= ~ 0x7ff; //i |= 0x80; //512M //i |= 0x69; //420M //i |= 0x64; //400M i |= 0x50; //320M REG32(0x8b000040) = i; REG32(0x8b000018) &amp;= ~(1 &lt;&lt; 9); ...... } 3.8.2 如何排除其他不稳定因素 [具体问题] 示例供参考 问题：视频播放拖动或者长时间播放死机的问题。 分析：样机不出现。客户的光板比较容易复现，版本回退也出现；尝试去掉不必要的外设也出 现。初步排除了版本，LCD 等干扰和第三方的干扰。可能是 MEMORY 不稳定。降频有效，将 VDDARM 升到 1.25V 后，问题解决。 修改文件/u-boot2.3.5/arch/arm/cpu/armv7/sc8810/sdram.c 函数 PUBLIC void Chip_Init (void) { volatile uint32 i = 0; EMC_PARAM_T_PTR emc_ptr = EMC_GetPara(); //REG32(0x82000648) = 0x150a; // ARMCAL 0.03V REG32(0x82000648) = 0xf10; // ARMCAL 0.05V ..... } 重新编译 uboot，生成新的 u-boot-spl-16k.bin 文件替换掉。<br /><br />
26<br /><br />
<br /><br />
3.9 TP 3.9.1 如何添加 TP 驱动 TP的配置分为以下几步： A: 在 3rdparty\tp下增加TP驱动, 驱动包含的文件可参考其它TP驱动，并在customize/make/的 mak文件中将 3RDPARTY_TP一项配置成所添加的驱动; B: 修 改 驱动中 的 init.3rdparty.rc 文 件，将 insmod /system/sps/PIXCIR/ko/pixcir_i2c_ts.ko 中 的路径改为当前驱动安装后的路径名； C: 如果tp有额外的配置文件，需要修改build.sh，执行相应的处理，参见FT5206。 D: 修改customize\customer_cfg\sp6820a\kernel\i2c\ i2c_cfg.c，在相应的总线设备数组中增 加TP设备，包括设备名称和设备地址，如果在当前驱动程序中已经有增加设备的代码，则不需 要在此增加设备。 E: 在external/sprd/alarm/alarm.c中把check_input_dev(&quot;pixcir_ts&quot;);中“pixcir_ts”改 为新添加tp对应的设备名； F: 修改文件 3rdparty\app\app6820\special\android\external\sprd\engineeringmodel\engtest\sp6820a\ts.c 中的设备 定义#define SPRD_TS_INPUT_DEV，这是工程模式下的触摸测试程序。 注意： 1. 2. 3. 有些 TP 驱动(如 FT5206)通过 i2c_new_device()函数动态申请 i2c 设备，此时不需要在 对于不同分辨率的修改，请参考 PIXCIR 和 PIXCIR_hvga； 目前参考设计中 TP 接在 i2c-2 上，该路 i2c 从 SIM2 引出，可以调整其电压，调整方法 i2c_cfg.c 中添加配置项；<br /><br />
<br /><br />
如下： LDO_SetVoltLevel(LDO_LDO_SIM2, LDO_VOLT_LEVEL0); 其中：LDO_VOLT_LEVEL0 是 2.8V LDO_VOLT_LEVEL1 是 3.0V LDO_VOLT_LEVEL2 是 1.8V LDO_VOLT_LEVEL3 是 1.2V 3.9.2 使用电阻屏 因为代码使用了错误的 Kconfig 文件，导致在 config 文件里面配置电阻屏没有效果。参照如下 方法： 代码位置：驱动代码在 kernel/drivers/input/touchscreen/tp_sprd.c 1. kernel/drivers/input/touchscreen/Kconfig 文件中下面内容中的增加 depends on 为 depends on ARCH_SC8810<br /><br />
27<br /><br />
<br /><br />
config TOUCHSCREEN_SC8810 tristate &quot;SPRD SC8810 touchscreen driver&quot; depends on ARCH_SC8810 help 2. 3. 在 kernel/arch/configs/sc8810-sp8810-trusted-abs-android_defconfig 中添加 CONFIG_TOUCHSCREEN_SC8810=y 触摸屏校准 apk STEP1: customize/customer_cfg/XXX/res/BoardConfig.mk 中添加： TARGET_HAVE_TPCALIBRATION := true STEP2: customize/customer_cfg/XXX/res/sprd_apps.mk 中添加： PRODUCT_PACKAGES := \ …... TSCalibration 3.9.3 如何配置虚拟按键 可以参考TP/PIXCIR的驱动文件写法，通过 properties_kobj = kobject_create_and_add(&quot;board_properties&quot;, NULL); if (properties_kobj) ret = sysfs_create_group(properties_kobj, &amp;properties_attr_group); 这些代码建立一个属性组。 properties_attr_group是一个attribute_group结构 static struct kobj_attribute virtual_keys_attr = { .attr = { .name = &quot;virtualkeys.pixcir_ts&quot;, .mode = S_IRUGO, }, .show = &amp;virtual_keys_show, }; static struct attribute *properties_attrs[] = { &amp;virtual_keys_attr.attr, NULL }; static struct attribute_group properties_attr_group = { .attrs = properties_attrs, }; 注意&quot;virtualkeys.pixcir_ts&quot;的名字与TP的input设备的设备名是匹配的。 最后实现virtual_keys_show 函数 static ssize_t virtual_keys_show(struct kobject *kobj, struct kobj_attribute *attr, char *buf) {<br /><br />
28<br /><br />
<br /><br />
return sprintf(buf, __stringify(EV_KEY) &quot;:&quot; __stringify(PIXCIR_KEY_HOME) &quot;:30:859:100:55&quot; &quot;:&quot; __stringify(EV_KEY) &quot;:&quot; __stringify(PIXCIR_KEY_MENU) &quot;:201:859:100:55&quot; &quot;:&quot; __stringify(EV_KEY) &quot;:&quot; __stringify(PIXCIR_KEY_BACK) &quot;:320:859:100:55&quot; &quot;:&quot; __stringify(EV_KEY) &quot;:&quot; __stringify(PIXCIR_KEY_SEARCH) &quot;:460:859:100:55&quot; &quot;\n&quot;); } 注意 30:859:100:55 分别指的是案件中心点的坐标与宽高 另外在tp的驱动中check下是否有如下代码，如果没有请添加。 __set_bit(EV_KEY, __set_bit(KEY_MENU, __set_bit(KEY_BACK, __set_bit(KEY_HOME, __set_bit(KEY_SEARCH, input-&gt;evbit); input-&gt;keybit); input-&gt;keybit); input-&gt;keybit); input-&gt;keybit);<br /><br />
<br /><br />
3.10 WIFI/BT 3.10.1 如何编译配置 WIFI/BT 的配置分为以下几步： 1、解压 如“MocorDroid2.2.2_TS_SC6820_W12.09_IDH_ATHEROS_CSR_HISENSE.tgz” ，并将对 应厂家的 3rdparty 目录复制到主工程的 3rdparty 目录。 2 、 删 除 out/common/obj/JAVA_LIBRARIES 、 out/target/hsdroid/obj/SHARED_LIBRARIES 和 STATIC_LIBRARIES； 3、修改 sp6820a.mak 配置蓝牙/WIFI 型号后全编译 3.10.2 WIFI FIRMWARE 放哪里 fireware 文件存放在 3rdparty/wifi/UNIFI6030/special/synergy/modules/config/firmware/.. 在手机中保存在/etc/firmware/unifi-sdio/。 3.10.3 Wifi 连接 AP 后电流偏大 Wifi 连接 AP 后电流偏大，目前遇到的情况有：AIO[3]接法不同需要使用不同的 fireware。 如图：<br /><br />
<br /><br />
29<br /><br />
<br /><br />
以 TD 8810 平台为例，如何 AIO[3]外接 VBAT，则需要使用 fireware /3rdparty/wifi/UNIFI6030/special/synergy/modules/config/firmware/8810_HW_1.2.0_MIB_and_Pro file_Rev_1_MIB.dat 如果 AIO[3]没有接出，则需要使用 /3rdparty/wifi/UNIFI6030/special/synergy/modules/config/firmware/8810_HW_1.1.0_MIB_and_Pro file_Rev_1_MIB.dat 如果硬件设计与我们的参考设计相差较大，最好联系 CSR 工程师重新给出 fireware 文件。 3.10.4 linux 命令行测试 WIFI 的方法 使用adb shell进入手机 1、cd /sys/class/mmc_host/mmc1 下查看挂载的设备，mmc: 0001 表示挂载成功； 2、cd /system/sps/UNIFI6030/ko insmod unifi_sdio.ko，手动加载wifi模块； 3、iwconfig； 4、iwlist scan有log显示找到热点； 3.10.5 CSR WIFI 问题分析需要的 LOG 总共有以下几类 LOG<br /><br />
30<br /><br />
<br /><br />
logcat log kernel log with UNIFI driver log (可能需要改变 log level ) synergy_service log (可能需要改变 log level) wpa_supplicant log (可能需要改变 log level ) air sniffer log(需要提供 filter 或者设备的 MAC). 1：编译 unifi_sdio.ko ./mk sp8810ga u ko 3rdparty/wifi/UNIFI6030/ adb push 3rdparty/wifi/UNIFI6030/special/synergy/modules/wifi_softmac/host/ os_linux/driver/unifi_sdio.ko /system/sps/UNIFI6030/ko/unifi_sdio.ko 2：如何改变 UNIFI driver debug log level UNIFI driver的log有7级，可以根据需要修改。请注意过多的log会引起性能下降。 从adb运行“echo newLogLevel &gt;./sys/module/unifi_sdio/parameters/unifi_debug”，仅适用于Wi-Fi打 开的情况，或者修改UNIFI6030/special/synergy/modules/wifi_softmac/host/os_linux/driver/drv.c中的 unifi_debug，然后重新编译unifi_sdio.ko。 3：如何修改 wpa_supplicant debug log level wpa_supplicant 有5个级别的log输出，直接修改external/wpa_supplicant_6/wpa_supplicant/main.c中 的wpa_debug_level，然后编译新的wpa_supplicant，注意新编译出来的wpa_supplicant 没有WAPI 功能，因为WAPI的CSR源码没有release给Spreadtrum。 4：如何修改 synergy_service debug log level Synergy_service的log级别可以通过-q参数来控制: 0x0000 No log (Android 默认的是输出critial and error log) 0x0001 Critical Log 0x0002 Error Log 0x0004 Warning Log 0x0008 Info Log 0x0010 Debug Log 0xFFFF All 从adb杀死synergy_service。然后运行“synergy_service Cq logLevel”； 请确认杀死了所有的synergy_service进程：运行ps | grep synergy查看确认。 3.10.6 如何修改蓝牙的默认设备名称<br /><br />
蓝牙默认设备名称目前为“SPHS on Hsdroid”，如果需要修改为其他名称，请修改： sprdroid_base.mk 文件中 PRODUCT_MODEL 的定义即可。<br /><br />
31<br /><br />
<br /><br />
3.11 Charge 3.11.1 电池电量百分比校准 若手机界面的电池进度条显示不够准确，请根据实际测试值调整 idh.code\kernel\drivers\ power\charge.c 的中的 voltage_capacity_table 表格中的电压梯度值。 voltage_capacity_table 表格中 15%对应的是低电告警电压，而 0%是自动关机电压。 [具体问题] 现象：手机插 usb 充电，在手机界面和进度条已经显示 100%，拔掉 USB 线手机用不到 30 秒，电 池进度条显示少一格，电池电量和显示不同步； 解决：修改 idh.code\kernel\drivers\power\charge.c 的中的 voltage_capacity_table 表格中 的电压梯度值； [具体问题] 问题：Android 平台如何设置 voltage_warning 等相关的电压值的？我们试验下来改 NV 没用。 解决：idh.code\frameworks\base\core\res\res\values\config.xml， config_lowBatteryWarningLevel:15-----&gt;百分比，客户可以动态调整该数值来调整低电电压。 3.11.2 如何配置充电过电保护电压 过压保护电压的逻辑在： Kernel\drivers\power\sprd_power.c里 charge_handler()函数中有个battery_data-&gt;over_voltage用于电压保护逻辑。 这个数值的来源是Kernel\arch\arm\mach-sc8810\include\mach\chg_drvapi.h #define OVP_OVER_VOL 6500<br /><br />
<br /><br />
3.12 Keypad 3.12.1 如何配置 keypad Keypad 的配置分为以下几步： A: 修改 customize\customer_cfg\sp6820a\kernel\ pinmap \ pinmap_cfg.c 配置相关 pin； B: 修改 customize\customer_cfg\sp6820a\kernel\kpd\kpd_cfg.c,配置； 定义矩阵键盘行数，列数： #define CUSTOM_KEYPAD_ROWS #define CUSTOM_KEYPAD_COLS 3 3<br /><br />
32<br /><br />
<br /><br />
定义矩阵键盘键值： static const unsigned int sprd_keymap[] = { // 0 row KEYVAL(0, 0, KEYVAL(0, 1, // 1 row KEYVAL(1, 0, }; 定义 gpio 按键键值： /*note: now driver support max 3 gpio keys*/ static struct sprd_gpio_keys sprd_gpio_keymap[] = { {&amp;sprd_3rdparty_gpio_key0 ,ANDROID_KEY_POWER}, }; C: 修改 customize\customer_cfg\sp6820a\res\ sprd-keypad.kl,根据驱动和定义，配置 kl 文件； D: 修改 customize\customer_cfg\sp6820a\res\ init.sp6820a.rc,配置工程模式操作按键定义： setprop ro.recvkey.up setprop ro.recvkey.down setprop ro.recvkey.enter setprop ro.recvkey.home setprop ro.recvkey.power 3.12.2 如何添加没有定义的键值 1. 在 arch/arm/ch-sc8810/include/mach/sprd_key.h 中添加键值的宏； 2. 在 customize/custom_cfg/sp6820a/res/sprd-kl 中添加定义好的键值。详见文档 《MocorDroid 杂 项客户化配置指导》 。 3.12.3 如何设置按键背光 在 kernel/drivers/leds/leds-sc8810-kb.c 中， 把“keyboard-backlight”改为“button-backlight” ； 2. 在 external/sprd/charge/backlight.c 中把 #define KEY_BACKLIGHT_DEV &quot;/sys/class/leds/keyboard-backlight/brightness&quot; #define KEY_BACKLIGHT_MAX_DEV &quot;/sys/class/leds/keyboard-backlight/max_brightness&quot; 修改为： #define KEY_BACKLIGHT_DEV &quot;/sys/class/leds/button-backlight/brightness&quot; #define KEY_BACKLIGHT_MAX_DEV &quot;/sys/class/leds/button-backlight/max_brightness&quot; 1.<br /><br />
33<br /><br />
<br /><br />
ANDROID_KEY_VOLUME_DOWN), ANDROID_KEY_CAMERA), ANDROID_KEY_VOLUME_UP),<br /><br />
<br /><br />
115 114 116 212 116<br /><br />
<br /><br />
3.13 RTC 3.13.1 如何修改系统默认时间 首先修改\idh.code\kernel\drivers\rtc\ rtc-sprd.c static int __init sprd_rtc_init(void) { …… sec_2011_to_1970 = mktime(2011, 1, 1, 0, 0, 0); return 0; } mktime函数的参数即是修改点。 3.13.2 关机闹钟不闹的问题 [具体问题] 如果修改了默认开机时间，一定要同时修改 idh.code\packages\apps\DeskClock\src\com\android\deskclock\ Alarms.java private static void alarm_flag_setup(final long alarmTimeInMillis) { Calendar c = Calendar.getInstance(); c.set(2011, 0, 1, 0, 0, 0);//注意这里月份是 0 …… } 若还有不闹现象，根据客户平台启动时间的差异，需要调整 alarm_mode.c 中函数 int alarm_flag_check(void) { …… time_lead = get_alarm_lead_set(); if((time &lt; time_lead) &amp;&amp; (time &gt; time_lead -10)) ret = 1; else ret = 0; } 需要根据实际调整time_lead。<br /><br />
<br /><br />
34<br /><br />
<br /><br />
3.14 FM 3.14.1 如何配置 FM FM 的配置分为以下几步： A: 在 3rdparty\fm 下增加 FM 驱动, 驱动包含的文件可参考其它 FM 驱动。 B: 修改驱动中的 init.3rdparty.rc 文件， insmod /system/lib/modules/kt0812g_fm_ctrl.ko device /dev/KT0812G_FM 666 system audio 将上面的路径改为当前驱动安装后的路径名，将 KT0812G_FM 改为当前驱动的设备名称。 C: 修改 frameworks\base\core\java\android\hardware\fmradio\ FmTransceiver.java protected boolean acquire(String device){ boolean bStatus; if (sFd == -1) { sFd = FmReceiverJNI.acquireFdNative(&quot;/dev/KT0812G_FM&quot;); } …… } 将 KT0812G_FM 改为当前驱动的设备名称。 3.14.2 添加 FM 驱动后概率性开机问题 需要将 rc 脚本修改 on init insmod /system/lib/modules/qn8035_fm_ctrl.ko device /dev/KT0812G_FM 改为 on init device /dev/KT0812G_FM on boot insmod /system/lib/modules/qn8035_fm_ctrl.ko 3.14.3 收听 FM 屏灭后电流大 [具体问题] 问题：收听 FM 熄屏后电流偏大，电流偏大在 100mA 左右。参考标准在 58mA 以下。 分析：fm 后台播放由于 bb 在工作，同时有 trace 信息导致电流大。需要客户编译 user<br /><br />
35<br /><br />
<br /><br />
666<br /><br />
<br /><br />
system audio<br /><br />
<br /><br />
666<br /><br />
<br /><br />
system audio<br /><br />
<br /><br />
mode 来测试，关闭相关的调试信息。 解决：经过测量电流为 75mA 还是大于 58mA.平台的测试是在外部天线信号好的请况测试到 的 58mA。需要客户测试 fm 的天线的性能和接受信号。<br /><br />
<br /><br />
3.15 System 3.15.1 如何将多个文件编译成一个 ko 文件 TP 使用了几个.c 文件，让它生成一个 Ko 文件，请按如下示例修改： obj-m = goodix_tp.o goodix_tp-objs = gt816_818.o gt816_818_update.o goodix_tool.o 3.15.2 如何在线读取写入寄存器值 lookat 的用法： #sudo adb shell #lookat -h Usage: lookat [-l nword] [-s value] [-h] phy_addr_in_hex get/set the value of IO reg at phy_addr_in_hex -l nword -s value -h NOTE: * the phy_addr_in_hex should be 4-byte aligned in hex form * the value should be in hex form too * currently, there are two reg areas: 具体代码可以参看 lookat.c 3.15.3 Input 设备的常用调试方法 getevent/sendevent 都是在 adb 环境下使用的: === getevent === getevent 当前所有 inpu 设备上报事件（键盘，tp，传感器都是 input 设备） 运行 getevent 后的输出如 device 1: /dev/input/event0<br /><br />
36<br /><br />
<br /><br />
print values of nword continous regs start from phy_addr_in_hex in a formated way set a reg at phy_addr_in_hex to value print this message<br /><br />
<br /><br />
name: &quot;&quot;sprd-keys&quot;&quot; device 2: /dev/input/event1 name: &quot;&quot;lis3dh_acc&quot;&quot; /dev/input/event0: 0001 0074 00000001 /dev/input/event0: 0001 0074 00000000 Name 字符串与对应的驱动文件注册的 input 设备名是匹配的 0001 是 type, 0074 是 code, 而 00000001 是 value Event 的 type 以及每个 type 对应的 code 的含义可以通过查找 kernel\include\linux\input.h 获得 === sendevent === 命令格式 2：adb shell sendevent [device] [type] [code] [value] 发送时间,格式和上面的一样,需要注意的是在 get 中 code 显示的是十六进制,而 send 中需要用十 进制,例如: # sendevent /dev/input/event0 1 116 1 这个命令就是发送数字 4 的 keydown 消息 3.15.4 开关机电压在哪里配置 1 开机检测部分u-boot/include/configs/sp8810.h中的LOW_BAT_ADC_LEVEL； 2 关机电压部分kernel/drivers/power/charge.c中的voltage_capacity_table(注意 15%是告警， 0%就是关机了)。 修改注意事项 A 开机检测部分，由于目前在开机到动画阶段有个时间段功耗非常大，如果检测电压过低， 有可能到这个阶段开不起来导致反复重启 B 关机电压部分，如果过高，会让客户感受到的续航能力不足，而过低会导致强制关机后充 电不能立即开机（即关机电压已经比开机检测小很多） C 现在开机检测电压实际是对准告警电压而不是关机电压，因为在 15%的时候就有充电的告 警。 3.15.5 Sleep 时 LDO 意外关闭 SC8810/SC6820 支持 LDO 在进入 SLEEP 模式时自动关断，如果调试时怀疑 LDO 关断与此相 关可以检查文件： 6820: kernel_2.3.5/arch/arm/mach-sc8810/ldo.c<br /><br />
37<br /><br />
<br /><br />
8810: kernel/arch/arm/mach-sc8810/ldo.c static struct ldo_sleep_ctl_info slp_ldo_ctl_data[] = { …... {SLP_LDO_CAMA, {SLP_LDO_CAMD1, …... } 其中 SLP_LDO_CAMA 表示 LDO ID （具体是哪一路 LDO） ；ANA_LDO_SLP0 与 BIT_7 共同 表示该路 LDO 其 SLEEP 状态是由哪一个寄存器的哪一位来控制的。 1 表示寄存器的对应位 设置的值（一般 1 表示休眠状态下需要关断此路 LDO， 0 表示无需关断此路 LDO）。 3.15.6 SIM 卡槽 1 和 2 反了 请修改 nv， nv_type/NV_SIM_SLOT_CFG 的值从 0x00010203 到 0x01000203。 3.15.7 如何设置版本号 定义 android 版本号的地方在 build/tools/buildinfo.sh 内，可以修改此文件。 ro.build.display.id=$BUILD_DISPLAY_ID 改为 ro.build.display.id= $BUILD_D ISPLAY_ID_C USTOM, 然 后 在 customize/custom_cfg/proj_name/res/boardconfig.mk 下 定 义 宏 BUILD_DISPLAY_ID_CUSTOM 就可以为自己的项目定义版本号. 显示硬件版本在设置-&gt;关于手机-&gt;硬件版本里看到: packages/apps/Settings/res/xml/device_info_settings.xml &lt;Preference android:key=&quot;hardware_number&quot; style=&quot;?android:preferenceInformationStyle&quot; android:title=&quot;@string/hard_version&quot; android:summary=&quot;1.1.0&quot;/&gt; 3.15.8 如何使某 GPIO 能唤醒系统<br /><br />
需要修改的是 kernel/arch/arm/mach-sc8810/pm_vlx.c 的 sc8800g_set_wakeup_src 函数，在这里打开 gpio 控制器中断和对应的 gpio 中断，注意这个函数中不能使用标准的 irq_serenable 接口，只能直接写寄存器。<br /><br />
<br /><br />
ANA_LDO_SLP0, ANA_LDO_SLP0,<br /><br />
<br /><br />
BIT_7, BIT_6,<br /><br />
<br /><br />
1}, 1},<br /><br />
<br /><br />
3.16 Engineering Mode 3.16.1 如何修改测试模式的按键 1. 定义 kernel 上报的键值，此处 camera 键值为 212<br /><br />
38<br /><br />
<br /><br />
kernel/arch/arm/mach-sc8810/include/mach/sprd_key.h: #define ANDROID_KEY_CAMERA 212 2. 定义 camera 键对应硬件的行列号 Customize/customer_cfg/sp6820a/kernel/kpd/kpd_cfg.c 3. 定义上层应用使用的键值别名 customize/customer_cfg/sp6820a/res/sprd_keypad.kl 4. 上下层通过 prop 方式传递 customize/customer_cfg/sp6820a/res/init.sp682a.rc 其中定义键值 212 的 prop 为 ro.recvkey.home 212 5. 工程模式如何使用 5.1 external/sprd/engineeringmode/engtest/ui/sprd_engui.c 函数 sprd_ui_start() { ro.recvkey.up // 音量增加键 ro.recvkey.down//音量减小键 ro.recvkey.home //camera 键 ro.recvkey.enter //开机建 } 函数 device_handle_key() { 接收并处理键，转发给 engtest 程序 } 5.2 external/sprd/engineeringmode/engtest/sprd_engcommon.c 函数 eng_handle_softkey() { 调用 device_handle_key 得到 action 并处理 eng_handle_return(); //0 失败，1 成功 } 6. 如何进入测试模式的按键设置 目前平台默认是按音量上键+开机键进入测试模式，请根据实际需要在如下文件中修改该按键 键值定义参见：u-bootboard/spreadtrum/sp8810/key_map.h 中 按键判断：u-boot/board/spreadtrum/sp8810/sprd_kp.c 中的函数 check_key_boot (uint32_t key)。 3.16.2 如何修改测试模式的音频通路 system(&quot;alsa_amixer cset -c sprdphone name=\&quot;Speaker Playback Switch\&quot; 0&quot;)； system(&quot;alsa_amixer cset -c sprdphone name=\&quot;Earpiece Playback Switch\&quot; 0&quot;)； system(&quot;alsa_amixer cset -c sprdphone name=\&quot;Headset Playback Switch\&quot; 0&quot;)；<br /><br />
39<br /><br />
<br /><br />
这三句代码分别控制 speaker/receive/headset 通路的开关，1 表示开，0 表示关； 具体用法参考代码 external/sprd/engineeringmode/engtest/common/eng_audio_loopback.c 中的函数 eng_audio_phoneloopback(void)和 eng_audio_headsetloopback(void)。<br /><br />
<br /><br />
3.17 OTA 3.17.1 如何进行 OTA 升级<br /><br />
OTA升级有两种方式，一种是完全升级（FULL UPDATE）,一种是差分升级（DELTA UPDATE）。 一 差分升级： 1、 修改配置文件： customize/customer_cfg/sp8810ga/res/AndroidBoard.mk customize/customer_cfg/sp8810ga/res/BoardConfig.mk 下面是两个文件修改的地方 diff --git a/customer_cfg/sp8810ga/res/AndroidBoard.mk b/customer_cfg/sp8810ga/res/AndroidBoard.mk index b43e1e1..c9ca5f3 100644 --- a/customer_cfg/sp8810ga/res/AndroidBoard.mk +++ b/customer_cfg/sp8810ga/res/AndroidBoard.mk @@ -1,9 +1,9 @@ LOCAL_PATH := $(call my-dir) -#$(call -#$(call -#$(call -#$(call +$(call +$(call +$(call +$(call add-radio-file,modem_bins/modem.bin) add-radio-file,modem_bins/nvitem.bin) add-radio-file,modem_bins/dsp.bin) add-radio-file,modem_bins/vmjaluna.bin) add-radio-file,modem_bins/modem.bin) add-radio-file,modem_bins/nvitem.bin) add-radio-file,modem_bins/dsp.bin) add-radio-file,modem_bins/vmjaluna.bin)<br /><br />
<br /><br />
diff --git a/customer_cfg/sp8810ga/res/BoardConfig.mk b/customer_cfg/sp8810ga/res/BoardConfig.mk index d8e16b0..22229b4 100755 --- a/customer_cfg/sp8810ga/res/BoardConfig.mk +++ b/customer_cfg/sp8810ga/res/BoardConfig.mk @@ -30,7 +30,7 @@ BUILD_SPRD_HW := true BUILD_SPRD_ENG := true BUILD_SPRD_STAGEFRIGHT := true TARGET_RECOVERY_UI_LIB := librecovery_ui_sprd -HAVE_RADIO_IMG := false +HAVE_RADIO_IMG := true BUILD_SPRD_TELEPHONY := true ifneq ($(strip $(ANDROID_3RDPARTY_SELECTED_PRODUCT_SUB_VERSION)),) TARGET_SUPPORT_SIM_CNT := $(ANDROID_3RDPARTY_SELECTED_PRODUCT_SUB_VERSION)<br /><br />
40<br /><br />
<br /><br />
2、将需要升级的BP名称修改为如下： dsp.bin modem.bin nvitem.bin vmjaluna.bin 3、将命名好的文件放入&quot;customize/customer_cfg/sp8810ga/res/modem_bins/&quot;这个目录； 4、正常编译system（./mk sp8810ga n）； 5、./mk sp8810ga u ota (做完这一步，modem、dsp等就会存放在差分包中间文件中)； 6、编译生成的整体otapackage路径：out/target/product/hsdroid/sprdroid_base-ota- W12.13.zip 7、编译生成的差分包中间文件路径：out/target/product/hsdroid/obj/PACKAGING /target_files_intermediates/sprdroid_base-target_files-W12.13.zip； 8、保留两个版本的差分包中间文件，将每次生成的sprdroid_base-target_files-W12.13.zip都保存 起来； 9、使用上一个版本的差分包中间文件和本次的差分包中间文件，生成差分包： ./build/tools/releasetools/ota_from_target_files -i &quot;上一个版本的差分包中间文件&quot; -k build/target/product/security/testkey --modem_update &quot;本次差分包中间文件&quot; update.zip 10、把生成的update.zip放入T卡根目录； 1１、进入Android recovery模式（展讯默认进入方式是关机状态下长按POWER键+下音量键），按右 下侧键进入(默认是Camera键)进入Android system recovery utility 模式； 选择：apply sdcart:update.zip，按选择键（展讯默认是POWER键）进行选择； 注一： 上面的ota_from_target_files是生成差分包的脚本，--help可以查看详细的使用参数， 这里保存生成的update.zip就可以了。 注二： “上一个版本的差分包中间文件” ： 指的是与目前已经DOWNLOAD 在待升级手机中版本一致的基础 上编译生成的OTA压缩包（out/target/product/hsdroid/obj/PACKAGING /target_files_intermediates/xxxx.zip）。 &quot;本次差分包中间文件&quot; : 指的是待升级软件版本基础上编译生成的OTA压缩包。 （out/target/product/hsdroid/obj/PACKAGING /target_files_intermediates/xxxx.zip）。 以上在编译OTA之前都需要走步骤1～5。 注三： 例： ./build/tools/releasetools/ota_from_target_files -i &quot;/home/taofeng/2.3.5_vlx/out/target/product/hsdroid/obj/PACKAGING/target_files_intermed iates/sprdroid_base-target_files-W12.26_20120716.165254.zip&quot; -k build/target/product/security/testkey --modem_update &quot;/home/taofeng/2.3.5_vlx/out/target/product/hsdroid/obj/PACKAGING/target_files_intermed iates/sprdroid_base-target_files-W12.26_20120717.094309.zip&quot; update.zip 二 完全升级 完全升级比较简单只需要完成步骤１－５， 把编译生成的整体otapackage路径下的ＯＴＡ压缩包( 例： out/target/product/hsdroid/sprdroid_base-ota- W12.13.zip）重新命名成update.zip放入 T卡根目录，按照步骤11操作进行升级即可。<br /><br />
<br /><br />
41<br /><br />
<br /><br />
第4章 Framework &amp; APP<br /><br />
4.1 通话 通信录 短彩信 4.1.1 如何获取短信中心号码 由于短信中心号码是存储在 SIM 卡里的，是在办理卡的时候写入到 SIM 卡中的。但是可以修改。 各个地方的短信中心号码设置规律如下：+861380 + 开户局四位长途区号 + 500 。不足四位在 四位前补 0。代码中接口如下 try { ITelephony iTelephony = ITelephony.Stub.asInterface(ServiceManager.getService(PhoneFactory .getServiceName(Context.TELEPHONY_SERVICE, 0))); String smscStr = iTelephony.getSmsc(); Toast.makeText(this, smscStr, Toast.LENGTH_LONG).show(); } catch (RemoteException e) { Log.e(&quot;duochen&quot;, &quot;[smsc]Failed to get smsc due to remote exception&quot;); } 这里如果是App中使用要在AndroidManifest.xml加入权限 &lt;uses-permission android:name=&quot;android.permission.MODIFY_PHONE_STATE&quot;&gt;&lt;/uses-permission&gt; 4.1.2 如何获取本机 SIM 卡的电话号码 权限：&lt;uses-permission android:name=&quot;android.permission.READ_PHONE_STATE&quot; /&gt; 代码 TelephonyManager tm = (TelephonyManager)this.getSystemService(Context.TELEPHONY_SERVICE);//卡 1 TelephonyManager tm2 = (TelephonyManager)this.getSystemService( PhoneFactory.getServiceName(Context.TELEPHONY_SERVICE,1)); String tel = tm.getLine1Number(); String tel2 = tm2.getLine1Number(); 备考： 1.以上方法只能读取将电话号码固化在 SIM 卡的卡。现在大多数的卡是将电话号码保存 在运营上的服务器上，而不是保存在 SIM 卡上的，SIM 卡只保留 IMSI 和一些验证消息。这类卡 的话，用上述接口就无法读出了。 2.我们这里确认了一下，用 04 年左右的 SIM 可以读取电话号码，但是用 08 年的 SIM 卡就无法读<br /><br />
42<br /><br />
<br /><br />
//卡 2<br /><br />
<br /><br />
取电话号码。 4.1.3 无接近传感器，如何在开始通话后关闭屏幕 在 Phone 应用的 phoneApp 这个类中。找到下边这段代码： mProximityWakeLock = pm.newWakeLock(PowerManager.PROXIMITY_SCREEN_OFF_WAKE_LOCK, LOG_TAG); 然后注释掉。这个是获取了接近传感器的 WakeLock。然后在 updatePokeLock 这个方法中。将 //pokeLockSetting |= LocalPowerManager.POKE_LOCK_MEDIUM_TIMEOUT; 改为 pokeLockSetting |= LocalPowerManager.POKE_LOCK_SHORT_TIMEOUT; 将 updateWakeState 方法中 setScreenTimeout(ScreenTimeoutDuration.DEFAULT); 改为 setScreenTimeout(ScreenTimeoutDuration.SHORT); 这个是将默认延时时间设置为 SHORT （5 秒） 。如果需要改为其他时间需要去改 setScreenTimeout 这个方法。 4.1.4 ms，mms，contact 容量限制 [适用版本] 2.3.5<br /><br />
<br /><br />
1.只要在容量允许的情况下，sms，mms 接收条数是没有限制的，但是每个会话的条数是有限 制的，默认情况下，每个会话的短信限存 200 条，彩信限存 20 条，但是能调整到 5000 条。 MmsConfig.java 代码中做了如下限制： private static int mDefaultSMSMessagesPerThread = 200; private static int mDefaultMMSMessagesPerThread = 20; private static int mMinMessageCountPerThread = 2; private static int mMaxMessageCountPerThread = 5000; 2.contact 的记录总数目前没有限制。 4.1.5 是否需要自动重拨设置功能 [适用版本] 2.3.5 // default value // default value // default value // default value<br /><br />
<br /><br />
在 future phone 设置菜单中，有自动重拨设置选项，CTA 测试需测试，为什么 8810 手机设置中 没有该选项。 跟 CTA 北京那边确认：移动对功能没有做强制要求，如果客户有该功能，移动会当功能项测 试。如果没有，移动则不会测试。移动入库对该功能也没有强制要求。<br /><br />
43<br /><br />
<br /><br />
4.2 数据连接 4.2.1 默认关闭“已启用数据”方法 settings.db--&gt;secure--&gt;mobile_data=,0 /*** @see ConnectivityManager#getMobileDataEnabledByPhoneId(int) */ public boolean getMobileDataEnabledByPhoneId(int phoneId) { enforceAccessPermission(); boolean retVal = Settings.Secure.getIntAtIndex(mContext.getContentResolver(), Settings.Secure.MOBILE_DATA, phoneId, 0 /*1*/) == 1; //lanting modified 20120618 if (DBG) Slog.d(TAG, &quot;getMobileDataEnabled[&quot; + phoneId + &quot;] returning &quot; + retVal); return retVal; } /** { enforceAccessPermission(); boolean retVal = Settings.Secure.getIntAtIndex(mContext.getContentResolver(), Settings.Secure.MOBILE_DATA, PhoneFactory.getDefaultPhoneId(), 0 /*1*/) == 1; //lanting modified 20120619 if (DBG) Slog.d(TAG, &quot;getMobileDataEnabled returning &quot; + retVal); return retVal; } 4.2.2 双卡版本设置数据业务默认关闭 ConnectivityService.java (base\services\java\com\android\server) public boolean getMobileDataEnabledByPhoneId(int phoneId) { enforceAccessPermission(); boolean retVal = Settings.Secure.getIntAtIndex(mContext.getContentResolver(), Settings.Secure.MOBILE_DATA, phoneId, 0) == 1; // 将 1 设置为 0 if (DBG) Slog.d(TAG, &quot;getMobileDataEnabled[&quot; + phoneId + &quot;] returning &quot; + retVal); return retVal; } * @see ConnectivityManager#getMobileDataEnabled() */ public boolean getMobileDataEnabled()<br /><br />
<br /><br />
44<br /><br />
<br /><br />
4.2.3 数据漫游功能的默认值如何修改 [适用版本] 2.3.5 ro.com.android.dataroaming = false 4.2.4 T G 版本，TD Only/GSM Only 的设置无效 因为移动要求支持 T+G，所以这个时候设置 T 或者 G，都不好处理，所以现在 PS 对这个做限 制： 如果双卡，则 T/G Only 设置无效。 如果单卡，则可以进行设置<br /><br />
<br /><br />
[Tick0013926]在\customize\customer_cfg\sp8810ga\res\system.prop 文件中增加以下语句：<br /><br />
<br /><br />
4.3 WIFI/BT 4.3.1 WIFI 图标在状态栏和设置中显示不一致 关于 wifi 图标在 starbar 和 WifiSettings 中显示的步骤是不一样的。 在 接 到 android.net.wifi.RSSI_CHANGED 广 播 后 ， WifiSettings 中 的 处 理 是 ： 直 接 刷 新 图 标;starbar 中的处理是通过系统服务来调用 StatusBarManagerService.java 中的 setIcon（）方法更 新图标，而且在 setIcon （） 方法中需要先得到 StatusBarIconList 的对象锁“synchronized (mIcons)” 之后才能刷新图标。就可能导致 StatusBar 更新图标相对滞后。 WifiSettings 和 StatusBarPolicy 中对于 android.net.wifi.RSSI_CHANGED 广播的处理和处理完成 时间都几乎是一致的，而 StatusBar 更新图标相对滞后应该是需要的等锁的原因。所以暂时没有 好的办法来加快 StatusBar 更新 wifi 图标。 4.3.2 过认证如何隐藏所有 wifi 设置选项 Settings 的路径是：“../packages/apps/Settings” 1、 隐藏 Settings 里面的选项 &lt;1&gt;修改 .xml 文件。找到 res/xml/wireless_settings.xml ,然后将下面的代码删掉。 &lt;CheckBoxPreference android:key=&quot;toggle_wifi&quot; android:dependency=&quot;toggle_airplane&quot; android:title=&quot;@string/wifi_quick_toggle_title&quot; android:summary=&quot;@string/wifi_quick_toggle_summary&quot; android:persistent=&quot;false&quot; /&gt;<br /><br />
<br /><br />
45<br /><br />
<br /><br />
&lt;PreferenceScreen android:key=&quot;wifi_settings&quot; android:dependency=&quot;toggle_airplane&quot; android:title=&quot;@string/wifi_settings&quot; android:summary=&quot;@string/wifi_settings_summary&quot; &gt; &lt;intent android:action=&quot;android.intent.action.MAIN&quot; android:targetPackage=&quot;com.android.settings&quot; android:targetClass=&quot;com.android.settings.wifi.WifiSettings&quot; /&gt; &lt;/PreferenceScreen&gt; &lt;2&gt;修改 Java 文件，一共需要修改两个 Java 文件。 1. 找到 /src/com/android/settings/WirelessSettings.java 文件，将所有带有“wifi”字样的代 码全部都注释掉，具体代码如下所示。 // // // // private static final String KEY_TOGGLE_WIFI = &quot;toggle_wifi&quot;; private WifiEnabler mWifiEnabler; mWifiEnabler = new WifiEnabler(this, wifi); mWifiEnabler.resume(); mAirplaneModeEnabler.resume(null, mBtEnabler);//注意：此行不能注释，将 mWifiEnabler 更改为 null 即可。 // mWifiEnabler.pause(); “ mWifiEnabler.resume(); ”注释掉即可。 // mWifiEnabler.resume(); 2、隐藏 widget 里的 Wi-Fi 选项 只需对 widget.xml 这个文件进行修改，将“ android:visibility=&quot;gone&quot; ”添加到 Wi-Fi 相关的 布局标签即可。修改后的代码如下： &lt;LinearLayout android:id=&quot;@+id/btn_wifi&quot; android:layout_width=&quot;0dip&quot; android:layout_weight=&quot;1&quot; android:layout_height=&quot;match_parent&quot; android:background=&quot;@drawable/appwidget_button_left&quot; android:clickable=&quot;true&quot; android:focusable=&quot;true&quot;<br /><br />
46<br /><br />
<br /><br />
2. 找到 /src/com/android/settings/AirplaneModeEnabler.java 文件，将<br /><br />
<br /><br />
android:orientation=&quot;vertical&quot; android:visibility=&quot;gone&quot;&gt;<br /><br />
<br /><br />
4.4 CAMERA 4.4.1 单摄像头进入时间较长如何解决 在 customize/customer_cfg/sp6820a/kernel/camera/camera_cfg.c 中 main_sensor_infor_tab 和 sub_sensor_infor_tab 里会放很多 sensor 的结构体；camera 启动初始化时，底层驱动会匹配相关的菜单， 删除没有的 sensor，能加快启动 4.4.2 在搜索框中进入相机耗时 [适用版本] 2.3.5<br /><br />
<br /><br />
1.功能用途概述 有时候有些服务启动比较耗时，例如 Camera，导致在当前 activity 切换到 camera 预览的 activity 时会卡的很严重，结果就出现界面 1 秒或者 2 秒被卡住的现象，造成用户体验效果不好。对此 问题，可以选择将此耗时的动画效果暂时去掉，等到摄像头服务启动后再恢复动画。 2.方案具体实现(以在搜索框中搜索相机，然后打开相机卡住为例) 导入包： importandroid.view.IWindowManager; importandroid.os.ServiceManager; 定义： privateIWindowManager mWindowManager; mWindowManager= IwindowManager.Stub.asInterface(ServiceManager.getService(&quot;window&quot;)); //获取一个 IwindowManager 对象。 (1)去除动画效果。 protectedbooleanlaunchSuggestion(intposition) { SuggestionCursor suggestions = getCurrentSuggestions(position); if(suggestions == null) returnfalse; if(DBG) Log.d(TAG, &quot;Launching suggestion &quot;+ position); mTookAction= true; // Log suggestion click getLogger().logSuggestionClick(position,suggestions,<br /><br />
47<br /><br />
<br /><br />
getCurrentIncludedCorpora(),Logger.SUGGESTION_CLICK_TYPE_LAUNCH); // Create shortcut getShortcutRepository().reportClick(suggestions, position); float[] mAnimationScales = {0}; // Launch intent suggestions.moveTo(position); Intent intent = SuggestionUtils.getSuggestionIntent(suggestions, mAppSearchData); if(intent.toString().contains(&quot;camera&quot;)||intent.toString().contains(&quot;Camera&quot;)) { try { mAnimationScales = mWindowManager.getAnimationScales(); //保存之前窗口动画效果 mWindowManager.setAnimationScales(newfloat[] { 0, 0 }); } catch(RemoteException e) { e.printStackTrace(); } //恢复窗口动画 } launchIntent(intent); try { mWindowManager.setAnimationScales(mAnimationScales); } catch(RemoteException e) { } returntrue; } （2）添加权限： &lt;uses-permissionandroid:name=&quot;android.permission.SET_ANIMATION_SCALE&quot;/&gt; （3）修改该 app 编译中的.mk 文件，注释 #LOCAL_SDK_VERSION := 8 3.解决此问题过程当中遇到的困难点：<br /><br />
48<br /><br />
<br /><br />
默认由于使用 LOCAL_SDK_VERSION := 8，导致导入 importandroid.view.IWindowManager; importandroid.os.ServiceManager; 编译之后，报找不到该类的错误，查询了一些资料之后发现这 2 个类都是隐藏类。本来应该是 用户在写上层 APP 应用的时候导入这 2 个类是编译不成功的，可以通过 aidl 的反射方式解决此 问题，但我在源码中修改是不应该出现此类问题的，在这里仍然出现此类问题。耗费了大半 天，经过思考和多次的尝试，这找到原因，这个问题是 2.2sdk 中的一个 bug,2.3sdk 修复了此问 题。也因此，需要注释 LOCAL_SDK_VERSION := 8。 4.4.3 如何调用系统闪光灯接口 通过 Camera 参数设置闪光灯模式：CameraParameter.setFlashMode（） FlashMode 共有三种模式：ON OFF TORCH 1. 2. 3. ON: 闪光灯会在自动对焦和拍照模式下亮 OFF：闪光灯永远不会亮 TORCH: 闪光灯常亮<br /><br />
<br /><br />
4.5 多媒体 4.5.1 目前支持的音视频文件格式 [适用版本] 音频： MP3 (支持 layer1,2) AAC OGG WAV (linear 非压缩 pcm) WAV (u-law, a-law pcm) MIDI AMR-NB AMR-WB 视频： 3GP、MP4 打包格式： 视频编码: mpeg4/h.263/h.264 音频编码: aac/amr<br /><br />
49<br /><br />
<br /><br />
2.3.5<br /><br />
<br /><br />
AVI 打包格式： 视频编码: mpeg4/h.264 音频编码: mp3 视频解码器 profile: mpeg4: 最高 720x576。ASP profile。 h.264: 最高 720x576。不支持 high profile。 未来计划： mpeg4/h.264 的高清解码器正在开发中，会支持 1280x720 分辨率，其中 h.264 支持 high profile。 4.5.2 MBBMS 的 UA 设置长度限制问题 客户在设置 MBBMS 时，会遇到 UA 过长而设置不成功的情况。此问题在 2.3.5 的 CMCC 12.06.P13 之后的版本上的 APK 解决的。 目前 UserAgent 由三个 System Property 组成，分别为 persist.mbbms.useragent、 persist.mbbms.useragent_1 和 persist.mbbms.useragent_2 ；其 UserAgent 值为 &lt;useragent0&gt;+&lt;useragent1&gt;+&lt;useragent2&gt;。 配置方法如下： setprop persist.mbbms.useragent &lt;useragent0&gt; setprop persist.mbbms.useragent_1 &lt;useragent1&gt; setprop persist.mbbms.useragent_2 &lt;useragent2&gt; 客户根据需要可以同时用 1 个、2 个或者 3 个 Properties，关于内容可以随便划分，但是必须要 有 persist.mbbms.useragent 这个 property。 UA 修改路径： customize/customer_cfg/sp8810ga/res/init.sp8810.3rdparty.rc setprop persist.mbbms.useragent &lt;useragent name&gt; 4.6 工程模式 4.6.1 如何调整工程模式 MIC 音量 1 audiotester 工具修改 handset 模式下面的 GODL/GODR 参数 //电话中也会变大 2 切换到 speaker external/sprd/engineeringmodel/engtest/eng_audio_loopback.c， 在 eng_audio_phoneloopback()函数中，修改 set_audio_mode(0x1)为 set_audio_mode(0x2)即可<br /><br />
<br /><br />
50<br /><br />
<br /><br />
4.6.2 关闭呼叫转移查询和 PDP 的方法 [Tick0013995]操作如下： *#*#83781#*#*---App Settings--- Call Forward Query *#*#83781#*#*---App Settings--4.7 客户化问题 4.7.1 平台提供 PC 上网功能 首先把 APN 设置为 cmnet，在设置，网络设置里，使用 USB 绑定功能，用 USB 连接手机和电 脑，安装正确的驱动，会出现一张新网卡。用 ipconfig 可以看到如下的类似信息： Connection-specific DNS Suffix . : Description . . . . . . . . . . . : Spreadtrum USB Ethernet/RNDIS #2 Physical Address. . . . . . . . . : 62-DF-46-92-4B-8B Dhcp Enabled. . . . . . . . . . . : Yes Autoconfiguration Enabled . . . . : Yes IP Address. . . . . . . . . . . . : 192.168.42.151 Subnet Mask . . . . . . . . . . . : 255.255.255.0 Default Gateway . . . . . . . . . : 192.168.42.129 DHCP Server . . . . . . . . . . . : 192.168.42.129 DNS Servers . . . . . . . . . . . : 120.196.165.7 221.179.38.7 Lease Obtained. . . . . . . . . . : 2012 年 1 月 11 日 17:45:03 Lease Expires . . . . . . . . . . : 2012 年 1 月 11 日 18:45:03 注意，某些版本将 tethering 工作放置在 UNIFI6027 里面，注意要打上这个 patch，否则 PC 上 usb 网卡一直显示无连接。 4.7.2 SD 卡的音频文件设置为来电或短信铃声 [Tick0014009] 安卓手机铃声设置教程。一般Android手机具有四种铃声可以设置，分别为：来电、短信、闹 钟、系统等种类铃声，具体的设置方法为： 1.打开Android手机的内存卡盘，在里面成立个“media”文件夹，然后打开后成立个 “audio”文件 夹。 2.打开“audio”文件夹后，在里面分别成立“ringtones”（来电）、“notifications”（短信）、“alarms” （闹钟）、“ui”（系统提示）。<br /><br />
51<br /><br />
<br /><br />
Apn Activepdp Filter<br /><br />
<br /><br />
3.遵循本身的需要将铃声存放到这几个文件夹中。 4.打开Android手机，在“菜单”-“设置”-“声音”这里便可以自行进行选择了。 【首要提示：把文件夹设置好，在把要设置的铃声放进指定文件夹后重启手机后，再进行设 置，便可以选择刚才放进的铃声！】 4.7.3 平台是否提供 PC 同步工具 我们平台本身没有定制 PC 同步工具，但是有很多第三方的同步工具，比如 91 手机助手，豌豆 荚手机精灵等，用户可自行下载使用。 91 手机助手工具未提供“通过连接 PC 端对手机端日历进行删除和同步”的功能。请使用 android sync manager wifi 工具，下载地址：http://global.mobileaction.com/product/product_AM.jsp。 4.7.4 如何使用 T 卡 OTA 升级 [适用版本] 2.3.5<br /><br />
<br /><br />
（本文验证版本 8810 主线 W12.20 OK） 目前 8810 支持 T 卡 OTA 升级，具体使用方法如下： 如何生成升级包： 编译时 new 过之后，执行./mk sp8810ga u ota 会在目录下生成一个 ota 的 zip 包。将这个包放入 t 卡根目录 热升级步骤： 1.将路径下的压缩包直接放到 T 卡根目录下 2.关机后，按住 power 和下音量键（此处如同时按开不了，可先按 power 键然后马上按住音量 下方向键），等待弹出三角形的 logo 3.按 camera 键，高亮移到 apply sdcard:update.zip (上下音量键进行移动) 4.按 power 键进行选择 5.按上下音量键，移动光标到 XXXXX.zip,按 power 键， 6.按上下音量键，移动光标到 reboot system now ,按 power 键 4.7.5 客户 UA 写法是否正确 客户的 UA 为 xxx_yyy_TD/yyy_MocorDroid2.2_W11.41_V1.00 Threadx/4.0 Linux/2.6.32 Android/2.2 Release/11.29.2011 Browser/AppleWebKit533.1 Profile/MIDP-2.0 Configuration/CLDC-1.1，这样正确么？ User Agent 中文名为用户代理，简称 UA，它是一个特殊字符串头，使得服务器能够识别客户 使用的操作系统及版本、 CPU 类型、浏览器及版本、浏览器渲染引擎、浏览器语言、浏览器 插件等。一些网站常常通过判断 UA 来给不同的操作系统、不同的浏览器发送不同的页面，<br /><br />
52<br /><br />
<br /><br />
因此可能造成某些页面无法在某个浏览器中正常显示，但通过伪装 UA 可以绕过检测。 客户写的至少有两个问题： 1，Threadx是不要写的，这仅仅是modem的操作系统，与Android没关系。 2，profile 和 configuration 的 MIDP,CLDC 等不支持，这是 JAVA 的东西。 我们出现过由于 UA 没写好导致有些网页表现不正常的情况。所以客户 UA 最好是基于我们的 参考字符串， Mozilla/5.0 (Linux; U; Android 2.2) AppleWebKit/533.1 (KHTML, like Gecko) Version/4.0 Mobile Safari/533.1, 再加上客户自己的产品型号，编译时间等信息： xxx_yyy_TD/yyy_MocorDroid2.2_W11.41_V1.00 Release/11.29.2011 Mozilla/5.0 (Linux; U; Android 2.2) AppleWebKit/533.1 (KHTML, like Gecko) Version/4.0 Mobile Safari/533.1 终端型号 版本 操作系统 版本 软件平台 版本 Browser 必须 有则必填 有则必填<br /><br />
<br /><br />
Release 发布日期 必须 版本必须 有则必填 有则必填 Profile 版本<br /><br />
<br /><br />
Configuration 版本 Others Others 可选<br /><br />
<br /><br />
4.7.6 修改系统只有中英文语言选项 需求：设置-语言和键盘-选择语言菜单中去掉其他语言只留简体中文和英文 在build\target\product\目录下看到sdk.mk,languages_full.mk, languages_small.mk中均有 PRODUCT_LOCALES的配置，但是无论修改哪个都不起作用。应该修改这里： customize/customer_cfg/sp8810ga/res/sprd_apps.mk 添加如下红色部分: PRODUCT_LOCALES := \ en_US\ zh_CN 4.7.7 客户如何更换开关机图片/动画/铃音 开机 logo 的第一张图片是 Boot_Logo,必须是在烧录时烧入系统中，因为 linux 在启动时就需要 使用该图片，后续修改是没有用的。 该图片格式为 Bmp，根据用户产品屏幕大小和分辨率而定(如 256 色，320X480)，具体格式可 以参考发布 IDH 包中的图片格式。<br /><br />
53<br /><br />
<br /><br />
1）客户定制开机画面（第一屏开机 logo） 修改 reasearchdownload 烧写的选择的 boot_logo 就可以了，这个格式需为 bmp，根据用户 产品屏幕大小和分辨率而定（比如 256 色，320*480）. 格式可以参照发布包里的图片，再 开机就可以看到效果了。而且，在充电状态时开机已经不需要独立的开机 logo。 2）客户定制机动画 替换 3rdparty/anim/poweranim/special/bin/bootanimation.zip bootanimation.zip 动画文件制作方法：机动画是由一个 zip 格式的压缩包组成，压缩包里面 包含数张 png 格式的图片，还有一个 desc.txt 的文本文档，动画播放时按 desc.txt 里面的指 令控制，屏幕上就会按文件名称顺序连续的播放一张张的图片，形成动画效果。 对 desc.txt 解释说明: 480 320 15 // 图片宽度 480，高度 320，根据手机的屏幕参数设定，最后 15 是指播放动画的每秒帧 率，即每秒钟播放多少张图片。 p 1 0 foldername // p 是一个分隔符，1 表示播放一遍，0 表示播放完后停顿 0 帧，最后是图片所在的 zip 包里的目录名。 如果 zip 包的结构是： folder0. 根据这个语法，我们也可以自定义各种动画形式，例如下面所示: p 2 30 folder0 p 0 0 folder1 //将 folder0 里的图片，播放 2 遍，播放完一遍后停顿 30 帧，因为我们之 //将 folder1 里的图片无限循环播放，每次播放不停顿。 前设置了帧率是 15 帧每秒，那么这里就等于停顿 2 秒。 注意：如果设置图片的宽度和高度不充满屏幕，那么剩余区域系统会填充黑色;如果设置的 宽度和高度大于屏幕，系统会自动裁剪显示居中部分的图片区域。 将转换好的图片集打包在不同的目录下 , 然后把图片目录和一个描述动画的 desc.txt 无压 缩率格式打包成 bootanimation.zip， 注意一定要选择无压缩率，无损压缩,并保持压缩包后 的目录结构。 3）客户定制关机动画 替换 3rdparty/anim/poweranim/special/bin/shutdownanim.zip，制作方法同 bootanimation.zip 4）客户定制开机铃声 替换 3rdparty/anim/poweranim/special/bin/startupsound<br /><br />
54<br /><br />
<br /><br />
folder0(里面包含很多图片） + desc.txt ；那么 foldername 替换成<br /><br />
<br /><br />
注：这里的 startupsound 可以是 mp3 或者 ogg 格式的，替换时不需要扩展名 5）客户定制关机铃声 替换 3rdparty/anim/poweranim/special/bin/shutdownsound 注：这里的 shutdownsound 可以是 mp3 或者 ogg 格式的，替换时不需要扩展名 4.7.8 背光亮度，静音等默认值如何修改 [Tick0014119] 修改\frameworks\base\packages\SettingsProvider\res\values\defaults.xml中的默认值即可。 4.7.9 浏览器如何修改内置的“搜索引擎” [Tick0015232] 修改packages\apps\browser\res\values\donoottranslate-search_engines,xml文件，中 “search_engines”的string-arry中的item项即可。如下事例为内置了 139/百度/google 三个搜索引 擎。 &lt;string-array name=&quot;search_engines&quot; translatable=&quot;false&quot;&gt; &lt;item&gt;search139&lt;/item&gt; &lt;item&gt;baidu&lt;/item&gt; &lt;item&gt;google&lt;/item&gt; &lt;/string-array&gt; NOTES：如果支持多种语言，其他文件下的同名文件donoottranslate-search_engines,xml也需要 修改。 4.7.10 添加预制 apk 应用 [适用版本] 2.3.5<br /><br />
<br /><br />
有两个地方可以添加， 1)将apk和相应so拷贝到packages/apps/Prebuilt_apps/目录下，根据文件修改cmcc_apks.mk里面的 复制项目。 2)将apk和相应so拷贝到 3rdparty/cmcc/CMCC/special/app和lib目录下,如果是多项目包含不同的 apk应用组合，可以开多个CMCC的平级目录，并在customize/make/sp8810.mak或平级文件里面 指定 3RDPARTY_CMCC = CMCC或相应目录。 4.7.11 第三方应用和 so 文件集成到系统中 SC8810 提供了如下两个入口将第三方应用集成到系统（system/app）中：<br /><br />
55<br /><br />
<br /><br />
将第三方应用拷贝到/packages/apps/Prebuilt_apps/中，然后修改此目录下的 cmcc_apks.mk（以第 三方应用 HuangliProvider.apk 为例）： PRODUCT_COPY_FILES += \ $(LOCAL_PATH)/HuangliProvider.apk:system/app/HuangliProvider.apk 2. 将第三方应用拷贝到 3rdparty/cmcc/CMCC/special/app/中， 修改 3rdparty/cmcc/CMCC/special/ build.sh（以第三方应用 Sinaweibo.apk 为例）： function my_local_install() { …… cd ${MYCHIP_BASE}/app mkdir -p ${ANDROID_3RDPARTY_ANDROID_OUT}/system/app cp -f SinaWeibo.apk ${ANDROID_3RDPARTY_ANDROID_OUT}/system/app …… } 注：有些第三方应用需要自身的一些 so 文件才能够运行，譬如 Sinaweibo.apk,假如就按照以上 两种方式的任意一种将其集成到 system/app 中去，结果系统启动后会因为找不到 libutility.so 文 件导致 Sinaweibo 程序运行出错，此时我们就需要解压 Sinaweibo.apk，从中找到 libutility.so,将 其拷贝到 3rdparty/cmcc/CMCC/special/lib/中，重新生成 system.img，之后 Sinaweibo 程序才能够 正常运行。 4.7.12 关机充电动画修改 关机充电动画的资源路径是： external/sprd/charge/res/images/ 将这个目录下的 png 图片文件修改客户需要的文件就可以了。 4.7.13 关闭灭屏特效的方法 关闭灭屏特效的方法： frameworks/base/core/res/res/Values/Config.xml &lt;bool name=&quot;config_animateScreenLights&quot;&gt;false&lt;/bool&gt; ==&gt; &lt;bool name=&quot;config_animateScreenLights&quot;&gt;true&lt;/bool&gt; 之前打开这个特效是为了避免关机的画面残留，如果背光流程做出调整，就可以避免此问题。 4.7.14 如何调整低电报警电压 在 idh.code\frameworks\base\core\res\res\values\config.xml 中 ， config_lowBatteryWarningLevel:<br /><br />
56<br /><br />
<br /><br />
15-----&gt;百分比，请根据实际需要动态调整该数值来调整低电电压 4.7.15 如何设置默认动态壁纸 找到 /frameworks/base/core/res/res/values/config.xml 文件中 &lt;string name=&quot;default_wallpaper_component&quot;&gt;@null&lt;/string&gt; 为设置默认壁纸的代码如若想要更换成为动态壁纸。只需将 “@null” 更改为动态壁纸的路径即 可，例如： 将默认壁纸更改为“线性光幕效果”的动态壁纸，则更改成如下代码： &lt;string name=&quot;default_wallpaper_component&quot;&gt;com.android.wallpaper/com.android.wallpaper.nexus.NexusWal lpaper&lt;/string&gt; com.android.wallpaper 在 AndroidManifest 文件中的 packagename com.android.wallpaper.nexus.NexusWallpaper 在 AndroidManifest 文件中的 service name 需要注意的是:静态的图片壁纸和 live wallpaper 是两个系统,加载的时候是完全两套机制,静态图片 通过 launcher 里面的一个 xml 文件配置来管理系统默认静态壁纸,live wallpaper 则是通过 intent 机 制向系统搜寻所有匹配 Activity,所以,这里的默认值为 null,而不是那个系统默认静态壁纸的地址, 系统是读 config.xml 文件的设置,若为 null 才继续查找静态壁纸配置内容. 没有效果的话，恢复下 出厂设置即可。 4.7.16 如何设置系统默认壁纸 如果只需要修改动态壁纸，替换 frameworks/base/core/res/res/drawable/default_wallpaper.jpg 即可, 或者在源码中修改对应 default_wallpaper 地址. 4.7.17 为什么某些 APK 内置无法使用 注意内置应用的第三步不能省略 否则会因为无法找到 so 文件使得 apk 不能正常使用 1. 将 apk 拷贝到/packages/apps/Prebuilt_apps/目录下 2. 将 apk 解压后并将 lib 文件夹中的 so 文件拷贝到/packages/apps/Prebuilt_apps/目录下 3. 编译平台代码，重新刷机，新的应用程序已经添加到了系统中 4.7.18 关机菜单中如何添加重启选项 /frameworks/policies/base/phone/com/android/internal/policy/impl/GlobalActivity.java&quot; 文 件 添 加 红 色修改部分即可： mItems = Lists.newArrayList(<br /><br />
57<br /><br />
<br /><br />
// silent mode mSilentModeToggle, // next: airplane mode mAirplaneModeOn, // last: power off new SinglePressAction( com.android.internal.R.drawable.ic_lock_power_off, R.string.global_action_power_off) { public void onPress() { // shutdown by making sure radio and power are handled accordingly. ShutdownThread.shutdown(mContext, true); } public boolean showDuringKeyguard() { return true; } public boolean showBeforeProvisioning() { return true; } }, // add for reboot new SinglePressAction( com.android.internal.R.drawable.ic_lock_power_off, //替换成相应的图 R.string.global_action_power_off) { //替换成相应的提示文字 public void onPress() { ShutdownThread.reboot(mContext, null, true); }<br /><br />
58<br /><br />
<br /><br />
public boolean showDuringKeyguard() { return true; } public boolean showBeforeProvisioning() { return true; } }); // end add 4.7.19 如何修改系统默认输入法 下面将以“谷歌拼音输入法”为例，进行解释和说明。 第一步 修改/frameworks/base/packages/SettingsProvider/res/values/defaults.xml 添加如下代码： &lt;string name=&quot;config_default_input_method&quot; translatable=&quot;false&quot;&gt;com.android.inputmethod.pinyin/.PinyinIME&lt;/string&gt; com.android.inputmethod.pinyin 在 AndroidManifest 文件中的 packagename .PinyinIME 在 AndroidManifest 文件中的 service name 第二步：修改 /frameworks/base/packages/SettingsProvider/src/com/android/providers/settings/DatabaseHelper.java 在 private void loadSecureSettings(SQLiteDatabase db) 方法中，添加如下代码： loadStringSetting( stmt, Settings.Secure.DEFAULT_INPUT_METHOD, R.string.config_default_input_method ); 4.7.20 如何在桌面预置应用程序图标 桌面预制的图标：是在 launcher2 的 default_workspace.xml 中配置的文件路径： Launcher2\res\xml\default_workspace.xml 主要有两种预制类型 1 快捷方式 2 插件也就是常说的 appwidget 分别说明如何添加： 1 快捷方式：以展讯便签为例<br /><br />
59<br /><br />
<br /><br />
&lt;favorite launcher:className=&quot;com.sprdroid.note.NoteActivity&quot; launcher:packageName=&quot;com.sprdroid.note&quot; launcher:screen=&quot;0&quot; launcher:x=&quot;0&quot; launcher:y=&quot;0&quot; /&gt; 参数说明：className 必须指定该应用的入口类 否则点击快捷方式会报错 packageName 应用的包名 screen 为第几个屏上显示。（我们的 eng 版本为从 0 到 4 屏） x，y 为图标在该屏上的显示位置（从左上角（0，0）开始向右方向 x 增加，向下 y 增 加 x，y 最大值均为 3。也就是一屏可以容纳 16 个快捷方式）。 2 插件（appwidget）以 setting 为例 &lt;appwidget launcher:className=&quot;com.android.settings.widget.SettingsAppWidgetProvider&quot; launcher:packageName=&quot;com.android.settings&quot; launcher:screen=&quot;4&quot; launcher:x=&quot;0&quot; launcher:y=&quot;1&quot; launcher:spanX=&quot;3&quot; launcher:spanY=&quot;1&quot; /&gt; 参数说明： className 必须为 继承了 AppWidgetProvider 的子类 如果应用程序没有实现该类将 没法实现该功能。 packageName 应用的包名 x，y 为图标在该屏上的显示位置（从左上角（0，0）开始向右方向 x 增加，向下 y 增加 x，y 最大值均为 3。也就是一屏可以容纳 16 个快捷方式）。 spanX，spanY 为该 AppWidget 占用的屏幕空间大小。其中 spanX，spanY 值也是从 1 到 4。<br /><br />
60<br /><br />
<br /><br />
需要注意的两点： 1.使用新的 Luncher.apk 时需要将旧的 data/data/下的 launcher 的包删掉 否则修改将不起作用：原 因是加载的图标信息是从数据库中读取的 2.参数 x y spanX spanY 需要设置合理，否则将不能正常显示。 4.7.21 如何修改信号强度图标 [适用版本] 2.2.2<br /><br />
<br /><br />
6820 的信号图标要修改：frameworks/base/core/res/res/drawable-hdpi 中修改 java 代码修改：frameworks/base/services/java/com/android/server/status/StatusBarPolicy.java private static final int[] sSignalImages 等数组中是存放的信号的图片资源。 iconLevel ，levelDbm 等的值用来表示信号等级 private int getGsmLevel(SignalStrength sigStrength) ； private int getCdmaLevel(SignalStrength sigStrength)；函数用来设定信号等级。 直接在这些函数中改域值就可以了。 但是改动要慎重，因为不只是 asu=0 / 99 的时候无法正常通话，通常 asu&lt;10 的时候都有可能无法 正常的通话，所以修改以后可能会出现有信号，但是却没有办法打电话的情况。 4.7.22 如何更改系统默认语言 [适用版本] 2.2.2<br /><br />
<br /><br />
以中文为例 修改 customize/customer_cfg/sp6820a/res/sprd_apps.mk 文件开头增加如下： PRODUCT_PROPERTY_OVERRIDES := \ persist.sys.language=zh \ persist.sys.country=CN 4.7.23 如何通过拨号盘暗码启动程序 应用程序中注册广播接收器即可 以工程模式 83781 为例： &lt;receiver android:name=&quot;EngTestingBroadcastReceiver&quot;&gt; &lt;intent-filter&gt; &lt;action android:name=&quot;android.provider.Telephony.SECRET_CODE&quot; /&gt; &lt;data android:scheme=&quot;android_secret_code&quot; android:host=&quot;83780&quot; /&gt; &lt;/intent-filter&gt; &lt;intent-filter&gt;<br /><br />
61<br /><br />
<br /><br />
&lt;action android:name=&quot;android.provider.Telephony.SECRET_CODE&quot; /&gt; &lt;data android:scheme=&quot;android_secret_code&quot; android:host=&quot;83781&quot; /&gt; &lt;/intent-filter&gt; &lt;/receiver&gt; 4.7.24 客户自己添加的 property 设置失败问题 客户的进程想要设置读取一个其他进程数据 property，一般在 eng 模式下一般没问题，但在 user 模式下，Android 是有权限限制的。可修改下面设置来添加客户添加的 property 的修改权限。 在 system/core/init/property_service.c 中，有如下代码。 /* White list of permissions for setting property services. */ struct { const char *prefix; unsigned int uid; unsigned int gid; } property_perms[] = { { &quot;net.rmnet0.&quot;, { &quot;net.gprs.&quot;, { &quot;net.ppp&quot;, { &quot;ril.&quot;, { &quot;gsm.&quot;, { &quot;persist.radio&quot;, { &quot;net.dns&quot;, { &quot;net.&quot;, { &quot;dev.&quot;, { &quot;runtime.&quot;, { &quot;hw.&quot;, { &quot;sys.&quot;, { &quot;service.&quot;, { &quot;wlan.&quot;, { &quot;dhcp.&quot;, { &quot;dhcp.&quot;, { &quot;vpn.&quot;, { &quot;vpn.&quot;, { &quot;debug.&quot;, AID_RADIO, AID_RADIO, AID_RADIO, AID_RADIO, AID_RADIO, AID_RADIO, AID_RADIO, AID_SYSTEM, AID_SYSTEM, AID_SYSTEM, AID_SYSTEM, AID_SYSTEM, AID_SYSTEM, AID_SYSTEM, AID_SYSTEM, AID_DHCP, AID_SYSTEM, AID_VPN, AID_SHELL,<br /><br />
62<br /><br />
<br /><br />
0 }, 0 }, 0 }, 0 }, 0 }, 0 }, 0 }, 0 }, 0 }, 0 }, 0 }, 0 }, 0 }, 0 }, 0 }, 0 }, 0 }, 0 }, 0 },<br /><br />
<br /><br />
{ &quot;log.&quot;, { &quot;persist.sys.&quot;,<br /><br />
<br /><br />
AID_SHELL, AID_SYSTEM,<br /><br />
<br /><br />
0 }, 0 }, 0 }, 0 }, 0 },<br /><br />
<br /><br />
{ &quot;service.adb.root&quot;, AID_SHELL, { &quot;persist.service.&quot;, AID_SYSTEM, { &quot;persist.security.&quot;, AID_SYSTEM, { NULL, 0, 0 } }; 特别属性：<br /><br />
<br /><br />
如果属性名称以“ro.”开头，那么这个属性被视为只读属性。一旦设置，属性值不能改变。 如果属性名称以“persist.”开头，当设置这个属性时，其值将写入/data/property。 如果属性名称以“net.”开头，当设置这个属性时， “net.change”属性将会自动设置，以加入到最 后修改的属性名。（netresolve 模块的使用这个属性来追踪在 net.*属性上的任何变化。） 属性“ctrl.start ”和“ctrl.stop ”是用来启动和停止服务。每一项服务必须在/init.rc 中定义.系统启动 时，与 init 守护进程将解析 init.rc 和启动属性服务。一旦收到设置“ctrl.start ”属性的请求，属性 服务将使用该属性值作为服务名找到该服务，启动该服务。这项服务的启动结果将会放入 “init.svc.&lt;服务名&gt;“属性中 。客户端应用程序可以轮询那个属性值，以确定结果。 创 建 与 修 改 android 属 性 用 Systemproperties.set(name,value) ， 获 取 android 属 性 用 Systemproperties.get(name) ， 需 要 注 意 的 是 android 属 性 的 名 称 是 格 式 要 求 ， 前 缀 必 须 用 system\core\init\property_service.c 中定义的前缀 ，进行系统属性设置的程序也必须有相应的进 程权限，故如何将 android 应用程序的权限提升到 system 权限？方法： (1) 在 AndroidManifest.xml 中，在 manifest 加入 android:sharedUserId=&quot;android.uid.system &quot;。 (2) 在 Android.mk 中， LOCAL_CERTIFICATE:= XXX 修改成 LOCAL_CERTIFICATE := platform 。 经过以上两步就可以把 ap 的权限提升到 system 权限了。 4.7.25 添加搜索引擎 [适用版本] 2.3.5<br /><br />
<br /><br />
SC8810 在其中按照中国移动的要求添加来 139 搜索引擎。 a) 在 res/values/all_search_engines.xml &lt;string-array name=&quot;search139&quot; translatable=&quot;false&quot;&gt; &lt;item&gt;139&lt;/item&gt; &lt;item&gt;&lt;/item&gt; &lt;item&gt;http://s.139.com/favicon.ico&lt;/item&gt; &lt;item&gt;http://s.139.com/search.do?q={searchTerms}&amp;amp;category=downloadable|web|bro wseable&amp;amp;tid=2123,2124,2125,2126&amp;amp;fr=portalcustom2&lt;/item&gt;<br /><br />
63<br /><br />
<br /><br />
&lt;item&gt;UTF-8&lt;/item&gt; &lt;item&gt;&lt;/item&gt; &lt;/string-array&gt; 这 6 个&lt;item&gt;从上到下依次表示显示标签，关键字，搜索图标，搜索引擎地址，编码方式，搜 索提示地址。 b) 在 res/values/donottranslate-search_engines.xml &lt;resources xmlns:xliff=&quot;urn:oasis:names:tc:xliff:document:1.2&quot;&gt; &lt;string-array name=&quot;search_engines&quot; translatable=&quot;false&quot;&gt; &lt;item&gt;search139&lt;/item&gt; &lt;item&gt;baidu&lt;/item&gt; &lt;item&gt;google&lt;/item&gt; &lt;item&gt;yahoo&lt;/item&gt; &lt;item&gt;bing&lt;/item&gt; &lt;/string-array&gt; &lt;/resources&gt; 在这边将我们需要的 139 搜索引擎添加进来。这边添加的搜索引擎是将 1 中的添加的搜索引擎 变成设置中选择搜索引擎的选项。 4.7.26 修改 idle 界面搜索引擎的链接地址 修改 idle 界面搜索引擎的链接地址：quicksearchbox/res/values/strings.xml 下修改： www.google.com为www.google.com.hk 4.7.27 如何设置使用 Google 日历<br /><br />
<br /><br />
回答：日历的设置如下： 1. 2. 3. 4. 5. 首次进入日历，会提示输入用户名和密码，需输入 gmail 账户和密码。请 注意 apn 设为 cmnet 点击下一步，将会与服务器连接，进入服务器设置界面。 域名\用户名和密码不用更改。将服务器改为 m.google.com 下面的两个勾选都选中。点下一步即可。 新建活动需要同步日历，否则会提示没有日历。<br /><br />
<br /><br />
4.7.28 如何响应长按键 需要调用 startTracking() 才会开始检查是否长按 @Override<br /><br />
64<br /><br />
<br /><br />
public boolean onKeyDown(int keyCode, KeyEvent event) { if (keyCode == KeyEvent.KEYCODE_VOLUME_DOWN) { event.startTracking(); return true; } return super.onKeyDown(keyCode, event); } 4.7.29 Wifi 中新增的一些接口引发的 anr 处理 由于一些 wifi 新的需求，可能需要重新再定义一些接口和 Supplicant 交互。 比方说进入信任列表界面时调用了 WifiService 中 public boolean setTrustListPriority(String ssid,int priority){ return mWifiStateTracker.setTrustListPriority(ssid,priority); } 如果这样简单定义接口的话，在调用的时候有可能会出现 anr 其实是没有用 Handler 的异步处理造成的 anr 可以按照 WifiService 原来对 WifiStateTracker 调用本地方法的写法进行处理： private static final int MESSAGE_SET_TRUST_PRIORITY = 11; ........................ public boolean setTrustListPriority(String ssid,int priority){ //return mWifiStateTracker.setTrustListPriority(ssid,priority); enforceChangePermission(); if (mWifiHandler == null) return false; synchronized (mWifiHandler) { Message.obtain(mWifiHandler,MESSAGE_SET_TRUST_PRIORITY, priority, 0, ssid).sendToTarget(); } return true; } ............................ private class WifiHandler extends Handler { public WifiHandler(Looper looper) { super(looper); } @Override public void handleMessage(Message msg) { switch (msg.what) { ............... case MESSAGE_SET_TRUST_PRIORITY: mWifiStateTracker.setTrustListPriority((String)msg.obj,msg.arg1); break; ...............<br /><br />
65<br /><br />
<br /><br />
通过 Handler 处理以后就可以避免这样一些类似的 anr<br /><br />
<br /><br />
4.8 入库问题 4.8.1 PIM 入库测试时，同步后字段不匹配 [Tick0015155][Tick0015204] PIM的同步更新后，发现手机上和服务器侧的字段不匹配，例如手机上的昵称和QQ号码、群 组，同步后，对应服务器上的扩展字段；而并非对应服务器上的昵称及QQ号码、群组。 这出现的原因是：移动的PIM的数据服务器支持vcard2.1，而移动的网站却是针对vcard3.0 以及 一些自己的需求开发的，所以不支持一一对应。 在移动测试的时候，他们会建立一个手机完整的联系人，之后上传到服务器，删除本地联系 人，之后再从服务器上同步回来，只要保证内容不丢失即可。 基本原则是以手机上联系人字段为准，同时注意参数配置表中的“无对应”字段是不参与同步 的。 4.8.2 宽带互联网入库测试 25.7 中年月显示问题 [Tick0015312] 【操作步骤】1、输入网址：http://218.206.177.209:8080/waptest -&gt;Browser1.5JavaScript/DOM-TC7 【实际结果】测试页面显示“上方应该显示本月月历”，实际显示的是 112 年 3 月，星期和日期 也不对应 【分析结论】 该网页种JavaScript使用Date的getYear方法，这个函数返回的是 1900 到现在过去的 年，所以显示 112 是正常的，保存的网页在ie下没问题，在firefox和chrome都是显示 112， 这 和getYear的方法的实现有关系。 4.8.3 入库 UA 统一时设置注意点 User Agent 格式为一些若干“参数条目/参数条目属性”的组合，并以“空格”分开。参数条目见下 表： 表 5-13 参数条目 终端型号 操作系统 软件平台 Release User Agent 要求 可选 必选 可选 必选 必选 参数条目属性 终端型号版本 操作系统版本 软件平台版本 软件 Release 时间<br /><br />
66<br /><br />
<br /><br />
Browser Profile Configuration 其它条目<br /><br />
<br /><br />
浏览器版本 Profile 版本 Configuration 其它条目属性<br /><br />
<br /><br />
可选 必选 必选 可选<br /><br />
<br /><br />
参数条目顺序以上表为准。举例如下： User Agent：Nokia7650_CMCC/1.0 SymbianOS/7.0s Series60/2.0 Release/5.18.2003 Browser/OpenWave7.0 Profile/MIDP-1.0 Configuration/CLDC-1.0 User Agent 总长应不超过 256 个字符。 对于 UAProf 的要求： 终端可以通过静态设置的 URI，进行 UAProf 的初始设置。终端厂商必须保证出厂时嵌入的 URI 配置正确。终端能够将 UAProf 传送至网络侧： 8810 入库过程中，由于展讯 feature phone 我们都是建议客户 ua 使用 mmi_custom_define.h 中的 宏来定义：MMI_DEFAULT_UA 即可。 而 8810 的参考文档：ua 写入要分别写入：web User-Agent，和彩信 ua ，mbbms ua 和 PIM ua， 但如果客户想统一为使用一个 ua，如 XX 要求的 ua： xxx_yyy_TD/yyy_MocorDroid2.2_W11.41_V1.00 Threadx/4.0 Linux/2.6.32 Android/2.2 Release/11.29.2011 Browser/AppleWebKit533.1 Profile/MIDP-2.0 但此 ua，移动不认可，统一的 ua 必须加入 mbbms 的版本号信息，如：mbbms 2.0 字段，才可 入库。<br /><br />
<br /><br />
4.9 Android 开发经验 4.9.1 sqlite 多条数据操作如何提交效率 有个 CR 是说删除 1500 条短信超时，勾选全部信息，删除！≤17s ，删除实际时间大于 3 分钟。 android 使用的 sqlite 数据库是比较轻量级的数据库，在 Google 了之后发现，sqlite 事务处理的 问题，在 sqlite 插入数据的时候默认一条语句就是一个事务，有多少条数据就有多少次磁盘操 作。我的应用初始 5000 条记录也就是要 5000 次读写磁盘操作。如果一条操作要 10ms，5000 条就要 50s。 解决方案: 1.拼接 sql，把删除的 ID 通过 or 来拼接。但是 sqlite 对这个有限制，最多只能是 500 条。可以 通过每 500 条一处理来解决。 2.用关键字 in 没有限制，delete from table where id in(....)一条语句就可以了。 3.用事务，把处理写进事务中， 我们知道 Android 平台上使用的 sqlite 数据库是支持事务处理功能的，实现的代码如下：<br /><br />
67<br /><br />
<br /><br />
SQLiteDatabase db =mOpenHelper.getWritableDatabase(); db.beginTransaction();//开始事务 //进行 insertdelete update 等数据库操作 db.setTransactionSuccessful();//设置事务标记为 Successful db.endTransaction();//提交事务 可是，对于已经封装成 ContentProvider 的 Sqlite 我们应该如何让其支持事务处理功能呢？ 解 决 办 法 ： 查 看 ContentProvider 的 API 说 明 文 档 ， 我 们 惊 喜 地 发 现 applyBatch(String authority,ArrayList&lt;ContentProviderOperation&gt; operations) 这个方法，难道只需要直接使用这个方 法就可以实现事务了？ 谨慎起见我们先来看看 ContentProvider 的源码，最后追踪到这个方法： [java] view plaincopy public ContentProviderResult[]applyBatch(ArrayList&lt;ContentProviderOperation&gt; operations) throwsOperationApplicationException { final int numOperations = operations.size(); final ContentProviderResult[] results = newContentProviderResult[numOperations]; for (int i = 0; i &lt; numOperations; i++) {//遍历数据库操作序列 results[i] =operations.get(i).apply(this, results, i);//执行数据库操作 } return results;//返回结果 } 从上面的代码中，我们找不到和 db.beginTransaction()、db.endTransaction()相似的方法，也就是 说，这个方法只是进行简单的批处理，并没有保障这些数据库操作的原子性。 好吧。微动下脑筋，覆写 ContentProvider 的 applyBatch()方法，为其添加事务处理功能。代码 如下： @Override publicContentProviderResult[] applyBatch(ArrayList&lt;ContentProviderOperation&gt;operations) throwsOperationApplicationException{ SQLiteDatabasedb = mOpenHelper.getWritableDatabase(); db.beginTransaction();//开始事务 try{ ContentProviderResult[]results = super.applyBatch(operations); db.setTransactionSuccessful();//设置事务标记为 successful returnresults; }finally {<br /><br />
68<br /><br />
<br /><br />
db.endTransaction();//结束事务 } } 然后，我们该如何使用这个 applyBatch()方法呢？applyBatch()的第一个参数实现事务的 Provider 的 authority 属性，第二个参数是数据库操作序列，构建数据库操作的对象使用了 builder 设计模 式，下面是一个使用 applyBatch()的例子: ArrayList&lt;ContentProviderOperation&gt;ops = new ArrayList&lt;ContentProviderOperation&gt;(); ops.add(ContentProviderOperation.newDelete(Person.CONTENT_URI).build());// 添加一个删 除 Person 表的操作 ops.add(ContentProviderOperation.newInsert(Home.CONTENT_URI).withValues(values).build( ));//添加一条记录到 Home 表 getContentResolver().applyBatch(PROVIDER.AUTHORITY,ops);//处理事务 通过实验， 删除 5000 条只有 name，和 price 两个字段的数据。 一条一条删除需要 51s，一条一条添加需要 53s。 第 1 中方法删除用时 533ms，因为我写的是每 300 条一处理，所以有多次数据库操作。 第 2 中方法删除用时 172ms 用事务添加 5000 条用时 13s。 总结： 1.sqlite 支持事务处理操作 2.对于封装成 ContentProvider 的 sqlite 数据库，我们可以通过覆写 ContentProvider 的 applyBatch(Stringauthority, ArrayList&lt;ContentProviderOperation&gt; operations) 方法来实现对事务处 理的支持 3. 提交效率要尽可能减少数据库操作次数。 4.9.2 Android Layout_weight 的使用心得 在改 bug 当中，当一个 LinearLayout 中水平方向有几个子控件，如果一个控件的字符串内容太 长的话，会将其它的控件给挤出屏幕外，这个时候就可以通过 Layout_weight 来设置它们的显 示大小或者比例。 在 android 的 UI 布局中 Layout_weight 是使用非常广泛的一个属性，它代表的是 LinearLayout 中每个控件所占格外空间大小的划分，如果是在 LinearLayout 之间则是按照比例划分 .提取 android 源码中分配布局方法 android.widget.LinearLayout.measureHorizontal(int widthMeasureSpec, int heightMeasureSpec)中比较重要的代码简单分析如下： int delta = widthSize C mTotalLength; 和<br /><br />
69<br /><br />
<br /><br />
//格外空间大小 = 最大宽度 - 所有子空间的宽度<br /><br />
<br /><br />
if (delta != 0 &amp;&amp; totalWeight &gt; 0.0f) { //如果格外空间不为 0 并且有子控件的 layout_ weight 不为 0 float weightSum = mWeightSum &gt; 0.0f ? mWeightSum : totalWeight; /* 如 LinearLayout 设置了 weightsum 则覆盖 layout_ weight 的和*/ for (int i = 0; i &lt; count; ++i) { //遍历所有子控件 final View child = getVirtualChildAt(i); if (child == null || child.getVisibility() == View.GONE) {/*子控件为 null 或者 View.GONE 则不分配*/ continue; } final LinearLayout.LayoutParams lp = (LinearLayout.LayoutParams) child.getLayoutParams(); float childExtra = lp.weight; //获取子控件的 layout_ weight if (childExtra &gt; 0) { //获取子控件的 layout_ weight 大于 0 int share = (int) (childExtra * delta / weightSum); /*通过子控件占 weightSum 的 比例，获取子空间所占格外空间的大小*/ weightSum -= childExtra; delta -= share; int childWidth = child.getMeasuredWidth() + share;//子控件的最终宽度 if (childWidth &lt; 0) { childWidth = 0; } } } 总结 layout_weight 的使用如下： 1.LinearLayout 内部子控件之间的 layout_weight 是按照正比例分配空间。 2.LinearLayout 之间的 layout_weight 是按照反比例分配空间。 3.在 Horizontal 的 LinearLayout 中，控件 A 和控件 B 的 layout_weight 分别设置为 2 和 1，并不 代表两者的宽度之比为 2：1。控件的宽度等于空间本身需要的宽度，加上通过 layout_weight 设置分配到了父空间里的宽度。垂直方向的 LinearLayout 也同理。 4. 要 想 实 现 控 件 A 和 控 件 B 的 宽 度 严 格按 比例 显 示 ， 可 以 每个 控 件 之 上都 添 加 一 个 LinearLayout，在 LinearLayout 的属性里设置 layout_weight. 5.在 layout_width 设置为 fill_parent 的时候，layout_weight 所代表的是你的控件要优先尽可能的 大,但这个大是有限度的，即 fill_parent. 6.在 layout_width 设置为 wrap_content 的时候，layout_weight 所代表的是你的控件要优先尽可能<br /><br />
70<br /><br />
<br /><br />
的小,但这个小是有限度的，即 wrap_content. 4.9.3 Android 双缓冲机制 有时候会遇到一些与 UI 绘制相关比较难解的 bug，比如页面出现残影，闪屏等现象，如果去调 查 SurfaceFlinger，将是一个费力而漫长的过程。所以建议先尝试用双缓冲机制去试试。下面介 绍的是在 java 层去实现。 双缓冲原理： (一)为了防止动画闪烁而实现的一种多线程应用，主要原理：当一个动画争先显示时，程序 又在改变它，前面还没显示完，程序又请求重新绘制，屏幕就会不停闪 烁。为了避免闪烁， 可以使用双缓冲技术，将要处理的图片在内存中处理好之后，再将其显示到屏幕上。这样显示 出来是完整的图象，不会出现闪烁现象。 （二） 在内存中创建一个与屏幕绘图区域一致的对象，先将图形绘制到内存中的这个对象上， 再一次性将这个对象上的图形拷贝到屏幕上，这样能大大加快绘图的速度。双缓冲实现过程如 下： （1）在内存中创建与画布一致的缓冲区 （2）在缓冲区画图 （3）将缓冲区位图拷贝到当前画布上 （4）释放内存缓冲区 代码范例： package com.android.google.example; import android.content.Context; import android.graphics.Bitmap; import android.graphics.Canvas; import android.graphics.Paint; import android.graphics.Bitmap.Config; import android.graphics.drawable.BitmapDrawable; import android.view.KeyEvent; import android.view.MotionEvent; import android.view.View; public class GameView extends View implements Runnable { /* 声明 Bitmap 对象 */ Bitmap Paint mBitQQ = null; mPaint = null;<br /><br />
71<br /><br />
<br /><br />
/* 创建一个缓冲区 */ Bitmap mSCBitmap = null; /* 创建 Canvas 对象 */ Canvas mCanvas = null; public GameView(Context context) { super(context); /* 装载资源 */ mBitQQ = ((BitmapDrawable) getResources().getDrawable(R.drawable.qq)).getBitmap(); /* 创建屏幕大小的缓冲区 */ mSCBitmap=Bitmap.createBitmap(320, 480, Config.ARGB_8888); /* 创建 Canvas */ mCanvas = new Canvas(); /* 设置将内容绘制在 mSCBitmap 上 */ mCanvas.setBitmap(mSCBitmap); mPaint = new Paint(); /* 将 mBitQQ 绘制到 mSCBitmap 上 */ mCanvas.drawBitmap(mBitQQ, 0, 0, mPaint); /* 开启线程 */ new Thread(this).start(); } public void onDraw(Canvas canvas) { super.onDraw(canvas); /* 将 mSCBitmap 显示到屏幕上 */ canvas.drawBitmap(mSCBitmap, 0, 0, mPaint); } // 触笔事件 public boolean onTouchEvent(MotionEvent event) { return true; } // 按键按下事件 public boolean onKeyDown(int keyCode, KeyEvent event)<br /><br />
72<br /><br />
<br /><br />
{ return true; } // 按键弹起事件 public boolean onKeyUp(int keyCode, KeyEvent event) { return false; } public boolean onKeyMultiple(int keyCode, int repeatCount, KeyEvent event) { return true; } /** * 线程处理 */ public void run() { while (!Thread.currentThread().isInterrupted()) { try { Thread.sleep(100); } catch (InterruptedException e) { Thread.currentThread().interrupt(); } //使用 postInvalidate 可以直接在线程中更新界面 postInvalidate(); } } } 4.9.4 ANR 分析方法 一：什么是 ANR<br /><br />
73<br /><br />
<br /><br />
ANR:Application Not Responding，即应用无响应 二：ANR 的类型 ANR 一般有三种类型： 1：KeyDispatchTimeout(5 seconds) --主要类型 按键或触摸事件在特定时间内无响应 2：BroadcastTimeout(10 seconds) BroadcastReceiver 在特定时间内无法处理完成 3：ServiceTimeout(20 seconds) --小概率类型 Service 在特定的时间内无法处理完成 三：KeyDispatchTimeout Akey or touch event was not dispatched within the specified time（按键或触摸事件在特定时间内无 响应） 具体的超时时间的定义在 framework 下的 ActivityManagerService.java //How long we wait until we timeout on key dispatching. staticfinal int KEY_DISPATCHING_TIMEOUT = 5*1000 四：为什么会超时呢？ 超时时间的计数一般是从按键分发给 app 开始。超时的原因一般有两种： (1)当前的事件没有机会得到处理 （即 UI 线程正在处理前一个事件，没有及时的完成或者 looper 被某种原因阻塞住了） (2)当前的事件正在处理，但没有及时完成 五：如何避免 KeyDispatchTimeout 1：UI 线程尽量只做跟 UI 相关的工作 2：耗时的工作（比如数据库操作，I/O，连接网络或者别的有可能阻碍 UI 线程的操作）把它放 入单独的线程处理 3：尽量用 Handler 来处理 UIthread 和别的 thread 之间的交互 六：UI 线程 说了那么多的 UI 线程，那么哪些属于 UI 线程呢？ UI 线程主要包括如下： 1. Activity:onCreate(), onResume(), onDestroy(), onKeyDown(), onClick(),etc 2. AsyncTask: onPreExecute(), onProgressUpdate(), onPostExecute(), onCancel,etc 3. Mainthread handler: handleMessage(), post*(runnable r), etc 4. other 七:如何去分析 ANR 先看个 LOG:<br /><br />
74<br /><br />
<br /><br />
04-01 13:12:11.572 I/InputDispatcher( 220): Application is not responding:Window{2b263310com.android.email/com.android.email.activity.SplitScreenActivitypaused=false}. 5009.8ms since event, 5009.5ms since waitstarted 04-0113:12:11.572 I/WindowManager( 220): Input event dispatching timedout sending tocom.android.email/com.android.email.activity.SplitScreenActivity 04-01 13:12:14.123 I/Process( 220): Sending signal. PID: 21404 SIG: 3---发生 ANR 的时间和生成 trace.txt 的时间 04-01 13:12:14.123 I/dalvikvm(21404):threadid=4: reacting to signal 3 …… 04-0113:12:15.872 E/ActivityManager( 220): ANR in com.android.email(com.android.email/.activity.SplitScreenActivity) 04-0113:12:15.872 E/ActivityManager( 220): Reason:keyDispatchingTimedOut 04-0113:12:15.872 E/ActivityManager( 220): Load: 8.68 / 8.37 / 8.53 04-0113:12:15.872 E/ActivityManager( 220):CPUusage from 4361ms to 699ms ago 前的使用情况<br /><br />
<br /><br />
----CPU 在 ANR 发生<br /><br />
<br /><br />
04-0113:12:15.872 E/ActivityManager( 220): 5.5%21404/com.android.email: 1.3% user + 4.1% kernel / faults: 10 minor 04-0113:12:15.872 E/ActivityManager( 220): 4.3%220/system_server: 2.7% user + 1.5% kernel / faults: 11 minor 2 major 04-0113:12:15.872 E/ActivityManager( 220): 0.9%52/spi_qsd.0: 0% user + 0.9% kernel 04-0113:12:15.872 E/ActivityManager( 220): 0.5%65/irq/170-cyttsp-: 0% user + 0.5% kernel 04-0113:12:15.872 E/ActivityManager( 220): 0.5%296/com.android.systemui: 0.5% user + 0% kernel 04-0113:12:15.872 E/ActivityManager( 220): 100%TOTAL: 4.8% user + 7.6% kernel + 87% iowait 04-0113:12:15.872 E/ActivityManager( 220):CPUusage from 3697ms to 4223ms later:-- ANR 后 CPU 的使用 量 04-0113:12:15.872 E/ActivityManager( 220): 25%21404/com.android.email: 25% user + 0% kernel / faults: 191 minor 04-0113:12:15.872 E/ActivityManager( 220): 16% 21603/__eas(par.hakan: 16% user + 0% kernel 04-0113:12:15.872 E/ActivityManager( 220): 7.2% 21406/GC: 7.2% user + 0% kernel 04-0113:12:15.872 E/ActivityManager( 220): 1.8% 21409/Compiler: 1.8% user + 0% kernel 04-0113:12:15.872 E/ActivityManager( 220): 5.5%220/system_server: 0% user + 5.5% kernel / faults: 1 minor 04-0113:12:15.872 E/ActivityManager( 220): 5.5% 263/InputDispatcher: 0% user + 5.5% kernel 04-0113:12:15.872 E/ActivityManager( 220): 32%TOTAL: 28% user + 3.7% kernel<br /><br />
75<br /><br />
<br /><br />
从 LOG 可以看出 ANR 的类型，CPU 的使用情况，如果 CPU 使用量接近 100%，说明当前设备很忙，有 可能是 CPU 饥饿导致了 ANR 如果 CPU 使用量很少，说明主线程被 BLOCK 了 如果 IOwait 很高，说明 ANR 有可能是主线程在进行 I/O 操作造成的 除了看 LOG，解决 ANR 还得需要 trace.txt 文件， 如何获取呢？可以用如下命令获取 $chmod 777 /data/anr $rm /data/anr/traces.txt $ps $kill -3PID adbpull data/anr/traces.txt ./mytraces.txt 从 trace.txt 文件，看到最多的是如下的信息： -----pid 21404 at 2011-04-0113:12:14 ----Cmdline: com.android.email<br /><br />
<br /><br />
DALVIK THREADS: (mutexes: tll=0tsl=0 tscl=0 ghl=0 hwl=0 hwll=0) &quot;main&quot; prio=5 tid=1NATIVE | group=&quot;main&quot; sCount=1 dsCount=0obj=0x2aad2248 self=0xcf70 | sysTid=21404 nice=0 sched=0/0cgrp=[fopen-error:2] handle=1876218976 atandroid.os.MessageQueue.nativePollOnce(Native Method) atandroid.os.MessageQueue.next(MessageQueue.java:119) atandroid.os.Looper.loop(Looper.java:110) at android.app.ActivityThread.main(ActivityThread.java:3688) at java.lang.reflect.Method.invokeNative(Native Method) atjava.lang.reflect.Method.invoke(Method.java:507) atcom.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:866) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:624) at dalvik.system.NativeStart.main(Native Method) 说明主线程在等待下条消息进入消息队列<br /><br />
<br /><br />
八：Thread 状态 ThreadState (defined at “dalvik/vm/thread.h “) THREAD_UNDEFINED = -1, /* makes enum compatible with int32_t */ THREAD_ZOMBIE = 0, /* TERMINATED */<br /><br />
76<br /><br />
<br /><br />
THREAD_RUNNING = 1, /* RUNNABLE or running now */ THREAD_TIMED_WAIT = 2, /* TIMED_WAITING in Object.wait() */ THREAD_MONITOR = 3, /* BLOCKED on a monitor */ THREAD_WAIT = 4, /* WAITING in Object.wait() */ THREAD_INITIALIZING= 5, /* allocated, not yet running */ THREAD_STARTING = 6, /* started, not yet on thread list */ THREAD_NATIVE = 7, /* off in a JNI native method */ THREAD_VMWAIT = 8, /* waiting on a VM resource */ THREAD_SUSPENDED = 9, /* suspended, usually by GC or debugger */ 九：如何调查并解决 ANR 1：首先分析 log 2: 从 trace.txt 文件查看调用 stack. 3: 看代码 4：仔细查看 ANR 的成因（iowait?block?memoryleak?） 十：案例 案例 1：关键词:ContentResolver in AsyncTask onPostExecute, high iowait Process:com.android.email Activity:com.android.email/.activity.MessageView Subject:keyDispatchingTimedOut CPU usage from 2550ms to -2814ms ago: 5%187/system_server: 3.5% user + 1.4% kernel / faults: 86 minor 20major 4.4% 1134/com.android.email: 0.7% user + 3.7% kernel /faults: 38 minor 19 major 4% 372/com.android.eventstream: 0.7%user + 3.3% kernel / faults: 6 minor 1.1% 272/com.android.phone:0.9% user + 0.1% kernel / faults: 33 minor 0.9%252/com.android.systemui: 0.9% user + 0% kernel 0%409/com.android.eventstream.telephonyplugin: 0% user + 0% kernel /faults: 2 minor 0.1% 632/com.android.devicemonitor: 0.1% user + 0%kernel 100%TOTAL: 6.9% user + 8.2% kernel +84%iowait -----pid 1134 at 2010-12-17 17:46:51 ----Cmd line:com.android.email DALVIK THREADS: (mutexes: tll=0 tsl=0tscl=0 ghl=0 hwl=0 hwll=0) &quot;main&quot; prio=5 tid=1 WAIT |group=&quot;main&quot; sCount=1 dsCount=0 obj=0x2aaca180self=0xcf20 | sysTid=1134 nice=0 sched=0/0 cgrp=[fopen-error:2]handle=1876218976<br /><br />
77<br /><br />
<br /><br />
at java.lang.Object.wait(Native Method) -waiting on &lt;0x2aaca218&gt; (a java.lang.VMThread) atjava.lang.Thread.parkFor(Thread.java:1424) atjava.lang.LangAccessImpl.parkFor(LangAccessImpl.java:48) atsun.misc.Unsafe.park(Unsafe.java:337) atjava.util.concurrent.locks.LockSupport.park(LockSupport.java:157) atjava.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueue dSynchronizer.java:808) atjava.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchr onizer.java:841) atjava.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.ja va:1171) atjava.util.concurrent.locks.ReentrantLock$FairSync.lock(ReentrantLock.java:200) atjava.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:261) atandroid.database.sqlite.SQLiteDatabase.lock(SQLiteDatabase.java:378) atandroid.database.sqlite.SQLiteCursor.&lt;init&gt;(SQLiteCursor.java:222) atandroid.database.sqlite.SQLiteDirectCursorDriver.query(SQLiteDirectCursorDriver.java:53) atandroid.database.sqlite.SQLiteDatabase.rawQueryWithFactory(SQLiteDatabase.java:1356) atandroid.database.sqlite.SQLiteDatabase.queryWithFactory(SQLiteDatabase.java:1235) atandroid.database.sqlite.SQLiteDatabase.query(SQLiteDatabase.java:1189) atandroid.database.sqlite.SQLiteDatabase.query(SQLiteDatabase.java:1271) atcom.android.email.provider.EmailProvider.query(EmailProvider.java:1098) atandroid.content.ContentProvider$Transport.query(ContentProvider.java:187) atandroid.content.ContentResolver.query(ContentResolver.java:268) atcom.android.email.provider.EmailContent$Message.restoreMessageWithId(EmailContent.java: 648) atcom.android.email.Controller.setMessageRead(Controller.java:658) atcom.android.email.activity.MessageView.onMarkAsRead(MessageView.java:700) atcom.android.email.activity.MessageView.access$2500(MessageView.java:98) atcom.android.email.activity.MessageView$LoadBodyTask.onPostExecute(MessageView.java:12 90) atcom.android.email.activity.MessageView$LoadBodyTask.onPostExecute(MessageView.java:12 55) atandroid.os.AsyncTask.finish(AsyncTask.java:417) atandroid.os.AsyncTask.access$300(AsyncTask.java:127)<br /><br />
78<br /><br />
<br /><br />
atandroid.os.AsyncTask$InternalHandler.handleMessage(AsyncTask.java:429) atandroid.os.Handler.dispatchMessage(Handler.java:99) atandroid.os.Looper.loop(Looper.java:123) atandroid.app.ActivityThread.main(ActivityThread.java:3652) atjava.lang.reflect.Method.invokeNative(Native Method) atjava.lang.reflect.Method.invoke(Method.java:507) atcom.android.internal.os.ZygoteIn 原因：IOWait 很高，说明当前系统在忙于 I/O，因此数据库操作被阻塞 原来： finalMessagemessage=Message.restoreMessageWithId(mProviderContext,messageId); if(message==null){ return; } Accountaccount=Account.restoreAccountWithId(mProviderContext,message.mAccountKey); if(account==null){ return;//isMessagingController returns false for null, but let&#39;s make itclear. } if(isMessagingController(account)){ new Thread(){ @Override public void run(){ mLegacyController.processPendingActions(message.mAccountKey); } }.start(); } 解决后： newThread() { finalMessagemessage=Message.restoreMessageWithId(mProviderContext,messageId); if(message==null){ return; }<br /><br />
<br /><br />
79<br /><br />
<br /><br />
Accountaccount=Account.restoreAccountWithId(mProviderContext,message.mAccountKey); if(account==null){ return;//isMessagingController returns false for null, but let&#39;s make itclear. } if(isMessagingController(account)) { mLegacyController.processPendingActions(message.mAccountKey); } }.start(); 关于 AsyncTask:http://developer.android.com/reference/android/os/AsyncTask.html 案例 2：关键词:在 UI 线程进行网络数据的读写 ANRin process: com.android.mediascape:PhotoViewer (last incom.android.mediascape:PhotoViewer) Annotation:keyDispatchingTimedOut CPU usage: Load: 6.74 / 6.89 / 6.12 CPUusage from 8254ms to 3224ms ago: ovider.webmedia: 4% = 4% user +0% kernel / faults: 68 minor system_server: 2% = 1% user + 0%kernel / faults: 18 minor re-initialized&gt;: 0% = 0% user + 0%kernel / faults: 50 minor events/0: 0% = 0% user + 0%kernel TOTAL:7% = 6% user + 1% kernel DALVIKTHREADS: &quot;&quot;main&quot;&quot; prio=5 tid=3 NATIVE |group=&quot;&quot;main&quot;&quot; sCount=1 dsCount=0 s=Yobj=0x4001b240 self=0xbda8 | sysTid=2579 nice=0 sched=0/0cgrp=unknown handle=-1343993184 atorg.apache.harmony.luni.platform.OSNetworkSystem.receiveStreamImpl(NativeMethod) atorg.apache.harmony.luni.platform.OSNetworkSystem.receiveStream(OSNetworkSystem.java:4 78) atorg.apache.harmony.luni.net.PlainSocketImpl.read(PlainSocketImpl.java:565) atorg.apache.harmony.luni.net.SocketInputStream.read(SocketInputStream.java:87)<br /><br />
80<br /><br />
<br /><br />
atorg.apache.harmony.luni.internal.net.www.protocol.http.HttpURLConnection$LimitedInputStre am.read(HttpURLConnection.java:303) atjava.io.InputStream.read(InputStream.java:133) atjava.io.BufferedInputStream.fillbuf(BufferedInputStream.java:157) atjava.io.BufferedInputStream.read(BufferedInputStream.java:346) atandroid.graphics.BitmapFactory.nativeDecodeStream(Native Method) atandroid.graphics.BitmapFactory.decodeStream(BitmapFactory.java:459) atcom.android.mediascape.activity.PhotoViewerActivity.getPreviewImage(PhotoViewerActivity.j ava:4465) atcom.android.mediascape.activity.PhotoViewerActivity.dispPreview(PhotoViewerActivity.java: 4406) atcom.android.mediascape.activity.PhotoViewerActivity.access$6500(PhotoViewerActivity.java: 125) atcom.android.mediascape.activity.PhotoViewerActivity$33$1.run(PhotoViewerActivity.java:455 8) atandroid.os.Handler.handleCallback(Handler.java:587) atandroid.os.Handler.dispatchMessage(Handler.java:92) atandroid.os.Looper.loop(Looper.java:123) atandroid.app.ActivityThread.main(ActivityThread.java:4370) atjava.lang.reflect.Method.invokeNative(Native Method) atjava.lang.reflect.Method.invoke(Method.java:521) atcom.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:868) atcom.android.internal.os.ZygoteInit.main(ZygoteInit.java:626) atdalvik.system.NativeStart.main(Native Method) 关于网络连接，在设计的时候可以设置个 timeout 的时间或者放入独立的线程来处理。 关于 Handler 的问题，可以参考：http://developer.android.com/reference/android/os/Handler.html 案例 3： 关键词：Memoryleak/Thread leak 11-1621:41:42.560 I/ActivityManager( 1190): ANR in process:android.process.acore (last in android.process.acore) 11-1621:41:42.560 I/ActivityManager( 1190): Annotation:keyDispatchingTimedOut 11-16 21:41:42.560 I/ActivityManager(1190): CPU usage: 11-16 21:41:42.560 I/ActivityManager( 1190):Load: 11.5 / 11.1 / 11.09 11-16 21:41:42.560 I/ActivityManager(1190): CPU usage from 9046ms to 4018ms ago: 11-16 21:41:42.560I/ActivityManager( 1190): d.process.acore:98%= 97% user + 0% kernel /<br /><br />
81<br /><br />
<br /><br />
faults: 1134 minor 11-16 21:41:42.560I/ActivityManager( 1190): system_server: 0% = 0% user + 0% kernel /faults: 1 minor 11-16 21:41:42.560 I/ActivityManager( 1190): adbd:0% = 0% user + 0% kernel 11-16 21:41:42.560 I/ActivityManager(1190): logcat: 0% = 0% user + 0% kernel 11-16 21:41:42.560I/ActivityManager( 1190): TOTAL:100% = 98% user + 1% kernel Cmdline: android.process.acore DALVIK THREADS: &quot;main&quot;prio=5 tid=3 VMWAIT |group=&quot;main&quot; sCount=1 dsCount=0 s=N obj=0x40026240self=0xbda8 | sysTid=1815 nice=0 sched=0/0 cgrp=unknownhandle=-1344001376 atdalvik.system.VMRuntime.trackExternalAllocation(NativeMethod) atandroid.graphics.Bitmap.nativeCreate(Native Method) atandroid.graphics.Bitmap.createBitmap(Bitmap.java:468) atandroid.view.View.buildDrawingCache(View.java:6324) atandroid.view.View.getDrawingCache(View.java:6178) atandroid.view.ViewGroup.drawChild(ViewGroup.java:1541) …… atcom.android.internal.policy.impl.PhoneWindow$DecorView.draw(PhoneWindow.java:1830) atandroid.view.ViewRoot.draw(ViewRoot.java:1349) atandroid.view.ViewRoot.performTraversals(ViewRoot.java:1114) atandroid.view.ViewRoot.handleMessage(ViewRoot.java:1633) atandroid.os.Handler.dispatchMessage(Handler.java:99) atandroid.os.Looper.loop(Looper.java:123) atandroid.app.ActivityThread.main(ActivityThread.java:4370) atjava.lang.reflect.Method.invokeNative(Native Method) atjava.lang.reflect.Method.invoke(Method.java:521) atcom.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:868) atcom.android.internal.os.ZygoteInit.main(ZygoteInit.java:626) atdalvik.system.NativeStart.main(Native Method) &quot;Thread-408&quot;prio=5 tid=329 WAIT |group=&quot;main&quot; sCount=1 dsCount=0 s=N obj=0x46910d40self=0xcd0548 | sysTid=10602 nice=0 sched=0/0 cgrp=unknownhandle=15470792 at java.lang.Object.wait(Native Method) -waiting on &lt;0x468cd420&gt; (a java.lang.Object)<br /><br />
82<br /><br />
<br /><br />
atjava.lang.Object.wait(Object.java:288) atcom.android.dialer.CallLogContentHelper$UiUpdaterExecutor$1.run(CallLogContentHelper.ja va:289) atjava.lang.Thread.run(Thread.java:1096) 分析： atdalvik.system.VMRuntime.trackExternalAllocation(NativeMethod) 内 存 不足 导致 block 在 创 建 bitmap 上 **MEMINFO in pid 1360 [android.process.acore] ** native dalvik other total size: 17036 23111 N/A 40147 allocated: 16484 20675 N/A 37159 free: 296 2436 N/A 2732 解决：如果机器的内存簇， 可以修改虚拟机的内存为 36M 或更大，不过最好是复查代码，查看 哪些内存没有释放 4.9.5 PhoneServer 中的多线程操作 PhoneServer 一般对于每一个 PTY 设备都会有一个发送线程，负责从 PTY 通道中读取 AT 命令， 并发送到指定的 MUX 通道去。对于每一个 MUX 通道都会有一个读取线程，负责从 MUX 通道 读取回复，并写到对应的 PTY 通道里去。 这里自然就有线程间的互斥等问题。发送线程当从 PTY 读取到 AT 命令后，会进行 mux 的 write 操作： int adapter_cmux_write(cmux_t * mux, char *buf, int len, int to) { …… pthread_mutex_lock(&amp;mux-&gt;mutex_timeout); …… pthread_cond_timedwait(&amp;mux-&gt;cond_timeout, &amp;mux-&gt;mutex_timeout,&amp;timeout); …… pthread_mutex_lock(&amp;mux-&gt;mutex_timeout); } 在我们读取线程从 MUX 读取到回复后，会进行 MUX 的 free 操作：这里 cmux_t 与 adapter_cmux_write 中的 cmux_t 为同一路 MUX。 void adapter_free_cmux(cmux_t * mux) { ……<br /><br />
83<br /><br />
<br /><br />
pthread_mutex_lock(&amp;mux-&gt;mutex_timeout); …… pthread_cond_signal(&amp;mux-&gt;cond_timeout; …… pthread_mutex_lock(&amp;mux-&gt;mutex_timeout); } pthread_cond_timedwait 的操作为对 mux-&gt;mutex_timeout 解锁以及对 mux-&gt;cond_timeout 的等 待。该操作时原子操作。Pthread_cond_timedwait 以及 pthread_cond_signel 要在 mutex_lock 与 mutex_unlock 之间调用，这样可以保证 pthread_cond_timedwait 返回时可以重新获取对 mutex 的 锁定。 当 读 取 线 程 没 有 收 到 回 复 ， 没 有 满 足 cond 条 件 的 时 间 超 过 了 我 们 设 置 的 超 时 时 间 ， pthread_cond_timedwait 也会返回，并且返回值为 ETIMEOUT。 Pthread_cond_timedwait 的另外一种方法。 [情景描述]：有一线程 A，循环的在做某一件事，每做完一件事后会睡上 10s。我们想在某一状 态时退出线程。 [常用的方法]：我们会在线程 A 中的循环中加一个 FLAG 的判断，若 FLAG 为 TRUE 我们就继 续，而当 FLAG 为 FALSE 我们则退出。 [存在的问题]：假设我们设置 FLAG 的时候，线程 A 的一件事才刚刚开始。这样我们就需要等 上至少 10 秒的时间才会使线程 A 正常退出。当然，也可以直接 terminate 掉线程 A，但这样会 存在一些未知问题，程序也不够优雅。 [timedwait 的用法]： pthread_t thread; pthread_cond_t cond; pthread_mutex_t mutex; bool flag = true; void *thread_A(void * arg) { struct timeval now; struct timespec outtime; pthread_mutex_lock(&amp;mutex); while (flag) { printf(“.\n”); gettimeofday(&amp;now, NULL); outtime.tv_sec = now.tv_sec + 10;<br /><br />
84<br /><br />
<br /><br />
outtime.tv_nsec = now.tv_usec * 1000; pthread_cond_timedwait(&amp;cond, &amp;mutex, &amp;outtime); } pthread_mutex_unlock(&amp;mutex); printf(“thread exit\n”); } int main() { pthread_mutex_init(&amp;mutex, NULL); pthread_cond_init(&amp;cond, NULL); if (0 != pthread_create(&amp;thread, NULL, thr_fn, NULL)) { printf(“error when create pthread,%d \n”, errno); return 1; } char c ; while ((c = getchar()) != ‘q’); printf(“Now terminate the thread!\n”); flag = false; pthread_mutex_lock(&amp;mutex); pthread_cond_signal(&amp;cond); pthread_mutex_unlock(&amp;mutex); printf(“Wait for thread to exit\n”); pthread_join(thread, NULL); printf(“Bye\n”); return 0; } pthread_cond_signal 会使 pthread_cond_timedwait 马上返回，从而达到使线程 A 退出的目的。 4.9.6 android 的 SAFE MODE android 系统，按住 MENU 键开机，会安全模式进入系统。<br /><br />
<br /><br />
85<br /><br />
<br /><br />
什么是安全模式呢？ 在安全模式下只执行 android 的核心进程， 可以用来处理第三方程序引起的系统异常或者用 来卸载在正常模式下无法卸载的应用。 需要注意退出安全模式之后，第三方的 widget 可能不能正确显示在主屏幕上，这时候需要删 除重新添加来解决加载 widget 错误 在安全模式下，第三方应用也不会出现在 launcher 中，只 能进入 Setting -&gt; Applications -&gt; Manage Applications 才能看到他们，并卸载。 总的来说 safe mode 就是一个测试模式，用来删除那些可能导致系统出错或者崩溃的 3rd APK。他这个区别 3rd APK 和 core process 应该是根据打在 APK 上的 key 来决定的（不确定,没测试过），APK 在 安 装 的 时 候 会 被 打 上 各 种 类型的 KEY ， 具 体 参 照 build/target/product/security ； KEY 是根据 makefile 的 LOCAL_CERTIFICATE 来设定的。 进入代码为 frameworks/base/policy/src/com/android/internal/policy/impl/PhoneWindowManager.java<br /><br />
<br /><br />
86<br /><br />
<br /><br />
第5章 送测修改<br /><br />
5.1 如何修改 DM 信息？<br /><br />
SC8810： 进入 extern/sprd/dm/src/com/spreadtrum/dm 编辑 DmService.java 在 initParam 函数中，直接修改下面代码的厂家，型号和软件版本为需要的版本。 （a) debugmode init manufacture mManufactory = sharedPreferences.getString(ITEM_MANUFACTORY, &quot;厂家名字 字符串&quot;); init model mModel = sharedPreferences.getString(ITEM_MODEL, &quot;手机型号字符串&quot;); mSoftVer = sharedPreferences.getString(ITEM_SOFTVER, &quot;软件版本字符串&quot;); (B)非 debugmode mManufactory = sharedPreferences.getString(ITEM_MANUFACTORY, &quot;厂家名字字符串&quot;); mModel = sharedPreferences.getString(ITEM_MODEL, &quot;手机型号字符串&quot;); mSoftVer = SystemProperties.get(&quot;ro.hisense.software.version&quot;,&quot;软件版本字符串&quot;);<br /><br />
<br /><br />
送测有带 AGPS 功能的，请注意，如果带有该功能的话，DM 配置表是需要增加 AGPS 有关参 数的。<br /><br />
<br /><br />
5.2 DM 入库 case3.4 关于 pim 参数的采集问题<br /><br />
<br /><br />
如果是 PIM 客户端，不执行 PIM 相关采集和配置 如果不是客户端（即 PIM 是自研发），执行 PIM 相关采集和配置<br /><br />
5.3 关于默认 DM 地址的问题，我们版本目前是否是实验室地址？ 集采项目送测机器是现网地址，导致整个模块无法测试。一定要改为实验室地址。<br /><br />
<br /><br />
5.4 如何修改 web User-Agent？<br /><br />
8810：packages\apps\Browser\src\com\android\browser\Browser.java 里的方法： public String getCMUserAgentString() 会组装一个 UA，比如： User-Agent: sprd-SPHS-on-Hsdroid/1.0 Linux/2.6.35.7 Android/2.3.5 Release/02.16.2012 Browser/AppleWebKit533.1 Mozilla/5.0<br /><br />
<br /><br />
5.5 如何修改客户服务信息？<br /><br />
修改手机服务指南内容包括中文和英文<br /><br />
87<br /><br />
<br /><br />
packages\apps\Customerservice\res\values-zh-rC\strings.xml &lt;string name=&quot;servicenumber&quot;&gt;xxxx 公 司 的 售 后 服 务 热 线 为 ： 0755xxxx \n 网 址 为 ： http://www.xxxx.com&lt;/string&gt; packages\apps\Customerservice\res\values\strings.xml &lt;string name=&quot;servicenumber&quot;&gt;Service Hotline: 0755xxxx \nHomepage: http://www.xx.com&lt;/string&gt;<br /><br />
<br /><br />
5.6 8810 MBBMS 入库送测版本注意事项？<br /><br />
先通过暗码*#*#83784#*#* 查看有没有 CMMB settings,如果有就不需要按下面的方式修改，只需对 实验室和射频测试的手机打开 CMMB settings 下的设置项。如果没有此菜单，则要按下面的两种方 式之一操作制作版本 1）CMMB 的 property 初始化，以 sp8805ga 为例： 编辑 3rdparty/products/sp8805ga/init.sp8805ga.3rdparty.rc 内置 mbbms 的 UA， 测试模式和射频测试模式为正常模式。 setprop ro.hisense.cmcc.test 0 setprop ro.hisense.cmcc.test.cmmb.wire 0 setprop ro.mbbms.ua 4G_W4-mocorsmart11.31-mbbms2 2）实验室接口测试和射频测试。 通过 adb 设置 ro.hisense.cmcc.test 和 ro.hisense.cmcc.test.cmmb.wire 为 1 adb shell setprop ro.hisense.cmcc.test.cmmb.wire 1 setprop ro.hisense.cmcc.test 1 或者： 入库送测版本分为现网、实验室和射频测试的手机请分别编译为不同的版本。 编辑 3rdparty/products/sp8805ga$ vi init.sp8805ga.3rdparty.rc 内置 mbbms 的 UA， 缺省测试模式和射频测试模式为正常模式。 修改 3rdparty/products/sp8805ga/init.sp8805ga.3rdparty.rc ，然后编译产生需要的版本。 1: 现网版本 （缺省） setprop ro.hisense.cmcc.test 0 setprop ro.hisense.cmcc.test.cmmb.wire 0 setprop ro.mbbms.ua 4G_W4-mocorsmart11.31-mbbms2 2:实验室版本 如果 setprop ro.hisense.cmcc.test.cmmb.wire 设置为 1， 可能导致 CMMB 模式搜索更多的频道。 setprop ro.hisense.cmcc.test 1 setprop ro.hisense.cmcc.test.cmmb.wire 0 setprop ro.mbbms.ua 4G_W4-mocorsmart11.31-mbbms2 3：射频版本 setprop ro.hisense.cmcc.test 1 setprop ro.hisense.cmcc.test.cmmb.wire 1 setprop ro.mbbms.ua 4G_W4-mocorsmart11.31-mbbms2<br /><br />
<br /><br />
88<br /><br />
<br /><br />
5.7 8810 WLAN 测试注意事项<br /><br />
WLAN 吞吐量的测试方法： 在 PC 端和手机端分别安装 IPERF 软件，通过 cmd 命令在 iperf 窗口观察测试结果。 下行： 1、重启手机 2、手机端执行：iperf Cs 3、PC 端执行:iperf -c 手机端 IP 地址 4、PC 端可以观测到下行速率 上行与之相反即可在 PC 端可以观测到上行速率。 2、WLAN 综测准备工作 将手机屏幕背光时间设置 30 分钟（或者更长）； 芯片默认功率为最大，不需要另行设置； 关闭 WIFI 漫游、关闭 WLAN 芯片省电模式方法：输入工程指令*#*#83780#*#*---Wifi CMCC Test， 勾选测试模式为开启之后再进行测试。注意，在不同速率之间进行切换的时候，需要在终端侧手动 断开已经建立好的连接，重新连接一次之后才可以继续测试。 3、抓取数据包测试： 使用 log 工具 ATT，PC 与终端建立好连接之后，点击开启 TCP Dump（如下图红色标记），即可在指 定的目录下找到生成的 cap 文件，通过 wireshark 等工具打开该文件即可查找到相关的内容。 新版本的Wifi CMCC Test目前有三个选项，WLAN测试步骤如下： Wifi CMCC Test有三项： Anritsu Test(安立仪表初始化) Non-Anritsu Test (非安立仪表（如LitePoint仪表）初始化) Run Test(使手机处于测试状态) 对应Litepoint的仪表，操作如下： 将手机屏幕背光时间设置 30 分钟（或者更长）； 确保wifi处于关闭状态 在拨号界面输入*#*#83780#*#* 进入菜单，点击 Wifi CMCC Test ，选中Non-Antitsu Test复 选框 进入“wifi设置”菜单，连接仪表所对应的AP. 在拨号界面输入*#*#83780#*#* 进入菜单，点击 Wifi CMCC Test ，点击 Run Test（请确保此 时以及之后的测试过程中停留在此界面，并且不要退出）<br /><br />
<br /><br />
5.8 8810 CSR WIFI 测试事项<br /><br />
CSR WIFI 的射频测试需要区分仪器。 1、Litepoint 这是泰尔采用的仪器，在这台仪器上测试射频之前要通过在 adb 下运行指令 iwconfig wlan0 power off 2、Anritsu 这是移动研究院采用的仪器，在这台仪器上测试射频之前要运行 Anritsu_init.sh 脚本进入 Anritsu 测试模式。 目前我们工程模式仅实现了功能 2，也就是Anritsu的测试模式，该工程模式在litepoint上测试无 效。同时，但是我们版本里面的Anritsu_init.sh脚本只适用于 6027 b07，而不适用于 6027 a05， 即用a05 的机器执行Anritsu_init.sh脚本会出现执行失败。一般情况下，我们不建议客户使用a05 芯片。<br /><br />
<br /><br />
89<br /><br />
<br /><br />
5.9 测试某些卡时不能上网<br /><br />
实验室的 SIM 卡有的插在 8805 手机上显示的 APN 有默认的几个（CMCCMMS,CMCCWAP 等），有些卡插 上是没有这些默认的 APN 的。在设置时候需要做的是：有默认的 APN 的需要在默认的 APN 上做修改， 建议修改 CMCCMMS，改成实验室网的参数，新建的 APN 的话有可能会用不了，没有默认的 APN 的话需 要新建 APN。 这个情况需要提醒客户注意。<br /><br />
<br /><br />
5.10 什么是 CTS? Android 的 CTS 测试，英文为 Compatibility Test Suite，意为兼容性测试。 只有通过 CTS 测试的设备才有可能获得 Android 的商标和享受 Android Market 的权限。 5.11 如何进行 android cts 测试? 1. http://source.android.com/compatibility/downloads.html 下载测试包 Android 4.0.3 R3 Compatibility Test Suite (CTS)并解压 2. 通过 USB 链接手机 3. chomd 777 ctc-tradefed 更该权限，并执行该脚本。 cd android-cts/tools ./cts-tradefed 出现 cts-tf &gt; 4. 执行相关命令 Run: run cts --plan test_plan_name: run a test plan run cts --package/-p : run a CTS test package run cts --class/-c [--method/-m] : run a specific test class and/ormethod run cts --continue-session session_ID: run all not executed tests from a previous CTS session run cts [options] --serial/s device_ID: run CTS on specified device run cts [options] --shards number_of_shards: shard a CTS run into given number of independent chunks, to run on multiple devices inparallel run cts --help/--help-all: get more help on running CTS<br /><br />
90<br /><br />
<br /><br />
List: l/list d/devices: list connected devices and their state l/list packages: list CTS test packages l/list p/plans: list CTS test plans l/list i/invocations: list invocations aka CTS test runs currentlyin progress l/list c/commands: list commands: aka CTS test run commands currently in the queue wai 5. 查看测试报告和 LOG 测试报告在 android-cts/repository/results/目录下以时间命名 测试 LOG 在 android-cts/repository/logs/目录下以时间命名 6. 提交测试报告 测试结果发送给 cts@android.com 7. 注意事项 a) 下载 SDK 到机器上。 b) 你要测试的设备应该运行的是一个 user build。 c) 参考这个链接（http://developer.android.com/guide/developing/device.html）来设置一下你的设 备。 d) 运行 CTS 之前，确保你的设备已经烧入了一个 user build e) 在运行 CTS 测试之前还需要通过 Settings-&gt;Speech Synthesis-&gt;Install voice data 来下载 TTS 文 件。如果没有安装 Android Market 的话，需要手动安装。 f) 建议你使用一个专门用来测试的 Google 账户来登录设备。 g) 确保设备有一个 SD 卡，并且 SD 卡是空的。因为 CTS 可能修改／删除 SD 卡上的数据。 h) 在设备上做一次恢复出厂设置（Settings-&gt;SD Card &amp; phone Storage-&gt;Factory data reset）。注 意：这会删除设备上的所有用户数据。 i) 确保设备没有处在任何 lock pattern 之下（取消 Settings-&gt;Security&amp;location-&gt;Require Pattern 这 个选项） j) 确保“Screen Timeout”被设置为“Never Timeout”（Settings-&gt;Sound&amp;Display-&gt;Screen Timeout 应 该被设置为“Never Timeout”）<br /><br />
<br /><br />
91<br /><br />
<br /><br />
k) 确保“Stay Awake”被选中（Settings-&gt;Applications-&gt;Development-&gt;Stay awake） l) 确保 Settings-&gt;Application-&gt;Development-&gt;Allow mock locations 被设置为 true。 m) 在运行 CTS 时，设备停留在桌面上。 n) 当设置正在进行测试时，绝不能执行其它任务。 o) CTS 运行时不要按任何键或触摸屏幕。<br /><br />
<br /><br />
5.12 CTS 测试事项<br /><br />
CTS测试是google 为android market 考虑的，用以确保手机能使用google android market 上的应 用。 http://source.android.com/compatibility/cts-intro.html Google 定义了一个兼容性规范（Compatibility Definition）， 而 CTS 就是用于确保某个测试符 合该规范。 从而基于 Android 的应用程序能够在基于同一 API 版本的各种设备上运行。在进行测 试之前，要确保设备连接上，在out/host/linux-x86/bin/ 下面有adb。 使用普通用户，将会提示没有权限，我们使用sudo. 例如： apuser@pc:~/sprdroid/out/host/linux-x86/bin$ adb kill-server apuser@pc:~/sprdroid/out/host/linux-x86/bin$ sudo adb root daemon not running. starting it now * daemon started successfully * adbd is already running as root 执行： apuser@pc:~/android-cts/tools/$ sudo ./startcts 出现 Android CTS version 2.2_r7 Device(19761202) connected cts_host &gt; cts_host &gt; 则表示连接正常可以选择测试计划了！ 执行所有的测项： start --plan CTS 执行某个测项： start --plan CTS -t [CTS_test_name] 例出所有timeout的测项： ls -r timeout -s [session ID] 例出所有fail的测项： ls -r fail -s [session ID] 测试好后，通过输入如下命令来查看测试情况 cts_host &gt; ls -r CTS测试会自动生成相应的测试包，该包位于如下目录： #~/android-cts/repository/results 每个测试包中包含了如下文件; cts_result.css cts_result.xsl logo.gif<br /><br />
92<br /><br />
<br /><br />
newrule-green.png testResult.xml 该包的测试情况都在testResult.xml 文件中，通过查看该文件可以知道，哪些是和Android兼容 的。<br /><br />
<br /><br />
5.13 Monkey 测试事项<br /><br />
这里给出Google的标准参考网页： http://developer.android.com/guide/developing/tools/monkey.html 一、 什么是Monkey Monkey是Android中的一个命令行工具，可以运行在模拟器里或实际设备中。它向系统发送伪随机 的用户事件流(如按键输入、触摸屏输入、手势输入等)，实现对正在开发的应用程序进行压力测 试。Monkey测试是一种为了测试软件的稳定性、健壮性的快速有效的方法。 二、 Monkey的特征 1、测试的对象仅为应用程序包，有一定的局限性。 2、 Monky测试使用的事件流数据流是随机的，不能进行自定义。 3、可对MonkeyTest的对象，事件数量，类型，频率等进行设置。 三、Monkey的基本用法 基本语法如下： $ adb shell monkey [options] 如果不指定options，Monkey将以无反馈模式启动，并把事件任意发送到安装在目标环境中的全部 包。下面是一个更为典型的命令行示例，它启动指定的应用程序，并向其发送 500 个伪随机事件： $ adb shell monkey -p your.package.name -v 500 四、Monkey测试的一个实例 通过这个实例，我们能理解Monkey测试的步骤以及如何知道哪些应用程序能够用Monkey进行测试。 Windows下（注：2―4 步是为了查看我们可以测试哪些应用程序包，可省略）： 1、 通过eclipse启动一个Android的emulator 2、 在命令行中输入：adb devices查看设备连接情况 C:\Documents and Settings\Administrator&gt;adb devices List of devices attached emulator-5554 device 3、 在有设备连接的前提下，在命令行中输入：adb shell 进入shell界面 C:\Documents and Settings\Administrator&gt;adb shell # 4、 查看data/data文件夹下的应用程序包。注：我们能测试的应用程序包都在这个目录下面 C:\Documents and Settings\Administrator&gt;adb shell # ls data/data ls data/data com.google.android.btrouter com.android.providers.telephony com.android.mms … 5、 以com.android.calculator2 作为对象进行MonkeyTest #monkey -p com.android.calculator2 -v 500 其中-p表示对象包 Cv 表示事件数量 运行过程中，Emulator中的应用程序在不断地切换画面。<br /><br />
93<br /><br />
<br /><br />
按照选定的不同级别的反馈信息，在Monkey中还可以看到其执行过程报告和生成的事件。 注：具体参数的设定可参考： http://developer.android.com/guide/developing/tools/monkey.html 五、关于Monkey测试的停止条件 Monkey Test执行过程中在下列三种情况下会自动停止： 1、如果限定了Monkey运行在一个或几个特定的包上，那么它会监测试图转到其它包的操作，并对 其进行阻止。 2、如果应用程序崩溃或接收到任何失控异常，Monkey将停止并报错。 3、如果应用程序产生了应用程序不响应(application not responding)的错误，Monkey将会停止并 报错。 通过多次并且不同设定下的Monkey测试才算它是一个稳定性足够的程序。<br /><br />
<br /><br />
5.14 8810 开机进入工厂模式，进行各外设测试，包括 LCD/TP/key，蓝牙等测试<br /><br />
进入Factory test：将手机处于关机状态，按增大音量键 + power键开机，进入Factory test模式， 按音量键选择 item test, 按power key进入，选择 Bluetooth test进入，选择 bt EUT，进行蓝牙 测试。 进入工程模式的按键可以在uboot里面配置，见 4.11 小节。 代码位置在external/sprd/engineeringmodel/engtest目录，可根据实际情况调整测试项目。<br /><br />
<br /><br />
5.15 MTBF 测试 平均无故障时间，英文全称是“Mean Time Between Failures”。是衡量一个产品（尤其是电器产 品）的可靠性指标。单位为“小时”。它反映了产品的时间质量，是体现产品在规定时间内保持功 能的一种能力。具体来说，是指相邻两次故障之间的平均工作时间，也称为平均故障间隔。 使用MTC工具正确配置Device类型为Android后，并且选择abd口作为通信port后即可以测试。其实 现机制较为简单，无需UE侧的改动。需要PC侧的脚本支持。[后续还会更新！]<br /><br />
<br /><br />
5.16 SC8810 如何修改彩信 UA 和 UA Profile？<br /><br />
[Tick0014298]UA字段和UAProf字段在如下文件中配置： &quot;packages/apps/Mms/res/xml/mms_config.xml&quot; &lt;string name=&quot;userAgent&quot;&gt;Android-Mms/0.1&lt;/string&gt; &lt;string name=&quot;uaProfTagName&quot;&gt;x-wap-profile&lt;/string&gt; 目前缺省值为： UA：&quot;Android-Mms/2.0&quot; UAProf：http://www.spreadtrum.com/wap/8810G_UAProfile.xml [Note]mms_config.xml是彩信的默认参数的配置文件，其他参数也可以根据需要修改。<br /><br />
<br /><br />
5.17 cts 去除 gps 功能 frameworks/base/data/etc/Android.mk 里面去掉<br /><br />
frameworks/base/data/etc/android.hardware.location.gps.xml:system/etc/permissions/android.hardware.location<br /><br />
<br /><br />
94<br /><br />
<br /><br />
5.18 8810 DM 送入库时客户常遇到的问题<br /><br />
<br /><br />
1. 入库时需提交的表格<br /><br />
<br /><br />
此表格仅需修改《DM 支持的业务功能.xlsx》中的厂家和型号名称两项，其他均可通用。 此表格为实验网配置，必须等厂家提交移动服务器成功后方可开始测试。 2. 手机端 DM 密码“#*4560#”<br /><br />
<br /><br />
3. 自注册不成功 a) 首先在服务器端查看“历史配对查询”，如资料未提交成功会显示“型号未注册”，如下图。<br /><br />
<br /><br />
b) 如客户确认已提交，需要确认手机端的厂商，型号名是否正确. 某些厂商会在提交的表格中填写的型号名称前面加上厂商名，如 K-Touch T800 而非表格中填写 的 T800，另外，还需要注意大小写是否正确。<br /><br />
95<br /><br />
<br /><br />
c) 在手机端确认是否自注册成功 #*4560#-&gt;DM 状态-&gt;SelfReg State 看是 false 还是 true d) Log 中确认无法自注册问题 下面是一个完整发送自注册短信的并成功的 log，在这里首先要确认一下各项参数都是否完 整。最后再自注册信息是否发送“setIsHaveSendSelfRegMsg: to true” 自注册是否成功”<br /><br />
setSelfRegState: to true” 05-29 15:45:59.077 1542 05-29 15:45:59.077 1542 05-29 15:45:59.077 1542 05-29 15:45:59.077 1542 05-29 15:45:59.077 1542 05-29 15:45:59.077 1542 05-29 15:45:59.077 1542 05-29 15:45:59.077 1542 05-29 15:45:59.077 1542 05-29 15:45:59.077 1542 05-29 15:45:59.077 1542 …… 05-29 15:45:59.087 1542 05-29 15:45:59.087 1542 05-29 15:45:59.087 1353 05-29 15:45:59.087 1353 05-29 15:45:59.087 1542 ….. 05-30 16:19:48.105 1935 05-30 16:19:48.105 1935 05-30 16:19:48.105 1935 05-30 16:19:48.115 1624 05-30 16:19:48.115 1624 05-30 16:19:48.115 1624 05-30 16:19:48.115 1624 05-30 16:19:48.115 1624 05-30 16:19:48.115 1624 05-30 16:19:48.115 1624 05-30 16:19:48.115 1624 05-30 16:19:48.115 1624 05-30 16:19:48.115 1624 05-30 16:19:48.115 1624 05-30 16:19:48.115 1624 05-30 16:19:48.115 1624 05-30 16:19:48.135 1624 05-30 16:19:48.185 1624 05-30 16:19:48.185 1624 05-30 16:19:48.185 1624 1542 D DM ==&gt; DmDebugMenu: : mItemClickListenter : position = 2 1542 D DM ==&gt; DmService: : isDebugMode: true 1542 D DM ==&gt; DmService: : sendSelfRegMsgForDebug: Enter! 1542 D DM ==&gt; DmService: : getSmsAddr: 1065840409 1542 D DM ==&gt; DmService: : getSmsPort: 16998 1542 D DM ==&gt; DmService: : getImei: 863902010015603 1542 D DM ==&gt; DmService: : getSoftwareVersion: Lenovo A288t_S161_120516 1542 D DM ==&gt; DmService: : getManufactory: lenovo 1542 D DM ==&gt; DmService: : getModel: A288t 1542 D DM ==&gt; DmService: : sendMsgBody: Enter! 1542 D DM ==&gt; DmService: : sendMsgBody: IMEI:863902010015603/lenovo/A288t/Lenovo A288t_S161_120516 1542 D DM ==&gt; DmService: : sendMsgBody: dest addr = 1065840409 1542 D DM ==&gt; DmService: : sendMsgBody: dest port = 16998 1383 D lu : SmsMessage --&gt; TP-VPF = 0x10 1383 D lu : SmsMessage --&gt; write into TP-VP:255 1542 D DM ==&gt; DmService: : setIsHaveSendSelfRegMsg: to true 1935 V SmsReceiver: android.intent.action.DATA_SMS_RECEIVED 1935 D SmsReceiver: DATA_SMS_RECEIVED uri:sms://localhost:16998 1935 D SmsReceiver: Not handle DM message 1624 D DM ==&gt; DmReceiver: : onReceive, action is android.intent.action.DATA_SMS_RECEIVED 1624 D DM ==&gt; DmReceiver: : onReceive, DATA_SMS_RECEIVED_ACTION 1624 D DM ==&gt; DmReceiver: : processDataSms: bundle is not null 1624 D DM ==&gt; DmReceiver: : getOriginatingAddress : 1065840409 1624 D DM ==&gt; DmService: : getSmsAddr: 1065840409 1624 D DM ==&gt; DmReceiver: : isDmSmsAddress : return true 1624 D DM ==&gt; DmReceiver: : getMessageBody : IMEI:362523432420944/1 1624 D DM ==&gt; DmService: : getImei: 362523432420944 1624 D DM ==&gt; DmReceiver: : parseReplyMsgContent: msgBody is IMEI:362523432420944/1 1624 D DM ==&gt; DmReceiver: : parseReplyMsgContent: okReply is IMEI:362523432420944/1 1624 D DM ==&gt; DmReceiver: : parseReplyMsgContent: failReply is IMEI:362523432420944/0 1624 D DM ==&gt; DmReceiver: : parseReplyMsgContent: self registe successfully! 1624 D DM ==&gt; DmService: : saveImsi: imsi = 460077101164032 1624 D DM ==&gt; DmService: : setSelfRegState: to true 1624 D DM ==&gt; DmService: : stop listen service state for all phone 1624 D DM ==&gt; DmService: : isDebugMode: true 1624 D DM ==&gt; DmReceiver: : processDataSms: have processed dm reply message<br /><br />
<br /><br />
4. 采集不成功 1. 首先确认自注册是否成功，目前如自注册不成功手机服务器如果强制采集，手机会直接反馈 失败。 2. 确认 imei 是否为我们默认值，如果是请客户更换一个 imei 再试 3. 选择全部采集或者单独采集 none，会显示失败。这个 none 节点是移动要求一定要加入的， 采集失败是正常现象。 4. 采集中子项值为从手机中采集上来的值，默认值为服务器端表格中提交的值，采集结果中这 两项一致就可以通过了。如果不一致，请先确认是手机端值错误还是服务器端错误，如服 务器端有误需重新提交移动修改。 5. 配置不成功<br /><br />
先确认不能配置的项是否为配置表中填写的项，如果未填，表示不支持此项，自然不会进行配置。<br /><br />
<br /><br />
6. 如何修改 DM 默认参数配置<br /><br />
setprop ro.hisense.cmcc.test 0（0 为默认现网参数，1 为实验网）<br /><br />
<br /><br />
96<br /><br />
<br /><br />
第6章 Linux 常用命令速查<br /><br />
6.1 启动、关机、登入、登出相关命令 &lt;login&gt; 登录 &lt;logout&gt; 登出 &lt;exit&gt; 登出 &lt;shutdown&gt; 停止系统 &lt;halt&gt; 停止系统 &lt;reboot&gt; 重启动 &lt;poweroff&gt; 切断电源 &lt;sync&gt; 把内存里的内容写入磁盘 &lt;lilo&gt; 安装 lilo 启动管理程序 &lt;grub&gt; 安装 lilo 启动管理程序<br /><br />
<br /><br />
6.2 shell 相关命令 &lt;chsh&gt; 切换 Shell &lt;history&gt; 显示命令履历 &lt;alias&gt; 设置命令别名 &lt;unalias&gt; 取消命令别名 &lt;which&gt; 显示命令所在位置 &lt;type&gt; 查询命令种类 &lt;echo&gt; 显示字符串或者变量内容 &lt;set&gt; 设置/显示 Shell 变量 &lt;printenv&gt; 显示环境变量 &lt;export&gt; 设置环境变量 &lt;env&gt; 设置临时环境变量 &lt;unset&gt; 释放环境变量 &lt;setenv&gt; 设置环境变量 &lt;unsetenv&gt; 释放环境变量 &lt;source&gt; 执行文件当中的命令 &lt;man&gt; 查询命令手册 &lt;info&gt; 查询超文本命令手册<br /><br />
97<br /><br />
<br /><br />
&lt;whatis&gt; 显示命令简介 &lt;apropos&gt; 通过关键字查询手册 6.3 用户相关命令 &lt;su&gt; 切换到其他用户 &lt;useradd&gt; 追加用户 &lt;adduser&gt; 追加用户 &lt;userdel&gt; 删除用户 &lt;usermod&gt; 修改用户设置 &lt;chfn&gt; 修改用户私人信息 &lt;groupadd&gt; 追加组 &lt;groupdel&gt; 删除<br /></p></html>